---
title: "**ESTIMATING THE AGE AND SEX COMPOSITION OF FAUNAL ASSEMBLAGES WITH BAYESIAN MULTILEVEL MIXTURE MODELS**"
author:
  - "Jesse Wolfhagen^1^"
  - ^1^Department of Anthropology, Purdue University, West Lafayette, Indiana, USA
  - " "
  - "email: jl.wolfhagen@gmail.com"
date:
  - " "
  - " "
  - "*R Markdown version last compiled on `r lubridate::today()`*"
indent: yes
header-includes:
    - \usepackage{setspace}\doublespacing
    - \usepackage[labelfont=bf,width=1\textwidth,justification=raggedright,singlelinecheck=false]{caption}
    - \captionsetup[figure]{labelfont=bf}
    - \usepackage[left]{lineno}
output:
  pdf_document:
    latex_engine: xelatex
    keep_md: false
  word_document: default
  html_document: default
link-citations: yes
bibliography: zooarch_mixmod_library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(kableExtra.auto_format = FALSE)
library("Cairo")
library("cmdstanr")
library("data.table")
library("doParallel")
library("ggdist")
library("ggplot2")
library("ggpubr")
library("ggrepel")
library("kableExtra")
library("knitr")
library("parallel")
library("rnaturalearth")
library("rnaturalearthdata")
library("rstan")
library("sf")
library("zoolog")
#setting resources to do simulations with multicore processing (on Windows)
num_cores <- detectCores(logical = T)
cl <- makeCluster(num_cores - 4) #creating a virtual cluster
registerDoParallel(cl) #registering the cluster
```
\newpage

## ABSTRACT

Understanding the age and sex composition of zooarchaeological assemblages can reveal details about past human hunting and herding strategies as well as past animal biometry and behavior. However, estimates of the sex ratio in an assemblage typically rely on a small subset of element portions, making it difficult to extrapolate these results to the entire assemblage. This paper describes a method to use zooarchaeological remains with standard biometric measurements to estimate the age and sex composition of the assemblage, focused on immature, adult-sized female, and adult-sized male specimens. The model uses a Bayesian framework to avoid the overfitting that plagues optimization-based methods, ensuring that the parameter estimates are biologically meaningful. The accuracy of the model is tested using simulated assemblages from known-age and sex specimens, showing that the model can accurately estimate the parameters and composition of assemblages. This includes the composition of the entire assemblage, not just the measured specimens. Two case studies also show how the model can be applied to archaeological scenarios. The first, focused on sheep from Neolithic Pinarbaşı B, highlight the importance of accounting for immature animals in an assemblage. The second, focused on four assemblages from 7th-6th Millennium BCE northwestern Anatolia, showcase how to compare biometric results from the model and how to use the model’s results to estimate sex-specific fusion rates. This modeling framework provides a new avenue for investigating long-term trajectories in animal biometry alongside contextual analyses of past human choices in butchery and consumption.

**Keywords**: *Zooarchaeology, Biometry, Logarithmic size index (LSI), Domestication, Bayesian statistics*.

\newpage

\linenumbers

## 1. INTRODUCTION

Different hunting and herding strategies target specific classes of animals among a herd that are determined by the animal’s age and sex [@dahl_hjort_1976;@stiner_1990]. In addition to human-driven goals, sex differences in habitat use, diet quality, and reproductive capabilities among ungulate prey species contribute to the susceptibility and desirability of males and females at different ages to human exploitation [@corti_shackleton_2002; @post_etal_2001; @ruckstuhl_neuhaus_2002; @ruckstuhl_2007; @said_etal_2011]. The combination of these factors would thus affect the probability that bones from different classes of animals would become incorporated into a zooarchaeological assemblage, even if taphonomic factors make it impossible to reconstruct death assemblages exactly [@lyman_2008]. The age and sex composition of zooarchaeological assemblages can therefore reflect anthropologically-relevant aspects of past hunting strategies—like seasonal site use and scale of exploitation [@speth_2013]—or general management goals of past herding strategies [e.g., @payne_1973; @redding_1984].

Reconstructing the age and sex composition of a zooarchaeological assemblage can enrich our understanding of past human-animal interactions by complementing mortality profiles and inter-assemblage comparisons. However, this task is complicated by the disaggregated nature of faunal assemblages. Because articulated remains are rare, zooarchaeologists typically cannot relate elements that are morphologically distinct between the sexes (e.g., the pelvis) to other elements that can provide information about the animal’s age-at-death (e.g., limb bones or mandibles). We can, though, take advantage of the general pattern of sexual dimorphism among ungulate taxa to use size differences in limb bones to distinguish between males and females. When combined with size index methods that allow researchers to relate measurements from different elements together, this approach allows general descriptions of the sex ratio in an assemblage that can be used to identify changes in these sex ratios or overall biometry over time [e.g., @grigson_1989;@arbuckle_atici_2013].

Unlike morphological differences, though, much greater overlap exists in the metrics of individual male and female animals, meaning that no clear thresholds can be identified between males and females without maintaining a large area of unidentifiability; this is compounded by the inclusion of immature animals from unfused specimens or from elements that exhibit post-fusion growth [@popkin_etal_2012]. These complications make it difficult to describe the sex composition of an assemblage based solely on absolute metrical identifications of sex since large parts of the assemblage may be left unidentified, decreasing our ability to make reliable inferences about the entire assemblage.

Mixture modeling provides a way out of this dilemma by using probabilistic sex identifications rather than absolute ones. By describing an assemblage of faunal measurements as a mixture of measurements from male and female specimens—with their own parameters for average size ($\mu$) and variability ($\sigma$)—a mixture model allows researchers to not only describe parameters of the overall assemblage but to estimate the probabilities that a specific specimen is male or female [@dong_1997; @monchot_lechelle_2002]. The model can also be described using a “latent state” nomenclature: measured specimens come from female or male specimens, but we cannot directly observe the identity of the specimens. If the specimen’s group identity could be observed directly, the calculation of the mixture components would be trivial; since it cannot be observed, however, one must model probabilities of group membership based on the parameters of each group. The theoretical advantages of mixture modeling—along with the flexibility of the models themselves—explain the increasing popularity of the method in large-scale zooarchaeological analyses focused on biometric change [e.g., @helmer_etal_2005; @arbuckle_etal_2016].

However, the interpretation of mixture models is not necessarily straightforward. First, the very flexibility of mixture modeling means that there is no guarantee that the ‘groups’ identified by the expectation-maximization algorithm are biologically meaningful. There is no straightforward way to penalize results where population parameters ($\mu$ and $\sigma$) are out of line with our understanding of these parameters from known-sex populations. Second, by having more parameters to estimate mixture modeling can exacerbate issues with measurement aggregation and size indices [@wolfhagen_2020]. Fitting mixture models on a small assemblage from a single set of measurements can produce ‘over-fitted’ results that are not biologically meaningful, but combining different sets of measurements together with a size index erases the possibility of allometry between a reference animal and the archaeological material, introducing another potential source of size variation than sexual dimorphism. Finally, probabilistic identifications from mixture modeling still do not resolve the complications of age on body size—the impact of post-fusion growth and the inclusion of unfused specimens. Because these specimens may come from young animals that have not reached adult body size, they are very likely to be confused as female animals by a mixture model that only considers two possible groups. However, it is important to include these specimens in our models because unfused specimens from later-fusing elements can still show sexual dimorphism, meaning we would exclude males from our models by focusing only on fused elements if males are killed at a younger age than females [@zeder_hesse_2000].

This paper describes a Bayesian approach to mixture modeling of faunal measurements that addresses these weaknesses of currently-applied mixture models. The model uses informative priors derived from a reference population of known-age and sex individuals to constrain population parameter estimates to be biologically interpretable [@popkin_etal_2012]. It uses multilevel modeling to take advantage of partial pooling to address aggregation issues and directly estimate parameters for each set of measurements in the analysis [@gelman_2006_hierarchical_modeling; @wolfhagen_2020]. It also includes a third group in the mixture model—this group of “immature” specimens is meant to capture specimens that died before reaching adult body size. The model also emphasizes inference of the entire assemblage rather than just the measured specimens by incorporating observations of the sex ratio (from morphological data) and the proportion of immature specimens (from fusion data) to inform population parameters of the proportions of these different groups. The model is used on sixteen simulated assemblages derived from the @popkin_etal_2012 Shetland sheep population to test its ability to accurately estimate the age and sex composition of assemblages. Two archaeological case studies then show the applicability of the model to archaeological assemblages for reconstructing the age and sex composition of assemblages and to highlight the importance of incorporating immature specimens into mixture modeling analyses.

## 2. A BAYESIAN MULTILEVEL MIXTURE MODEL FOR FAUNAL MEASUREMENTS

The Bayesian model developed for this paper describes assemblages of faunal measurements as a mixture of immature animals, (adult-sized) females, and (adult-sized) males that have distinct sizes. The model uses multiple sets of measurements (e.g., humerus distal breadth "humerus Bd", radius proximal breadth "radius Bp", abbreviations following @vondendriesch_1976), which are first converted into a log-size index, or LSI, values with a natural logarithm base [@meadow_1999; @wolfhagen_2020]. LSI observations from measurement sets are grouped together within a specimen to create individuals grouped into defined “element portions” that serve as the basis for the mixture model analysis (see Table 1 for key term definitions). Element portions relate to categories used for element fusion (e.g., distal humerus) to relate biometry and mortality profiles; specimens that contain multiple element portions—like complete limb bones—are grouped into the later-fusing element portion [compare to "skeletal part type" in @breslawski_2022].

The multilevel structure of the model uses partial pooling to allow the mixture model parameters to vary between element portions while resisting overfitting. These element-specific parameters are related to each other through hyper-parameters, which describe the average value of the model parameters and the variability of model parameters across element portions [@wolfhagen_2020]. Prior distributions of mixture model hyper-parameters that are related to biometric variability in animal populations are derived from the @popkin_etal_2012 Shetland sheep population.

```{r make definitions table, echo = FALSE}
definitions <- data.table(
  Term = c("Element Portion", "Measurement Set", "Measured Assemblage", "Modeled Assemblage", "Full Assemblage"),
  Definition = c('A complete or partial skeletal element defined by the zooarchaeologist, used as the foundation of the multilevel model (e.g., "distal humerus"). Model produces parameter estimates for all defined element portions, so element portions must be non-overlapping. Analogous to "skeletal part type" in Breslawski (2022).',
                 'Specific type of observed measurement (e.g., "humerus distal breadth").',
                 'Assemblage of measured specimens from a defined number of element portions of a specific taxon.',
                 'Assemblage of specimens from a defined number of element portions of a specific taxon. Includes measured and non-measured specimens, though all element portions must have some number of measured specimens. Measurability is assumed to be effectively random (i.e., unrelated to whether the specimen came from an immature, female, or male individual).',
                 'Assemblage of specimens from a defined number of element portions of a specific taxon. Includes element portions that do not have any observed measurements. Measurability is assumed to be effectively random (i.e., unrelated to whether a specimen came from an immature, female, or male individual).')
)

kbl(definitions,
    col.names = c("Term", "Definition"),
    caption = "Definitions of key terms used in this paper",
    booktabs = T, linesep = c('\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position")) %>%
  column_spec(1, border_right = T, width = "12em", bold = T) %>%
  column_spec(2, width = "35em") %>%
  row_spec(0, bold = T)
```

### *2.1 Mixture Model Likelihood*

The central likelihood of the mixture model uses parameters that are specific to each element portion. These parameters include the mixture proportions for the different components of immature animals, females, and males ($\pi_1$, $\pi_2$, $\pi_3$), the average size for each component ($\mu_1$, $\mu_2$, $\mu_3$), and the standard deviation for each component ($\sigma_1$, $\sigma_2$, $\sigma_3$). For each element portion, immature animals are described with the first set of parameters ($\pi_1$, $\mu_1$, $\sigma_1$), adult-sized females with the second set of parameters ($\pi_2$, $\mu_2$, $\sigma_2$), and adult-sized males with the third set of parameters ($\pi_3$, $\mu_3$, $\sigma_3$). This results in both a set of parameters that describe the composition of the assemblage (of measurements from that element portion) and an equation to estimate the probability that a particular specimen comes from an immature, adult female, or adult male individual.

\begin{equation}
\begin{split}
P(x|\pi_1,\pi_2,\pi_3,\mu_1,\mu_2,\mu_3,\sigma_1,\sigma_2,\sigma_3) = \\
& \pi_1 * \operatorname{Normal}(x, \mu_1, \sigma_1) + \\
& \pi_2 * \operatorname{Normal}(x, \mu_2, \sigma_2) + \\
& \pi_3 * \operatorname{Normal}(x, \mu_3, \sigma_3)
\end{split}
\end{equation}

In addition to a specimen’s LSI value, the model needs two additional observed variables to address the potential presence of immature animals in the model. First, an indicator variable ($\operatorname{Immature}[\operatorname{specimen}]$) describes whether the specimen could be from an immature animal based on the body part and the fusion characteristics ($1$ = potentially immature, $0$ = cannot be immature). Data from known-age Shetland sheep show that specimens killed at younger than one year of age are significantly smaller than those killed at older ages, regardless of fusion status [@popkin_etal_2012]. Thus, any measurement from an element with an unfused epiphysis or from an element that does not fuse or could fuse before one year of age is considered potentially immature. Measurements from specimens with fused epiphyses that fuse after one year of age are considered ineligible to be immature so the model does not consider that probability (it considers $\pi_1 = 0$ for fitting that specimen).

Second, the proportion of specimens from an element portion that could be immature ($\operatorname{proportion}_{\operatorname{immature}}$) determines how to re-weight the mixture components ($\pi_1$, $\pi_2$, and $\pi_3$) for potentially-immature specimens from that element portion. The mixture components describe the entire assemblage for an element portion (a combination of potentially-immature and non-immature specimens), meaning that if $\pi_1 = 0.25$ we should expect 25% of the specimens to be from immature animals. If every specimen could be immature-—say, for specimens from an early-fusing element—then the mixture components do not need to be re-weighted. If, however, only half of the specimens could be immature, then the mixture components must be re-weighted to ensure that the whole-assemblage proportions are correct. In such a case, we would expect half of the potentially-immature animals to be from immature animals if $\pi_1 = 0.25$ for the whole assemblage and we know that $\operatorname{proportion}_{\operatorname{immature}} = 0.50$ $\left( \tfrac {0.25}{0.50} = 0.50 \right)$; this same re-weighting would make it less likely that potentially-immature animals are from adult-sized female or adult-sized male animals. The code includes checks to ensure that $\pi_1$ can never exceed $1.00$ after accounting for the proportion of immature specimens in cases where there are very few of such specimens and/or a relatively high expected assemblage-wide proportion of immature animals.

### *2.2 Measurement Error and Observations*

The model estimates measurement error for different observed quantities that are used in the likelihood. Measurements on both the archaeological specimens and the standard values used to calculate LSI values are assumed to have a 1% measurement error [@popkin_etal_2012, Figure 6; @breslawski_byers_2015]. This 1% value comes from an evaluation of the @breslawski_byers_2015 measurement data, where the average standard deviation of repeated measurements on bison radius proximal breadth measurements was 1.1% the average value of the measurement. This means that each measurement is given a standard deviation based on the observed value, which is used to estimate the “modeled” measurement based on the observation we have. These modeled measurements are then used to calculate the LSI value for that measurement ($\operatorname{LSI}_{\operatorname{measurement}}$).

Because specimens can have multiple measurements that are included in the mixture model on them (e.g., a distal humerus with both a Bd and BT observations or a complete radius with Bp and Bd observations), the mixture model uses specimen-specific LSI values ($\operatorname{LSI}_{\operatorname{specimen}}$) that are related to $\operatorname{LSI}_{\operatorname{measurement}}$ values in the same way. $\operatorname{LSI}_{\operatorname{measurement}}$ values are the “observations” with a standard deviation of 0.01 (in $\operatorname{LSI}_e$ scale) based on intra-individual variation of $\operatorname{LSI}_e$ values for the @popkin_etal_2012 sheep using the *Ovis orientalis* female standard animal (FMC 57951) from Uerpmann and Uerpmann [-@uerpmann_uerpmann_1994, Table 12].

*Observation Error Equations:*
\begin{equation}
\begin{split}
\sigma_{\operatorname{measurement}} & = \operatorname{Measurement}_{\operatorname{observed}} * 0.01 \\
\operatorname{Measurement}_{\operatorname{observed}} & \sim \operatorname{Normal}(\operatorname{Measurement}_{\operatorname{modeled}}, \sigma_{\operatorname{measurement}}) \\
\sigma_{\operatorname{reference}} & = \operatorname{Reference}_{\operatorname{observed}} * 0.01 \\
\operatorname{Reference}_{\operatorname{observed}} & \sim \operatorname{Normal}(\operatorname{Reference}_{\operatorname{modeled}}, \sigma_{\operatorname{reference}}) \\
\operatorname{LSI}_{\operatorname{measurement}} & = \log_e(\operatorname{Measurement}_{\operatorname{modeled}}) - \log_e(\operatorname{Reference}_{\operatorname{modeled}}) \\
\operatorname{LSI}_{\operatorname{measurement}} & \sim \operatorname{Normal}(\operatorname{LSI}_{\operatorname{specimen}}, 0.01)
\end{split}
\end{equation}

The model also uses observations of sex ratios and fusion rates to estimate different proportions of the different components in the assemblage. These estimates are not directly used for element portion-specific mixture model parameters but rather inform the hyper-parameters that describe the average value across all element portions. These observations are part of a binomial process centered on the associated hyper-parameters. As such, the measurement error in the observation is based on the total number of observed specimens. The observation of the average proportion of immature specimens ($\mu_{\pi_1}$) is based on the fusion rate of proximal and middle phalanges, which fuse at around the same time as the estimated time that animals reach adult body size in the Shetland sheep population [@popkin_etal_2012]. The observation of the average adult sex ratio—the proportion of females among mature animals $\left( \tfrac {\mu_{\pi_2}}{\mu_{\pi_2} + \mu_{\pi_3}} \right)$—is based on the sex ratio of fused pelvises. In each case, the number of observable specimens (proximal or middle phalanges with observed fusion status, fused pelvises with estimated sexes) determines the measurement error using the binomial distribution. While this paper uses these observations for these hyper-parameters, other observations are possible and can be incorporated into the model in the same fashion.

*Demographic Observation Equations:*
\begin{equation}
\begin{split}
N_{\operatorname{unfused}} & \sim \operatorname{Binomial}(N_{\operatorname{ageable}}, \mu_{\pi_1}) \\
N_{\operatorname{female}} & \sim \operatorname{Binomial}(N_{\operatorname{sexable}}, \dfrac{\mu_{\pi_2}} {\mu_{\pi_2} + \mu_{\pi_3}})
\end{split}
\end{equation}

### *2.3 Prior Distributions*

Prior distributions are central to Bayesian inference and describe one’s prior beliefs in potential values of a model parameter. Prior distributions can be likened to a ‘filter’ from which parameter values are drawn to evaluate their fit with the data [@smith_gelfand_1992]. Several approaches exist for deciding how to describe this prior belief, ranging from ‘objective’ priors that provide equal weight to all possible values of a parameter to distinct distributions defined by a synthesis of previous or related research [@gelman_2006_priors]. Objective priors poorly reflect our intuition about phenomena we are modeling, are inefficient, and can introduce errors into our analyses [@gabry_etal_2019]; instead, ‘weakly informative priors’ or ‘reference priors’ use transformations of parameter values—like centering and scaling element portion-specific parameters—to describe variation in parameter values within reasonable values, with small deviations being more likely than large deviations [@gelman_etal_2008]. Informative priors are derived from relevant knowledge, be it the results of earlier studies on the same subject, the quantification of expert opinion, or parameter values for related subjects [@mccarthy_masters_2005].

The prior distributions in this model are focused on describing previous beliefs about the value of the mixture model hyper-parameters, as the element portion-specific parameters are derived from these distributions. Mixture modeling performs well with unconstrained parameters values because it is more straightforward to estimate variation across element portions, meaning that constrained parameters-—those where the range of possible values depends on the values of other parameters—-must first be transformed into related unconstrained parameters @betancourt_2017]. The following sub-sections describe the necessary transformations for different sets of the mixture model parameters, describing the unconstrained parameters that can be modeled and the transformations that result in the mixture model parameters. While these sections use the mixture model parameter notations, prior distributions are for the ‘central tendency’ hyper-parameter for the described unconstrained parameter.

It is important to remember that for all of these prior distributions are arbitrary choices made by the researcher, regardless of whether the distributions are based on specific animal populations or on reference priors. Other researchers could and should use different prior distributions to best reflect their intuition about likely parameter values for particular case studies. This also highlight the importance of reporting the prior distributions used in a Bayesian analysis to ensure replicability. Examining the implications of different prior distributions is an important step in the development of Bayesian models, one that should be regularly tested even before models are fit to datasets [@gelman_etal_2020_workflow].

#### *2.3.1 Mixture Proportion Priors*\

The three mixture components ($\pi_1$, $\pi_2$, $\pi_3$) are a three-value unit simplex, meaning that the values are constrained as a group to sum up to one. This means that the simplex can be described by only two variables because the third value cannot vary once those two values are known. The model uses two unconstrained variables ($\theta_1$ and $\theta_2$) to describe the unit simplex of $\pi$ values. These $\theta$ values are related back to $\pi$ values using the following ‘stick-breaking’ transformation by iteratively estimating the relative proportions of the simplex taken up by each $\theta$ value [@stan_language_2.29, Section 10.7].

*Stick-Breaking Transformations:*
\begin{equation}
\begin{split}
\pi_1 & = \operatorname{logit}^{-1}(\theta_1 + \log(0.5)) \\
\pi_2 & = (1 - \pi_1) * \operatorname{logit}^{-1}(\theta_2 + \log(1)) \\
\pi_3 & = 1 - (\pi_1 + \pi_2)
\end{split}
\end{equation}

```{r theta_1 prior distributions, eval = TRUE, include = FALSE}
#simulate theta_1 values from respective distributions
theta_1_default <- rnorm(1e4, 0, 2.5)
theta_1_offset <- rnorm(1e4, -0.5, 1.5)

#calculate the associated pi_1 values from the stick-breaking algorithm
pi_1_default <- boot::inv.logit(theta_1_default + log(0.5))
pi_1_offset <- boot::inv.logit(theta_1_offset + log(0.5))

#plot the two pi_1 distributions
pi_1_default_plot <- 
  ggplot(data.frame(pi = pi_1_default)) + aes(x = pi) +
  geom_histogram(binwidth = 0.05) +
  geom_vline(xintercept = 0.5, linetype = "dashed") +
  labs(title = expression(paste("Default, ", theta[1], " Prior, Normal(0, 2.5)")), subtitle = paste0("Percentage Extreme (> 50%): ", round(100 * mean(pi_1_default > 0.5), 0), "%"), x = expression(paste("Proportion Immature, ", pi[1])), y = "Simulated Frequency") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
  
pi_1_offset_plot <-
  ggplot(data.frame(pi = pi_1_offset)) + aes(x = pi) +
  geom_histogram(binwidth = 0.05) +
  geom_vline(xintercept = 0.5, linetype = "dashed") +
  labs(title = expression(paste("Offset, ", theta[1], " Prior, Normal(-0.5, 1.5)")), subtitle = paste0("Percentage Extreme (> 50%): ", round(100 * mean(pi_1_offset > 0.5), 0), "%"), x = expression(paste("Proportion Immature, ", pi[1])), y = "Simulated Frequency") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
#
figure_1 <- ggarrange(pi_1_default_plot, pi_1_offset_plot, nrow = 1, ncol = 2, common.legend = T, legend = "bottom", labels = c("A", "B"))
#
Cairo(width = 8, height = 5, units = "in", file = "./Output/Figures/figure_1.png", type = "png", dpi = 600)
figure_1
dev.off()
```

The distribution of potential $\pi$ values in an assemblage is relatively broad-—there is no reason to think that any combination of the three mixture components cannot occur. There are, however, general expectations about the relative proportion of each group (immature, female, and male) in a zooarchaeological assemblage that we can use to inform prior distributions of $\theta$ values. The $\theta_1$ value can be directly related to the $\pi_1$ value using the first line of the stick-breaking transformation, meaning that one can examine the associated $\pi_1$ estimate for a given $\theta_1$ value (Figure 1). While it is theoretically possible for all bones in an assemblage to be from immature animals, ethnographically-recorded culling strategies and taphonomic factors suggest that it is more likely that immature animals are a smaller component of the assemblage. A ‘standard’ reference prior distribution, $\theta_1 \sim \operatorname{Normal}(0, 2.5)$, only makes it slightly more likely that $\pi_1$ is below 50% than not (`r paste(round(100 * mean(pi_1_default <= 0.5), 0), "%", sep = "")`: Figure 1A), which does not fit our intuition about the proportion of immature animals. Using a slightly off-center Normal distribution with a smaller standard deviation, $\theta_1 \sim \operatorname{Normal}(-0.5, 1.5)$, provides a distribution of potential $\pi_1$ values that better fit the expectation for the proportion of immature animals in an assemblage (`r paste(round(100 * mean(pi_1_offset <= 0.5), 0), "%", sep = "")`: Figure 1B).

```{r figure_1, echo = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Comparison of $\\pi_1$ Distributions from Different $\\theta_1$ Distributions"}
knitr::include_graphics("./Output/Figures/figure_1.png")
```

```{r theta_2 prior distributions, eval = TRUE, include = FALSE}
#simulate theta_1 values from respective distributions
theta_2_default <- rnorm(1e4, 0, 2.5)
theta_2_narrow <- rnorm(1e4, 0, 1.5)

#calculate the associated sex ratio (pi_2 / [pi_2 + pi_3]) values from the stick-breaking algorithm
sex_ratio_default <- boot::inv.logit(theta_2_default + log(1))
sex_ratio_narrow <- boot::inv.logit(theta_2_narrow + log(1))

#plot the two sex ratio distributions
sex_ratio_default_plot <- 
  ggplot(data.frame(sex_ratio = sex_ratio_default)) + aes(x = sex_ratio) +
  geom_histogram(binwidth = 0.05) +
  geom_vline(xintercept = c(0.1, 0.9), linetype = "dashed") +
  labs(title = "Default Prior, Normal(0, 2.5)", subtitle = paste("Percentage Extreme (> 90% or < 10%): ", round(100 * mean(sex_ratio_default < 0.1 | sex_ratio_default > 0.9), 0), "%", sep = ""), x = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), y = "Simulated Frequency") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
  
sex_ratio_narrow_plot <-
  ggplot(data.frame(sex_ratio = sex_ratio_narrow)) + aes(x = sex_ratio) +
  geom_histogram(binwidth = 0.05) +
  geom_vline(xintercept = c(0.1, 0.9), linetype = "dashed") +
  labs(title = "Narrow Prior, Normal(0, 1.5)", subtitle = paste("Percentage Extreme (> 90% or < 10%): ", round(100 * mean(sex_ratio_narrow < 0.1 | sex_ratio_narrow > 0.9), 0), "%", sep = ""), x = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), y = "Simulated Frequency") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
#
figure_2 <- ggarrange(sex_ratio_default_plot, sex_ratio_narrow_plot, nrow = 1, ncol = 2, common.legend = T, legend = "bottom", labels = c("A", "B"))
#
Cairo(width = 8, height = 5, units = "in", file = "./Output/Figures/figure_2.png", type = "png", dpi = 600)
figure_2
dev.off()
```

Within the stick-breaking transformation, $\theta_2$ relates to the relative proportions of $\pi_2$ and $\pi_3$ after $\pi_1$ has been estimated, which is effectively the adult sex ratio. Just as we could examine the expected $\pi_1$ estimates from a distribution of $\theta_1$ values, we can thus use expected adult sex ratios $(\tfrac{\pi_2}{\pi_2 + \pi_3})$ estimates from a particular prior distribution for $\theta_2$ (Figure 2). In this case, we have no reason to, *a priori*, believe that the adult sex ratio skews towards males or females, though we may believe that extremely imbalanced sex ratios, however defined, are not likely. Again, a standard reference prior definition, $\theta_2 \sim \operatorname{Normal}(0, 2.5)$, produces estimates that may not fit our expectation—-in this case, extreme sex ratios (< 10% or > 90% female) are only about half as likely as sex ratios within those bounds (`r paste(round(100 * mean(sex_ratio_default < 0.1 | sex_ratio_default > 0.9), 0), "%", sep = "")`: Figure 2A). Decreasing the standard deviation, $\theta_2 \sim \operatorname{Normal}(0, 1.5)$, makes these extreme sex ratios about half as likely (`r paste(round(100 * mean(sex_ratio_narrow < 0.1 | sex_ratio_narrow > 0.9), 0), "%", sep = "")`: Figure 2B).

```{r figure_2, echo = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Comparison of Adult Sex Ratios $\\frac{\\pi_2}{\\pi_2 + \\pi_3}$ Distributions from Different $\\theta_2$ Distributions"}
knitr::include_graphics("./Output/Figures/figure_2.png")
```

*Prior Distribution Definitions for $\theta$ Hyper-parameters:*
\begin{equation}
\begin{split}
\theta_1 & \sim \operatorname{Normal}(-0.5, 1.5) \\
\theta_2 & \sim \operatorname{Normal}(0.0, 1.5)
\end{split}
\end{equation}

#### *2.3.2 Average Body Size Priors*\

While the average body sizes of the different components ($\mu_1$, $\mu_2$, $\mu_3$) are not intrinsically linked in the same way that $\pi$ values are, the model still requires some structure to aid interpretability. Bayesian mixture models that are fit using Markov Chain Monte Carlo (MCMC) methods, like the model in this paper, can suffer from an issue called “label switching” if $\mu$ values are not related to one another [@jasra_etal_2005]. This describes situations where some iterations of the model switch what specimens it effectively measures—that is, an instance where $\mu_1$ centers on female animals while $\mu_2$ centers on immature animals. To avoid label switching, the average body sizes are strictly ordered, meaning that $\mu_1 < \mu_2 < \mu_3$ must be maintained. Note that this only affects average values, individual immature specimens can still be larger than female specimens or male specimens and individual female specimens can be larger than male specimens. This is done by only estimating $\mu_2$ (average $\operatorname{LSI}_e$ value for females) directly while estimating the average $\operatorname{LSI}_e$ value for immature and male animals with offsets ($\delta_1$, $\delta_2$). The $\delta$ values must be positive to maintain the ordering of the $\mu$ values, so each $\delta$ is modeled in a log-transformed space.

*Offset Equations for $\mu$ Values*
\begin{equation}
\begin{split}
\mu_1 & = \mu_2 - \delta_1 \\
\mu_3 & = \mu_2 + \delta_2
\end{split}
\end{equation}

Conceptually, this expression of animal body size defines female animals as the generic “body size” that is subject to various selective pressures, with the offset for male animals reflecting sex-specific pressures on males. This interpretation of body size broadly fits the general pressures affecting adult body size in females and males across many ungulate taxa, including domestic herd animals [@tchernov_horwitz_1991; @perezbarberia_etal_2002]. The body size offset between immature animals and adult-sized females ($\delta_1$) is admittedly an *ad hoc* definition rather than one under strict biological constraints, as it can be affected by the age immature animals reach before being killed [@gillis_etal_2014]. The computational advantages of this definition arguably outweigh the awkwardness of the definition, however. Further, evaluation of $\delta_1$ and $\delta_2$ values across different sites could conceivably highlight variation in the timing of the killing of immature animals ($\delta_1$) and the degree of adult sexual dimorphism ($\delta_2$); both variables can be related to models of hunting intensity, animal domestication, and herd management [@gillis_etal_2014; @zeder_hesse_2000; @marom_baroz_2013].

```{r known specimen modeling, eval = TRUE, include = FALSE}
####SET SEED: REMOVE TO GENERALIZE####
set.seed(1234567890)
#Import data
sheep_data <- fread("./Data/1-s2.0-S0305440312000301-mmc1.csv", nrows = 356) #accessible from https://doi.org/10.1016/j.jas.2012.01.018 supplementary table, resaved as a .CSV

#Make variable for immature animals (`Days at Death` <= 365), female animals (not-immature), and male/castrated animals (not-immature)
sheep_data[, Immature := ifelse(`Days at Death` <= 365, 1, 0)]
sheep_data[, Female := ifelse(`Days at Death` > 365 & Sex %in% "Female", 1, 0)]
sheep_data[, Male := ifelse(`Days at Death` > 365 & Sex %in% c("Castrate", "Male"), 1, 0)]

#Reframe the sheep data to be set in a long format
sheep_longdata <- melt(sheep_data, id.vars = c("Accession  no", "Sex", "Immature", "Female", "Male", "Sca_coracoid_fus", "Hum_prox_fus", "Hum_dist_fus", "Rad_prox_fus", "Rad_dist_fus", "Mtc_dist_fus", "Pel_acetabulum_fus", "Fem_caput_fus", "Fem_dist_fus", "Tib_prox_fus", "Tib_dist_fus", "Mtt_dist_fus", "Cal_prox_fus"), measure.vars = names(sheep_data[, Sca_GLP:Cal_GDde]), variable.name = "Measurement", value.name = "Measurement_value")
sheep_longdata[, Element := tstrsplit(Measurement, "_")[1]]

#Get the standard animal from zoolog
sheep_standard_animal <- data.table(referencesDatabase$`Ovis orientalis`$Uerpmann)

#Keep only limb breadth bone measurements for the mixture model
sheep_mixmod_data <- sheep_longdata[Measurement %in% c("Sca_GLP", "Hum_Bd", "Hum_BT", "Rad_Bp", "Rad_Bd", "Mtc_Bp", "Mtc_BFd", "Fem_Bd", "Tib_Bd", "Ast_Bd", "Mtt_Bp", "Mtt_BFd")]

#Rename standard animal measurements to match the names in the dataset
sheep_standard_animal[EL %in% "Scapula", c("Element", "Measurement") := .("Sca", paste("Sca", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Humerus", c("Element", "Measurement") := .("Hum", paste("Hum", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Radius", c("Element", "Measurement") := .("Rad", paste("Rad", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metacarpus", c("Element", "Measurement") := .("Mtc", paste("Mtc", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Femur", c("Element", "Measurement") := .("Fem", paste("Fem", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Tibia", c("Element", "Measurement") := .("Tib", paste("Tib", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Astragalus", c("Element", "Measurement") := .("Ast", paste("Ast", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metatarsus", c("Element", "Measurement") := .("Mtt", paste("Mtt", Measure, sep = "_"))]

#Rename some measurement name mismatches
sheep_mixmod_data[Measurement %in% "Mtc_BFd", Measurement := "Mtc_Bd"]
sheep_mixmod_data[Measurement %in% "Mtt_BFd", Measurement := "Mtt_Bd"]

#Join the standard animal reference to the dataset (allows for easier identification of relevant standard measurement)
sheep_mixmod_data <- sheep_mixmod_data[sheep_standard_animal[, .(Measurement, Reference_value = Standard)], on = "Measurement"][!is.na(`Accession  no`)]

#Create "element portion" and "measurement set" numbers for the model (needs numeric labels)
#note that, by default, these are ordered alphabetically. Can also assign specific orders if desirable
sheep_mixmod_data[, c("Measurement_Set", "Element_Portion") := .(as.numeric(as.factor(Measurement)), as.numeric(as.factor(Element)))]

#Create "specimen" labels to link meausrements from the same bone specimen (model needs numeric labels)
sheep_mixmod_data[, "Specimen_No" := as.numeric(as.factor(paste(`Accession  no`, Element, sep = "_")))]
sheep_mixmod_data[, "Individual_No" := as.numeric(as.factor(`Accession  no`))]

#Calculate measurement error for observed measurements and reference data (2%, based on Breslawksi and Byers 2015)
sheep_mixmod_data[, c("Measurement_sd", "Reference_sd") := .((Measurement_value * 0.01), (Reference_value * 0.01))]

#Summarize the Popkin, et al. (2012) sheep data
popkin_sheep_summary <- list(
  total_individual_n = sheep_mixmod_data[, .N, .(Individual_No)][, .N],
  immature_individual_n = sheep_mixmod_data[, .N, .(Individual_No, Immature, Female, Male)][, sum(Immature)],
  female_individual_n = sheep_mixmod_data[, .N, .(Individual_No, Immature, Female, Male)][, sum(Female)],
  male_individual_n = sheep_mixmod_data[, .N, .(Individual_No, Immature, Female, Male)][, sum(Male)],
  total_specimen_n = sheep_mixmod_data[, .N, .(Specimen_No)][, .N],
  immature_age_range = sheep_data[Immature %in% 1, max(`Days at Death`) - min(`Days at Death`)]
)

#Subsampling the measurements for measurement error since this may be causing an issue
subsample_n <- 150
mixmod_data_msrmnt_error <- rbind(
  sheep_mixmod_data[Specimen_No %in% sheep_mixmod_data[Immature %in% 1, .N, Specimen_No][, sample(Specimen_No, subsample_n, replace = F)]],
  sheep_mixmod_data[Specimen_No %in% sheep_mixmod_data[Female %in% 1, .N, Specimen_No][, sample(Specimen_No, subsample_n, replace = F)]],
  sheep_mixmod_data[Specimen_No %in% sheep_mixmod_data[Male %in% 1, .N, Specimen_No][, sample(Specimen_No, subsample_n, replace = F)]]
)
mixmod_data_msrmnt_error[, Measurement_Set := as.numeric(as.factor(Measurement_Set))]
mixmod_data_msrmnt_error[, Element_Portion := as.numeric(as.factor(Element_Portion))]
mixmod_data_msrmnt_error[, Specimen_No := as.numeric(as.factor(Specimen_No))]
```

```{r run known-specimen model, include = FALSE, eval = TRUE}
#Set up the data for Stan modeling
shetland_sheep_mixmod_standata_msrmnt_error <- list(
  N_Specimens = mixmod_data_msrmnt_error[, .N, Specimen_No][, .N],
  N_Measurements = mixmod_data_msrmnt_error[, .N],
  N_Element_Portions = mixmod_data_msrmnt_error[, .N, Element_Portion][, .N],
  N_Measurement_Sets = mixmod_data_msrmnt_error[, .N, Measurement_Set][, .N],
  Element_Portion = mixmod_data_msrmnt_error[, .N, .(Element_Portion, Specimen_No)][order(Specimen_No), Element_Portion],
  Group = mixmod_data_msrmnt_error[, .N, .(Specimen_No, Group = ifelse(Immature %in% 1, 1, ifelse(Female %in% 1, 2, 3)))][order(Specimen_No), Group],
  Immature = mixmod_data_msrmnt_error[, .N, .(Immature, Female, Male, Specimen_No)][order(Specimen_No), Immature],
  Female = mixmod_data_msrmnt_error[, .N, .(Immature, Female, Male, Specimen_No)][order(Specimen_No), Female],
  Male = mixmod_data_msrmnt_error[, .N, .(Immature, Female, Male, Specimen_No)][order(Specimen_No), Male],
  Measurement_obs = mixmod_data_msrmnt_error[, Measurement_value],
  Measurement_sd = mixmod_data_msrmnt_error[, Measurement_sd],
  Reference_obs = mixmod_data_msrmnt_error[, .N, .(Reference_value, Reference_sd, Measurement_Set)][order(Measurement_Set), Reference_value],
  Reference_sd = mixmod_data_msrmnt_error[, .N, .(Reference_value, Reference_sd, Measurement_Set)][order(Measurement_Set), Reference_sd],
  Measurement_Set = mixmod_data_msrmnt_error[, Measurement_Set],
  Specimen = mixmod_data_msrmnt_error[, Specimen_No]
)

#Run the Stan model
reference_pop_msrmnt_error_LSI_model <- cmdstan_model("./Scripts/LSI_known_specimens.stan")
shetland_sheep_samples <- reference_pop_msrmnt_error_LSI_model$sample(
  data = shetland_sheep_mixmod_standata_msrmnt_error,
  chains = 4,
  parallel_chains = 4,
  refresh = 250,
  adapt_delta = 0.80,
  seed = 122839029, #remove this line to generalize/if changing the random seed for the dataset
  max_treedepth = 15
)

#Save the posterior results
shetland_sheep_stanfit <- rstan::read_stan_csv(shetland_sheep_samples$output_files())
shetland_sheep_post <- extract(shetland_sheep_stanfit)
```

Prior distributions for these size-related parameters ($\mu_2$, $\delta_1$, $\delta_2$) are based on $\operatorname{LSI}_e$ data from `r popkin_sheep_summary$total_individual_n` known-age and known-sex Shetland sheep described in @popkin_etal_2012. Castrated individuals were included as males and animals killed under one year of age were considered “immature” specimens, leaving `r popkin_sheep_summary$immature_individual_n` immature animals, `r popkin_sheep_summary$female_individual_n` female animals, and `r popkin_sheep_summary$male_individual_n` male animals. $\operatorname{LSI}_e$ values are calculated using the *Ovis orientalis* female standard animal (FMC 57951) from Uerpmann and Uerpmann [-@uerpmann_uerpmann_1994: Table 12]. Table 2 shows the measurements included in the $\operatorname{LSI}_e$ simulation analyses. From the `r popkin_sheep_summary$total_specimen_n` element portions from this population, `r subsample_n` immature, female, and male element portions were randomly drawn to create an assemblage of `r shetland_sheep_mixmod_standata_msrmnt_error$N_Specimens` element portions. A Bayesian multilevel mixture model was fit to these known-identity specimens to create estimates of the relevant biologically-constrained hyper-parameters ($\mu_2$, $\delta_1$, $\delta_2$, $\sigma_1$, $\sigma_2$, $\sigma_3$). The results of this analysis are then used as the foundation for prior distributions of the relevant hyper-parameters in the archaeological model where group identities are unknown.

```{r table_2: measurements in the LSI analyses, echo = FALSE}
simulation_measurements <- sheep_standard_animal[Measurement %in% sheep_mixmod_data[, .N, Measurement][, Measurement], .(Element = EL, Measurement = Measure)]
#
kbl(simulation_measurements,
    caption = "Measurements included in the Simulation Analyses",
    booktabs = T, linesep = c('\\addlinespace', '', '\\addlinespace', '', '\\addlinespace', '', '\\addlinespace', '\\addlinespace', '\\addlinespace', '\\addlinespace', '', '')) %>%
  kable_styling(latex_options = "HOLD_position") %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, bold = T)
```

The prior distributions used in this Bayesian multilevel mixture model on the reference population are more straightforward. While the same transformations to create unconstrained parameters are necessary (e.g., modeling average size as $\mu_2$ with offsets for immature and male animals), the definition of these prior distributions can be broadly described as weakly-informative priors [@gelman_etal_2008]. These weakly-informative prior distributions are reasonable in this case—and not in the archaeological case—because all the mixture model parameters have direct observations rather than relying on latent state estimations. That is, parameters like the size difference between males and females ($\delta_2$) and the size variability in female animals ($\sigma_2$) can be directly observed because the group identities of every specimen are known. With these direct observations, the prior distributions have a more muted influence on the resulting posterior distributions. This does not mean that the prior distributions have no effect, however, which is why objective priors can have undesirable impacts on modeling results [@gabry_etal_2019].

```{r known-specimen posterior analysis, eval = TRUE, include = FALSE}
#posterior summaries of the distribution
posterior_results <- list(
  mu2_mean = mean(shetland_sheep_post$grand_mu_female),
  mu2_sd = sd(shetland_sheep_post$grand_mu_female),
  logdelta1_mean = mean(shetland_sheep_post$grand_logdelta_immature),
  logdelta1_sd = sd(shetland_sheep_post$grand_logdelta_immature),
  logdelta2_mean = mean(shetland_sheep_post$grand_logdelta_male),
  logdelta2_sd = sd(shetland_sheep_post$grand_logdelta_male),
  logsigma1_mean = mean(shetland_sheep_post$grand_logsigma_immature),
  logsigma1_sd = sd(shetland_sheep_post$grand_logsigma_immature),
  logsigma2_mean = mean(shetland_sheep_post$grand_logsigma_female),
  logsigma2_sd = sd(shetland_sheep_post$grand_logsigma_female),
  logsigma3_mean = mean(shetland_sheep_post$grand_logsigma_male),
  logsigma3_sd = sd(shetland_sheep_post$grand_logsigma_male)
)

#make 10,000 samples from the posterior distributions (normal approximations)
mu2_fit_samples <- rnorm(1e4, posterior_results$mu2_mean, posterior_results$mu2_sd)
mu2_prior_samples <- rnorm(1e4, 0, 0.1)
mu2_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(mu2_fit_samples, mu2_prior_samples))
logdelta1_fit_samples <- rnorm(1e4, posterior_results$logdelta1_mean, posterior_results$logdelta1_sd)
logdelta1_prior_samples <- rnorm(1e4, -3.5, 0.4)
logdelta1_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(logdelta1_fit_samples, logdelta1_prior_samples))
logdelta2_fit_samples <- rnorm(1e4, posterior_results$logdelta2_mean, posterior_results$logdelta2_sd)
logdelta2_prior_samples <- rnorm(1e4, -2.7, 0.2)
logdelta2_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(logdelta2_fit_samples, logdelta2_prior_samples))
#
logsigma1_fit_samples <- rnorm(1e4, posterior_results$logsigma1_mean, posterior_results$logsigma1_sd)
logsigma1_prior_samples <- rnorm(1e4, -3.05, 0.1)
logsigma1_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(logsigma1_fit_samples, logsigma1_prior_samples))
logsigma2_fit_samples <- rnorm(1e4, posterior_results$logsigma2_mean, posterior_results$logsigma2_sd)
logsigma2_prior_samples <- rnorm(1e4, -3.1, 0.1)
logsigma2_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(logsigma2_fit_samples, logsigma2_prior_samples))
logsigma3_fit_samples <- rnorm(1e4, posterior_results$logsigma3_mean, posterior_results$logsigma3_sd)
logsigma3_prior_samples <- rnorm(1e4, -3.1, 0.1)
logsigma3_data <- data.table(quantity = rep(c("Shetland Sheep Sample", "Proposed Prior"), each = 1e4), value = c(logsigma3_fit_samples, logsigma3_prior_samples))
```

```{r make figure 3, include = FALSE, eval = TRUE}
#Put the figure together: sample fit (white/clear) and proposed prior (black)
mu2_plot <-
  ggplot(mu2_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$mu2_mean, 2), ",", round(posterior_results$mu2_sd, 2), ")"), x = min(mu2_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", 0, ",", 0.1, ")"), x = min(mu2_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Average Female LSI, ", mu[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
delta1_log_plot <-
  ggplot(logdelta1_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$logdelta1_mean, 1), ",", round(posterior_results$logdelta1_sd, 1), ")"), x = min(logdelta1_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", -3.5, ",", 0.4, ")"), x = min(logdelta1_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Immature Size Penalty (Log-Transformed), ", log(delta[1]))), x = "Parameter Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

delta1_lsi_plot <-
  ggplot(logdelta1_data) + aes(x = exp(value), y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Immature Size Penalty (LSI), ", delta[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
delta2_log_plot <-
  ggplot(logdelta2_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$logdelta2_mean, 1), ",", round(posterior_results$logdelta2_sd, 1), ")"), x = min(logdelta2_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", -2.7, ",", 0.2, ")"), x = min(logdelta2_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism (Log-Transformed), ", log(delta[2]))), x = "Parameter Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

delta2_lsi_plot <-
  ggplot(logdelta2_data) + aes(x = exp(value), y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism (LSI), ", delta[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
sigma1_log_plot <-
  ggplot(logsigma1_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$logsigma1_mean, 2), ",", round(posterior_results$logsigma1_sd, 2), ")"), x = min(logsigma1_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", -3.05, ",", 0.1, ")"), x = min(logsigma1_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Immature Variability (Log-Transformed), ", log(sigma[1]))), x = "Parameter Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

sigma1_lsi_plot <-
  ggplot(logsigma1_data) + aes(x = exp(value), y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Immature Variability (LSI), ", sigma[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
sigma2_log_plot <-
  ggplot(logsigma2_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$logsigma2_mean, 2), ",", round(posterior_results$logsigma2_sd, 2), ")"), x = min(logsigma2_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", -3.1, ",", 0.1, ")"), x = min(logsigma2_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Female Variability (Log-Transformed), ", log(sigma[2]))), x = "Parameter Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

sigma2_lsi_plot <-
  ggplot(logsigma2_data) + aes(x = exp(value), y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Female Variability (LSI), ", sigma[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
sigma3_log_plot <-
  ggplot(logsigma3_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  annotate(geom = "text", label = paste0("Normal(", round(posterior_results$logsigma3_mean, 2), ",", round(posterior_results$logsigma3_sd, 2), ")"), x = min(logsigma3_data$value), y = 1.5, hjust = 0, size = 3) +
  annotate(geom = "text", label = paste0("Normal(", -3.1, ",", 0.1, ")"), x = min(logsigma3_data$value), y = 2.5, hjust = 0, color = "red", size = 3) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Male Variability (Log-Transformed), ", log(sigma[3]))), x = "Parameter Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

sigma3_lsi_plot <-
  ggplot(logsigma3_data) + aes(x = exp(value), y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Shetland Sheep Sample", "Proposed Prior")) +
  labs(subtitle = expression(paste("Male Variability (LSI), ", sigma[3])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())

#putting the figure together
#the transformed variables (everything but mu_2 go side-by-side to show the original (log-transformed) and LSI scales)
figure_3 <- ggarrange(
  mu2_plot,
  ggarrange(delta1_log_plot, delta1_lsi_plot, nrow = 1, ncol = 2, legend = "none"),
  ggarrange(delta2_log_plot, delta2_lsi_plot, nrow = 1, ncol = 2, legend = "none"),
  ggarrange(sigma1_log_plot, sigma1_lsi_plot, nrow = 1, ncol = 2, legend = "none"),
  ggarrange(sigma2_log_plot, sigma2_lsi_plot, nrow = 1, ncol = 2, legend = "none"),
  ggarrange(sigma3_log_plot, sigma3_lsi_plot, nrow = 1, ncol = 2, legend = "none"),
  ncol = 1, nrow = 6,
  common.legend = T, legend = "bottom",
  labels = c("A", "B", "C", "D", "E", "F"), hjust = 0.015
)
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_3.png", type = "png", dpi = 600)
figure_3
dev.off()
```

```{r figure_3, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Model Hyper-parameters from Sample of Known-Identity Specimens and Proposed Prior Distributions for Archaeological Mixture Model Applications"}
knitr::include_graphics("./Output/Figures/figure_3.png")
```

Figure 3 shows the posterior distributions of the model hyper-parameters for both average body size ($\mu_2$, $\delta_1$, $\delta_2$) and size variability ($\sigma_1$, $\sigma_2$, $\sigma_3$) based on the Shetland sheep sample. These distributions are associated with proposed prior distribution definitions for the same hyper-parameters for archaeological applications of the model when identity is unknown. Note that these hyper-parameters describe averaged estimates across element portions in the model. In general, the posterior distributions from the sample of known-identity Shetland sheep are narrower than the associated prior distribution proposals. This narrowness is due in part to the large sample size of the sampled assemblage but also to the fact that every element portion is represented by the same individuals, something that is extremely unlikely in archaeological scenarios. Thus, care should be taken before directly translating these results into prior distributions for an archaeological scenario.

The average $\operatorname{LSI}_e$ value for females ($\mu_2$) is likely to vary across contexts in reaction to different selective pressures, both anthropogenic and ecological [e.g., @davis_1981; @manning_etal_2015; @wright_vinerdaniels_2015]. While the posterior distribution is extremely focused on this specific population, there is no reason to think that this value should be centered at any particular value since that relates to the standard animal used [@meadow_1999; @wolfhagen_2020]. Therefore, the prior distribution used in archaeological models for $\mu_2$ uses a larger standard deviation, $\mu_2 \sim \operatorname{Normal}(0, 0.1)$, to encompass likely $\operatorname{LSI}_e$ values (Figure 3A). Under this definition, there is a 95% probability that the $\mu_2$ value lies within the range of `r format(round(qnorm(0.025, 0, 0.1), 2), nsmall = 2)` and `r format(round(qnorm(0.975, 0, 0.1), 2), nsmall = 2)` on the $\operatorname{LSI}_e$ scale, which translates to roughly `r paste0(round(100 * exp(qnorm(0.025, 0, 0.1)), 0), "-", round(100 * (exp(qnorm(0.975, 0, 0.1))), 0), "%")` the size of the standard animal’s measurement.

For the average size difference between immature and female animals ($\delta_1$), the narrowness of the posterior distribution likely reflects the fact that immature animals in the sample cover a narrow age range. Animals killed under one year of age span only `r popkin_sheep_summary$immature_age_range` days and the youngest animals are nearly half a year old [178-214 days: @popkin_etal_2012]. Thus while the posterior results provide a useful starting point for estimating this offset, there is a good potential for larger $\delta_1$ values (i.e., greater size differences between immature and adult-sized female animals) in other contexts that could include animals killed at a younger age (Figure 3B). To capture this possibility, the archaeological model uses a prior distribution with a larger standard deviation and a slightly higher center, $\log \delta_1 \sim \operatorname{Normal}(-3.5, 0.4)$, which results in an average size difference of `r round(exp(-3.5), 2)` on the $\operatorname{LSI}_e$ scale and a 95% probability that the size difference is between `r round(exp(qnorm(0.025, -3.5, 0.4)), 2)` and `r round(exp(qnorm(0.975, -3.5, 0.4)), 2)`. This translates into expecting the average body size of immature animals in an assemblage being `r paste0(round(100 * (exp(exp(-3.5)) - 1), 0), "%")` smaller than the average body size of adult-sized female animals, but also plausibly believing that this size difference could range from `r paste0(round(100 * (exp(exp(qnorm(0.025, -3.5, 0.4))) - 1), 0), "-", round(100 * (exp(exp(qnorm(0.975, -3.5, 0.4))) - 1), 0), "%")` smaller.

The average size difference between adult males and females ($\delta_2$), also known as the index of sexual dimorphism [@fernandez_monchot_2007], is likely to be under stricter biological control than the other “average body size” parameters in the model. This does not mean that this difference could not vary between contexts, however. Some models of animal domestication argue that initial domestication removed sexual selective pressures on male body size, reducing sexual dimorphism [e.g., @tchernov_horwitz_1991]. In a similar fashion, specialized hunting strategies could also reduce sexual dimorphism by targeting large-bodied males, for example [@zeder_2012; @proaktor_etal_2007; @milner_etal_2007]. Again, the posterior distribution of the extent of sexual dimorphism in the Shetland sheep population provides a useful starting point to describe a prior distribution for the model (Figure 3C). Increasing the standard deviation of the distribution slightly, $\log \delta_2 \sim \operatorname{Normal}(-2.7, 0.1)$, produces a distribution centered at `r round(exp(-2.7), 2)` $\operatorname{LSI}_e$ units with a 95% probability that the value is between `r paste0(round(exp(qnorm(0.025, -2.7, 0.1)), 2), "-", round(exp(qnorm(0.975, -2.7, 0.1)), 2))`, translating to the average male being `r paste0(round(100 * (exp(exp(qnorm(0.025, -2.7, 0.1))) - 1), 0), "-", round(100 * (exp(exp(qnorm(0.975, -2.7, 0.1))) - 1), 0), "%")` larger than the average female relative to a standard measurement. The smaller standard deviation in the prior distribution of $\delta_2$ than for $\delta_1$ reflects our understanding that the extent of sexual dimorphism, as a biological phenomenon, is less likely to have extreme values than the average size difference between immature and female animals, since $\delta_2$ is unaffected by the specific age structure of the assemblage.

*Prior Distribution Definitions for $\mu$ and $\delta$ Hyper-parameters:*
\begin{equation}
\begin{split}
\mu_2 & \sim \operatorname{Normal}(0, 0.1) \\
\log \delta_1 & \sim \operatorname{Normal}(-3.50, 0.4) \\
\log \delta_2 & \sim \operatorname{Normal}(-2.70, 0.1)
\end{split}
\end{equation}

#### *2.3.3 Size Variability Priors*\

The $\operatorname{LSI}_e$ size variability of animals within a group ($\sigma_1$, $\sigma_2$, $\sigma_3$) is a key variable in the Bayesian mixture model. The values of these standard deviation parameters play a major role in ensuring that the mixture components reflect biological entities rather than overfitting to specific sample noise. Previous research into size variability suggests that these $\sigma$ values should be relatively stable across elements. Coefficients of variance (CVs) for raw mammal bone measurements from a single sex have been found to be relatively consistent [@davis_1996; @popkin_etal_2012]. When transforming these measurements using a logarithm, this produces consistent standard deviations of the transformed measurement values [@wolfhagen_2020: Figure 1].

While $\sigma$ parameters from different groups within the model are not directly related to each other, the values still need some transformations to be modeled consistently by the multilevel model. These values must be positive, which conflicts with the multilevel model’s need for unconstrained variables. To achieve this, the model uses the same log-transformation technique used for size offsets to create an unconstrained parameter, $\log \sigma$, that is then transformed to actual $\sigma$ values after estimating variation across element portions.

As in the average body size parameters, prior distributions for the size variability model parameters are developed from the Bayesian model of known-identity Shetland sheep measurements. The resulting $\sigma$ hyper-parameters provide a baseline for establishing hyper-parameter prior distributions in archaeological cases. Figure 3D-F shows the posterior distributions of these $\sigma$ hyper-parameters in both the log-transformed values and associated $\operatorname{LSI}_e$ values. Average size variability within an element portion for immature animals ($\sigma_1$) is higher, on average, than for females ($\sigma_2$) and males ($\sigma_3$). The immature category includes both male and female animals, so larger size variability makes sense; again, it is possible that $\sigma_1$ is relatively low in this population relative to other contexts given the narrow age range of immature animals in the Shetland sheep population. Unlike the average body size parameters, there are not compelling reasons to believe that size variability parameters for females and males ($\sigma_2$ and $\sigma_3$) should vary widely in different contexts given the consistency of coefficients of variation in mammals broadly [@davis_1996]. Thus, the results of this analysis are used for the prior distributions of $\log \sigma_2$ and $\log \sigma_3$, while the prior distribution of $\log \sigma_1$ is given an increased standard deviation and slightly increased average value. Overall, however, these prior distributions suggest that the average size variability within an element portion is between `r paste0(round(exp(qnorm(0.025, -3.05, 0.1)), 2), "-", round(exp(qnorm(0.975, -3.05, 0.1)), 2))` for females and males and is between `r paste0(round(exp(qnorm(0.025, -3.1, 0.1)), 2), "-", round(exp(qnorm(0.975, -3.1, 0.1)), 2))` for immature animals. Note that even though $\sigma_2$ and $\sigma_3$ have the same prior distributions, these values can still vary from each other in different contexts.

*Prior Distribution Definitions for $\sigma$ Hyper-parameters:*
\begin{equation}
\begin{split}
\log \sigma_1 & \sim \operatorname{Normal}(-3.05, 0.1) \\
\log \sigma_2 & \sim \operatorname{Normal}(-3.10, 0.1) \\
\log \sigma_3 & \sim \operatorname{Normal}(-3.10, 0.1)
\end{split}
\end{equation}

### *2.4 Multilevel Structure for Element Portions*

The previous section described prior distributions that describe the *average* value for different mixture model parameters across all element portions. To create parameter estimates that are specific to different element portions, it is necessary to estimate the *variation* around these average values that different parameters can have among different element portions. The model uses a Multivariate Normal definition of the model parameters to allow for correlations between different parameters; effectively, the possibility that multiple model parameters will covary from element portion to element portion. To do this, each hyper-parameter has an associated $\sigma_{\operatorname{element}}$ parameter that describes inter-element variation in parameter values. The model uses a non-centered parameterization, wherein the Multivariate Normal distribution is centered at zero to calculate offsets, $\nu_{\operatorname{element}}$, that are added to the average hyper-parameters to calculate model parameters for each element portion. This definition provides computational stability and makes it more straightforward to incorporate other levels of multilevel structure (see Section 2.5).

*Equations for Defining Inter-Element Variation (Multilevel Modeling):*
\begin{equation}
\begin{split}
\nu_{\operatorname{element}} & \sim \operatorname{MultivariateNormal} \left(\begin{bmatrix} 0 \\ \vdots \\ 0 \\ \end{bmatrix}, \Sigma_{\operatorname{element}}\right) \\
\Sigma_{\operatorname{element}} & =
\begin{pmatrix}
\sigma_{\operatorname{element}}[1] & \dots & 0 \\
\vdots & \ddots & \vdots \\
0 & \dots & \sigma_{\operatorname{element}}[8] \\
\end{pmatrix}
\rho_{\operatorname{element}}
\begin{pmatrix}
\sigma_{\operatorname{element}}[1] & \dots & 0 \\
\vdots & \ddots & \vdots \\
0 & \dots & \sigma_{\operatorname{element}}[8] \\
\end{pmatrix} \\
\rho_{\operatorname{element}} & = LKJcorr(2) \\
\theta_1[\operatorname{element}] & = \theta_1 + \nu_{\operatorname{element}}[1] \\
\theta_2[\operatorname{element}] & = \theta_2 + \nu_{\operatorname{element}}[2] \\
\mu_2[\operatorname{element}] & = \mu_2 + \nu_{\operatorname{element}}[3] \\
\log \delta_1 [\operatorname{element}] & = \log \delta_1 + \nu_{\operatorname{element}}[4] \\
\log \delta_2 [\operatorname{element}] & = \log \delta_2 + \nu_{\operatorname{element}}[5] \\
\log \sigma_1 [\operatorname{element}] & = \log \sigma_1 + \nu_{\operatorname{element}}[6] \\
\log \sigma_2 [\operatorname{element}] & = \log \sigma_2 + \nu_{\operatorname{element}}[7] \\
\log \sigma_3 [\operatorname{element}] & = \log \sigma_3 + \nu_{\operatorname{element}}[8]
\end{split}
\end{equation}


Prior distributions for the $\sigma_{\operatorname{element}}$ values are weakly-informative priors based on the scale of the parameter and the expectation for variation in the parameter values among element portions. For example, there is likely more variation in $\theta$ parameters—that govern the relative composition of immature, female, and male animals—among element portions than variation in $\sigma$ parameters that govern size variability within each group. The scale of different parameters also affects the expected spread of values; for instance, $\mu_2$ values are on the direct $\operatorname{LSI}_e$ scale while $\delta$ and $\sigma$ parameters are on the log-scale of $\operatorname{LSI}_e$ differences. The prior distributions for $\sigma_{\operatorname{element}}$ parameters associated with $\mu$, $\delta$, and $\sigma$ parameters are based on results of the known-specimen model, erring on the side of more variability for most parameters. Increased variability in the value of $\log \delta_1$ allows for greater size variation across elements, which makes intuitive sense because $\delta_1$ is affected by age composition and biology rather than strictly biology.

*Prior Distribution Definitions for $\sigma_{element}$ Parameters (Inter-Element Variation):*
\begin{equation}
\begin{split}
\sigma_{\operatorname{element}}[1,2] & \sim \operatorname{Half-Normal}(0, 1) \\
\sigma_{\operatorname{element}}[3] & \sim \operatorname{Half-Normal}(0, 0.1) \\
\sigma_{\operatorname{element}}[4] & \sim \operatorname{Half-Normal}(0, 0.5) \\
\sigma_{\operatorname{element}}[5] & \sim \operatorname{Half-Normal}(0, 0.25) \\
\sigma_{\operatorname{element}}[6,7,8] & \sim \operatorname{Half-Normal}(0, 0.25)
\end{split}
\end{equation}

#### *2.4.1 Extending the Multilevel Analysis to Multiple Sites*\

The multilevel structure used to allow variation in parameter estimates across element portions can also be expanded to create multisite models that can directly compare sex-specific biometric estimates alongside the age/sex composition of different assemblages. Such comparisons can highlight variation in herd management strategies or diachronic body size trends related to population turnover [e.g., @arbuckle_atici_2013; @arbuckle_etal_2016]. To do this, an additional multilevel structure can be applied to the same mixture model parameters, using $\sigma_{site}$ rather than $\sigma_{\operatorname{element}}$ parameters. However, an additional set of multilevel structure parameters, $\sigma_{interaction}$, are also necessary to ensure that elemental variation is different at different sites (e.g., the difference between $\mu_2$ for the distal humerus and $\mu_2$ for the distal radius is not necessarily the same at different sites). Again, weakly-informative priors are appropriate for both sets of parameters. Each additional term is included in the sum to create specific mixture model parameter values.

*Example of Parameter Definition for Inter-Site and Inter-Element Variation:*
$$\theta_1[\operatorname{Site}, \operatorname{Element}] = \theta_1 + \nu_{\operatorname{site}}[\operatorname{Site}] + \nu_{\operatorname{element}}[\operatorname{Element}] + \nu_{\operatorname{interaction}}[\operatorname{Site}, \operatorname{Element}]$$

The inclusion of multiple sites changes the definition of the ‘grand mean’ variable ($\theta_1$ in the example equation) from a site-level estimate to an overall mean across the sites and elements. These parameter estimates thus describe the average composition of the entire set of assemblages. The details of the assemblages included in the analyses would affect how useful these estimates are for interpretation. Assemblage-specific estimates can be calculated for each model parameter by adding the relevant $\nu_{\operatorname{site}}$ estimate to the ‘grand mean’ parameter, which would again act to describe the average composition of the assemblage regardless of its elemental composition.

### *2.5 Using Model Results to Estimate Composition and Sex-Specific Fusion Rates*

The results of the Bayesian multilevel mixture model include specimen-specific membership probabilities ($\pi_{\operatorname{specimen}}$) based on the mixture model parameters. While these membership probabilities can be used to calculate “critical size limits” where the largest membership probability shifts from one group to another [e.g., @monchot_lechelle_2002], they can also be used to simulate assemblages of known-group specimens to examine age/sex-stratified estimates of body part representation and sex-stratified fusion rates. Membership probabilities ($\pi_{\operatorname{specimen}}$) are used to simulate the specimen’s identity by sampling from the probabilities using a multinomial distribution; in each posterior sample, a single simulated assemblage is created, resulting in a distribution of simulated assemblages with known age/sex assignments [@crema_2011]. The characteristics of these assemblages can then be used to summarize the overall assemblage or identify differences in composition based on element types, fusion states, sub-assemblage features, or other pertinent factors that a researcher is interested in examining in relation to the composition of the assemblage.

There are important extensions that need to be considered when analyzing composition based on mixture modeling results. First, the Bayesian multilevel mixture model estimates the composition and biometry of a taxon’s *measurement* assemblage. In most cases, however, our interest as zooarchaeologists is the composition of the taxon’s *entire* (or *modeled*) assemblage. Generally, this is done by assuming that “measurability”—the probability that a specimen has preserved body parts that allow for biometric measurements—is random; that is, that whatever factors impacting whether a specimen is preserved well enough to have intact measurements is unrelated to the age and sex category of the specimen. This is informally applied when analysts use the results of a biometric analysis to describe an assemblage. The modeling results here can be used to formalize this relationship by stating that we believe that the element portion-specific model estimates, particularly the mixture proportions $\pi$, equally describe the measured and the non-measured specimens from the element portion. That is, while we can estimate the membership probabilities for a measured assemblage using the mixture model, our best estimate for the membership probabilities of a non-measured specimen is the element portion-specific mixture proportions $\pi$. This provides a way to include all specimens from a modeled element into estimates of composition and fusion rates, with the same caveats that fusion status can preclude the probability that a specimen could be from an immature animal.

The second extension focuses on the multilevel structure of the model, specifically the assumption that the overall mixture model hyper-parameters for *modeled* element portions are equally valid for *unmodeled* element portions. Because the model produces estimates of the “average” hyper-parameters and the variability of these parameters across element portions ($\sigma_{\operatorname{element}}$), one could use these data to estimate the element portion-specific mixture model parameter values of a completely unmodeled element portion [@mcelreath_2020_rethinkingbook; @gelman_etal_2020_bda3]. These parameter estimates, then, could be used to estimate $\pi_{\operatorname{specimen}}$ membership probabilities for the unmodeled (and unmeasured) specimens to serve as the baseline for simulated assemblages.

These extensions may seem like an extreme departure from the mixture model results, but they are a simply a formalization of the implicit assumptions analysts adopt when using the results of a biometric analysis to describe whole assemblages. If anything, these formalizations would be expected to make estimates of age/sex composition for an assemblage *less extreme* than using only the results of the measured assemblage to describe the entire assemblage. This is because of the uncertainty in the parameter values used to create $\pi_{\operatorname{specimen}}$ values for unmeasured and unmodeled specimens, which will likely be much greater than the uncertainty in the $\pi_{\operatorname{specimen}}$ values for measured specimens. Thus, extending the mixture model results to unmeasured and unmodeled specimens creates a more faithful estimate of the overall assemblage, avoiding overfitting to the smaller measurement assemblage.

### *2.6 Computational Details of the Bayesian Model*

The Bayesian multilevel mixture model is written in Stan, version `r rstan::stan_version()` [@stan_language_2.29]. All analyses in this paper use `r R.version.string`, in Rstudio `r rstudioapi::versionInfo()$version` (`r rstudioapi::versionInfo()$release_name`) [@r_language; @rstudio]. The analytical scripts use the following packages: “data.table” version `r packageVersion("data.table")`, “parallel” version `r packageVersion("parallel")`, and “doParallel” version `r packageVersion("doParallel")` for data aggregation and multi-core processing [@data.table; @doParallel], “cmdstanr” version `r packageVersion("cmdstanr")` and “rstan” version `r packageVersion("rstan")` for running the Bayesian models in the R environment and summarizing the posterior distributions of the models [@cmdstanr; @rstan], “zoolog” version `r packageVersion("zoolog")` for standard animal measurements [@zoolog], and "Cairo" version `r packageVersion("Cairo")`, “ggplot2” version `r packageVersion("ggplot2")`, “ggdist” version `r packageVersion("ggdist")`, “ggpubr” version `r packageVersion("ggpubr")`, "rnaturalearth" version `r packageVersion("rnaturalearth")`, "rnaturalearthdata" version `r packageVersion("rnaturalearthdata")`, and "sf" version `r packageVersion("sf")` to create visualizations [@cairo; @ggplot2; @ggdist; @ggpubr; @rnaturalearth; @rnaturalearthdata; @sf].

The model Stan code and analytical R code necessary to replicate and apply the analyses in this paper are freely available in a GitHub page (https://github.com/wolfhagenj/ZooarchMixMod) and Open Science Framework page (https://osf.io/4h9w6/). The project includes a copy of the Shetland sheep data file from the supplemental files published in @popkin_etal_2012 and archaeological datasets for the case studies downloaded from OpenContext [@carruthers_pinarbasi_data; @buitenhuis_ilipinar_data; @galik_barcin_data; @gourichon_helmer_mentese_data]. The analytical code includes two script files—a script for replication and one for application. The R markdown file ("ZooarchMixMod.Rmd") file replicates the entire analytical workflow of the paper, with a specific seed set to ensure exact replicability of the submitted manuscript. Another set of scripts to standardize the analytical workflow for faunal datasets structured like the OpenContext faunal datasets used in these case studies, see the GitHub for more details. All scripts (R and Stan) are released under the MIT license and figures are released as CC-BY to encourage reuse and reproducibility [@marwick_2017; @marwick_pilaarbirch_2018].

## 3. TESTING THE BAYESIAN MULTILEVEL MIXTURE MODEL

Two sets of tests are used to evaluate different aspects of the Bayesian multilevel mixture model. First, the accuracy of the model’s ability to reconstruct the age and sex composition of assemblages is tested by using simulated faunal assemblages of known age and sex from the Shetland sheep population. This test evaluates both the single-assemblage model and the multi-assemblage model. Second, two archaeological case studies showcase the applicability of the model to archaeological data and the added insights gained from adopting Bayesian multilevel mixture models. The simulated assemblage case study and the single assemblage archaeological case study use sheep (*Ovis aries*) measurements, with standard measurements coming from a female wild sheep [*Ovis orientalis* FMC 57951: @uerpmann_uerpmann_1994: Table 12]. The multiple assemblage case study uses cattle (*Bos taurus*) measurements, with standard measurements coming from a wild female aurochs [*Bos primigenius* "Ullerslev": @degerbol_1970]. Two measurements of the standard cow (Scapula GLP: 89 mm; and Calcaneus GB: 46 mm) were not included in the ‘zoolog’ output and were included manually, drawn from the referenced source.

### *3.1 Simulated Assemblages*

```{r making the simulated assemblages, eval = TRUE, include = FALSE}
####SET SEED: REMOVE TO GENERALIZE####
set.seed(1234567890)

sheep_data <- fread("./Data/1-s2.0-S0305440312000301-mmc1.csv", nrows = 356) #accessible from https://doi.org/10.1016/j.jas.2012.01.018 supplementary table, resaved as a .CSV

#Make variable for immature animals (`Days at Death` <= 365), female animals (not-immature), and male/castrated animals (not-immature)
sheep_data[, is.Immature := ifelse(`Days at Death` <= 365, 1, 0)]
sheep_data[, is.Female := ifelse(`Days at Death` > 365 & Sex %in% "Female", 1, 0)]
sheep_data[, is.Male := ifelse(`Days at Death` > 365 & Sex %in% c("Castrate", "Male"), 1, 0)]

#Reframe the sheep data to be set in a long format
sheep_longdata <- melt(sheep_data, id.vars = c("Accession  no", "Sex", "is.Immature", "is.Female", "is.Male", "Sca_coracoid_fus", "Hum_prox_fus", "Hum_dist_fus", "Rad_prox_fus", "Rad_dist_fus", "Mtc_dist_fus", "Pel_acetabulum_fus", "Fem_caput_fus", "Fem_dist_fus", "Tib_prox_fus", "Tib_dist_fus", "Mtt_dist_fus", "Cal_prox_fus"), measure.vars = names(sheep_data[, Sca_GLP:Cal_GDde]), variable.name = "Measurement", value.name = "Measurement_value")
sheep_longdata[, Element := tstrsplit(Measurement, "_")[1]]

#Get the standard animal from zoolog
sheep_standard_animal <- data.table(referencesDatabase$`Ovis orientalis`$Uerpmann)

#Keep only limb breadth bone measurements for the mixture model
sheep_mixmod_data <- sheep_longdata[Measurement %in% c("Sca_GLP", "Hum_Bd", "Hum_BT", "Rad_Bp", "Rad_Bd", "Mtc_Bp", "Mtc_BFd", "Fem_Bd", "Tib_Bd", "Ast_Bd", "Mtt_Bp", "Mtt_BFd")]

#Rename standard animal measurements to match the names in the dataset
sheep_standard_animal[EL %in% "Scapula", c("Element", "Measurement") := .("Sca", paste("Sca", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Humerus", c("Element", "Measurement") := .("Hum", paste("Hum", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Radius", c("Element", "Measurement") := .("Rad", paste("Rad", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metacarpus", c("Element", "Measurement") := .("Mtc", paste("Mtc", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Femur", c("Element", "Measurement") := .("Fem", paste("Fem", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Tibia", c("Element", "Measurement") := .("Tib", paste("Tib", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Astragalus", c("Element", "Measurement") := .("Ast", paste("Ast", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metatarsus", c("Element", "Measurement") := .("Mtt", paste("Mtt", Measure, sep = "_"))]

#Rename some measurement name mismatches
sheep_mixmod_data[Measurement %in% "Mtc_BFd", Measurement := "Mtc_Bd"]
sheep_mixmod_data[Measurement %in% "Mtt_BFd", Measurement := "Mtt_Bd"]

#Join the standard animal reference to the dataset (allows for easier identification of relevant standard measurement)
sheep_mixmod_data <- sheep_mixmod_data[sheep_standard_animal[, .(Measurement, Reference_value = Standard)], on = "Measurement"][!is.na(`Accession  no`)]

#Create "element portion" and "measurement set" numbers for the model (needs numeric labels)
#note that, by default, these are ordered alphabetically. Can also assign specific orders if desirable
sheep_mixmod_data[, c("Measurement_Set", "Element_Portion") := .(as.numeric(as.factor(Measurement)), as.numeric(as.factor(Element)))]

#Create "specimen" labels to link meausrements from the same bone specimen (model needs numeric labels)
sheep_mixmod_data[, "Specimen_No" := as.numeric(as.factor(paste(`Accession  no`, Element, sep = "_")))]
sheep_mixmod_data[, "Individual_No" := as.numeric(as.factor(`Accession  no`))]

#Immature: identify whether specimens COULD be immature based on element portion and fusion status, if relevant
sheep_mixmod_data[Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
sheep_mixmod_data[Element %in% c("Hum"), Immature := as.numeric(Hum_prox_fus %in% c("fu", "fg") == F)]
sheep_mixmod_data[Element %in% "Rad", Immature := as.numeric(Rad_dist_fus %in% c("fu", "fg") == F)]
sheep_mixmod_data[Element %in% "Mtc", Immature := as.numeric(Mtc_dist_fus %in% c("fu", "fg") == F)]
sheep_mixmod_data[Element %in% "Fem", Immature := as.numeric(Fem_dist_fus %in% c("fu", "fg") == F)]
sheep_mixmod_data[Element %in% "Tib", Immature := as.numeric(Tib_prox_fus %in% c("fu", "fg") == F)]
sheep_mixmod_data[Element %in% "Mtt", Immature := as.numeric(Mtt_dist_fus %in% c("fu", "fg") == F)]

#Group: category for immature vs female vs male/castrate (for checking accuracy)
sheep_mixmod_data[, Group := ifelse(is.Immature %in% 1, "Immature", ifelse(is.Female %in% 1, "Female", ifelse(is.Male %in% 1, "Male", NA)))]
#Demographic information: collecting fusion data on proximal and middle phalanges and sex data on fused pelves
sheep_phx_fusion <- melt(sheep_data[, .(`Accession  no`, is.Immature, is.Female, is.Male, Pph_fore_int_fus, Pph_fore_ext_fus, Pph_dist_int_fus, Pph_dist_ext_fus, Mph_fore_int_fus, Mph_fore_ext_fus, Mph_dist_int_fus, Mph_dist_ext_fus)], id.vars = c("Accession  no", "is.Immature", "is.Female", "is.Male"), variable.name = "Phalanx", value.name = "Fusion")[Fusion %in% "na" == F]
sheep_phx_fusion[, Element := ifelse(grepl("Pph", Phalanx), "PH1", "PH2")]

sheep_pelvis_sex <- sheep_data[Pel_acetabulum_fus %in% "fu", .(`Accession  no`, is.Immature, is.Female, is.Male)][is.Immature %in% 0, .(`Accession  no`, Sex = ifelse(is.Female %in% 1, "Female", ifelse(is.Male %in% 1, "Male", NA)))]
```

```{r simulate the datasets, include = FALSE, eval = TRUE}
#Single assemblage simulation: 150 measured element portions, probabilities remain the same as the underlying population
single_assemblage_mixmod_data <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 150, replace = F)]
#Re-assign numeric codes for element portions, measurement sets, and individual specimens (to prevent mismatches/overlap)
single_assemblage_mixmod_data[, Measurement_Set := as.numeric(as.factor(Measurement))]
single_assemblage_mixmod_data[, Element_Portion := as.numeric(as.factor(Element))]
single_assemblage_mixmod_data[, Original_Specimen_No := Specimen_No] #allows the creation of modeled assemblages without resampling
single_assemblage_mixmod_data[, Specimen_No := as.numeric(as.factor(Specimen_No))]
single_assemblage_mixmod_data[, Site_No := 1]

#Multi-site simulation: 15 sites, varying sample size, expected composition, and body size manipulations
#Sites 1-5: no variation in composition to the underlying population
#Sites 6-10: 20% immature, 70% female, 10% male
#Sites 11-15: 5% immature, 35% female, 60% male
#Size variation in Sites 3-5, 8-10, and 13-15
#Sample sizes: N = 10 element portions in Sites 2, 7, and 12 (N = 30 element portions otherwise)

#straight from the data, 30 measured specimens
site_01 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F)]
#straight from the data, 10 measured specimens
site_02 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 10, replace = F)]
#30 measured specimens, increase size
site_03 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F)]
site_03[, Measurement_value := Measurement_value * 1.20]
#30 measured specimens, decrease size
site_04 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F)]
site_04[, Measurement_value := Measurement_value * 0.80]
#30 measured specimens, increase sexual dimorphism
site_05 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F)]
site_05[is.Male %in% 1, Measurement_value := Measurement_value * 1.20]

#20% immature, 70% female, 10% male
#have to adjust probabilities of choosing based on underlying proportions of the dataset
#20% immature, 70% female, 10% male; 30 measured specimens
site_06 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])]
#20% immature, 70% female, 10% male; 10 measured specimens
site_07 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 10, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])]
#20% immature, 70% female, 10% male; 30 measured specimens, increased size
site_08 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])]
site_08[, Measurement_value := Measurement_value * 1.20]
#20% immature, 70% female, 10% male; 30 measured specimens, decreased size
site_09 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])]
site_09[, Measurement_value := Measurement_value * 0.80]
#20% immature, 70% female, 10% male; 30 measured specimens, increased sexual dimorphism
site_10 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])]
site_10[is.Male %in% 1, Measurement_value := Measurement_value * 1.20]

#5% immature, 35% female, 60% male
#have to adjust probabilities of choosing based on underlying proportions of the dataset
#5% immature, 35% female, 60% male; 30 measured specimens
site_11 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])]
#5% immature, 35% female, 60% male; 10 measured specimens
site_12 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 10, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])]
#5% immature, 35% female, 60% male; 30 measured specimens, increased size
site_13 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])]
site_13[, Measurement_value := Measurement_value * 1.20]
#5% immature, 35% female, 60% male; 30 measured specimens, decreased size
site_14 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])]
site_14[, Measurement_value := Measurement_value * 0.80]
#5% immature, 35% female, 60% male; 30 measured specimens, increased sexual dimorphism
site_15 <- sheep_mixmod_data[Specimen_No %in% sample(1:sheep_mixmod_data[, .N, Specimen_No][, .N], 30, replace = F, prob = sheep_mixmod_data[, .N, .(Specimen_No, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])]
site_15[is.Male %in% 1, Measurement_value := Measurement_value * 1.20]

#Bring all the assemblages together
multisite_mixmod_data <- rbind(data.table(Site_No = 1, site_01),
                               data.table(Site_No = 2, site_02),
                               data.table(Site_No = 3, site_03),
                               data.table(Site_No = 4, site_04),
                               data.table(Site_No = 5, site_05),
                               data.table(Site_No = 6, site_06),
                               data.table(Site_No = 7, site_07),
                               data.table(Site_No = 8, site_08),
                               data.table(Site_No = 9, site_09),
                               data.table(Site_No = 10, site_10),
                               data.table(Site_No = 11, site_11),
                               data.table(Site_No = 12, site_12),
                               data.table(Site_No = 13, site_13),
                               data.table(Site_No = 14, site_14),
                               data.table(Site_No = 15, site_15))

#Re-assign numeric codes for element portions, measurement sets, and individual specimens (to prevent mismatches/overlap)
multisite_mixmod_data[, Measurement_Set := as.numeric(as.factor(Measurement))]
multisite_mixmod_data[, Element_Portion := as.numeric(as.factor(Element))]
multisite_mixmod_data[, Original_Specimen_No := Specimen_No] #allows the creation of modeled assemblages without resampling the measured specimens
multisite_mixmod_data[, Specimen_No := as.numeric(as.factor(paste(Site_No, Specimen_No, sep = ".")))]

##Demographic observations for the simulations: simulate observations from sheep_phx_fusion and sheep_pelvis_sex
#Single assemblage simulation
single_assemblage_demographic_observations <- data.table(Site = "Single Assemblage", Site_No = 1, N_Unfused = sheep_phx_fusion[sample(1:.N, 50)][Fusion %in% c("u", "fo"), .N], N_Ageable = 50, N_Female = sheep_pelvis_sex[sample(1:.N, 15)][Sex %in% "Female", .N], N_Sexable = 15)

#Multi-site simulation
multisite_demographic_observations <- rbind(
  data.table(Site = "Site 01", Site_No = 1, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F)][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F)][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 02", Site_No = 2, N_Unfused = sheep_phx_fusion[sample(1:.N, 10, replace = F)][Fusion %in% c("u", "fo"), .N], N_Ageable = 15, N_Female = sheep_pelvis_sex[sample(1:.N, 4, replace = F)][Sex %in% "Female", .N], N_Sexable = 4),
  data.table(Site = "Site 03", Site_No = 3, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F)][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F)][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 04", Site_No = 4, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F)][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F)][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 05", Site_No = 5, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F)][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F)][Sex %in% "Female", .N], N_Sexable = 8),
  #20% immature, 70% female, 10% male
  data.table(Site = "Site 06", Site_No = 6, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.2 / (384 / 2752), ifelse(is.Female %in% 1, 0.7 / (1312 / 2752), ifelse(is.Male %in% 1, 0.1 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.7 / 0.8) / (164 / 308), ifelse(Sex %in% "Male", (0.1 / 0.8) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 07", Site_No = 7, N_Unfused = sheep_phx_fusion[sample(1:.N, 10, replace = F, prob = ifelse(is.Immature %in% 1, 0.2 / (384 / 2752), ifelse(is.Female %in% 1, 0.7 / (1312 / 2752), ifelse(is.Male %in% 1, 0.1 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 15, N_Female = sheep_pelvis_sex[sample(1:.N, 4, replace = F, prob = ifelse(Sex %in% "Female", (0.7 / 0.8) / (164 / 308), ifelse(Sex %in% "Male", (0.1 / 0.8) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 4),
  data.table(Site = "Site 08", Site_No = 8, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.2 / (384 / 2752), ifelse(is.Female %in% 1, 0.7 / (1312 / 2752), ifelse(is.Male %in% 1, 0.1 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.7 / 0.8) / (164 / 308), ifelse(Sex %in% "Male", (0.1 / 0.8) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 09", Site_No = 9, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.2 / (384 / 2752), ifelse(is.Female %in% 1, 0.7 / (1312 / 2752), ifelse(is.Male %in% 1, 0.1 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.7 / 0.8) / (164 / 308), ifelse(Sex %in% "Male", (0.1 / 0.8) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 10", Site_No = 10, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.2 / (384 / 2752), ifelse(is.Female %in% 1, 0.7 / (1312 / 2752), ifelse(is.Male %in% 1, 0.1 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.7 / 0.8) / (164 / 308), ifelse(Sex %in% "Male", (0.1 / 0.8) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  #5% immature, 35% female, 60% male
  data.table(Site = "Site 11", Site_No = 11, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.05 / (384 / 2752), ifelse(is.Female %in% 1, 0.35 / (1312 / 2752), ifelse(is.Male %in% 1, 0.60 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.35 / 0.95) / (164 / 308), ifelse(Sex %in% "Male", (0.60 / 0.95) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 12", Site_No = 12, N_Unfused = sheep_phx_fusion[sample(1:.N, 10, replace = F, prob = ifelse(is.Immature %in% 1, 0.05 / (384 / 2752), ifelse(is.Female %in% 1, 0.35 / (1312 / 2752), ifelse(is.Male %in% 1, 0.60 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 15, N_Female = sheep_pelvis_sex[sample(1:.N, 4, replace = F, prob = ifelse(Sex %in% "Female", (0.35 / 0.95) / (164 / 308), ifelse(Sex %in% "Male", (0.60 / 0.95) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 4),
  data.table(Site = "Site 13", Site_No = 13, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.05 / (384 / 2752), ifelse(is.Female %in% 1, 0.35 / (1312 / 2752), ifelse(is.Male %in% 1, 0.60 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.35 / 0.95) / (164 / 308), ifelse(Sex %in% "Male", (0.60 / 0.95) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 14", Site_No = 14, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.05 / (384 / 2752), ifelse(is.Female %in% 1, 0.35 / (1312 / 2752), ifelse(is.Male %in% 1, 0.60 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.35 / 0.95) / (164 / 308), ifelse(Sex %in% "Male", (0.60 / 0.95) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8),
  data.table(Site = "Site 15", Site_No = 15, N_Unfused = sheep_phx_fusion[sample(1:.N, 30, replace = F, prob = ifelse(is.Immature %in% 1, 0.05 / (384 / 2752), ifelse(is.Female %in% 1, 0.35 / (1312 / 2752), ifelse(is.Male %in% 1, 0.60 / (1056 / 2752), NA))))][Fusion %in% c("u", "fo"), .N], N_Ageable = 30, N_Female = sheep_pelvis_sex[sample(1:.N, 8, replace = F, prob = ifelse(Sex %in% "Female", (0.35 / 0.95) / (164 / 308), ifelse(Sex %in% "Male", (0.60 / 0.95) / (144 / 308), NA)))][Sex %in% "Female", .N], N_Sexable = 8)
)

#Simulate the modeled assemblages
#single assemblage simulation
single_measured_assemblage <- single_assemblage_mixmod_data[, .N, .(Individual_No, Specimen_No, Original_Specimen_No, Element, Element_Portion, Immature, Group, Site_No)]
single_modeled_assemblage <- rbind(single_measured_assemblage,
                                   sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% single_measured_assemblage[, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][, Specimen_No], 600, replace = F)][, .(Specimen_No = NA, Site_No = 1, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)])

#multisite assemblage simulation
multisite_measured_assemblage <- multisite_mixmod_data[, .N, .(Individual_No, Specimen_No, Original_Specimen_No, Element, Element_Portion, Immature, Group, Site_No)]
multisite_modeled_assemblage <- rbind(multisite_measured_assemblage,
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 1, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F)][, .(Specimen_No = NA, Site_No = 1, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 2, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 40, replace = F)][, .(Specimen_No = NA, Site_No = 2, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 3, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F)][, .(Specimen_No = NA, Site_No = 3, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 4, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F)][, .(Specimen_No = NA, Site_No = 4, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 5, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F)][, .(Specimen_No = NA, Site_No = 5, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      #Sites 6-10: 20% immature, 70% female, 10% male
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 6, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 6, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 6, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 7, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 40, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 7, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 7, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 8, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 8, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 8, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 9, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 9, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 9, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 10, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 10, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.20 / (384 / 2848), ifelse(Group %in% "Female", 0.70 / (1312 / 2848), ifelse(Group %in% "Male", 0.10 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 10, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      #Sites 11-15: 5% immature, 35% female, 60% male
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 11, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 11, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 11, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 12, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 40, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 12, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 12, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 13, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 13, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 13, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 14, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 14, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 14, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)],
                                      sheep_mixmod_data[Specimen_No %in% sample(sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 15, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion)][order(Specimen_No), Specimen_No], 120, replace = F, prob = sheep_mixmod_data[Specimen_No %in% multisite_measured_assemblage[Site_No %in% 15, Original_Specimen_No] == F, .N, .(Individual_No, Specimen_No, Element_Portion, Group)][order(Specimen_No), ifelse(Group %in% "Immature", 0.05 / (384 / 2848), ifelse(Group %in% "Female", 0.35 / (1312 / 2848), ifelse(Group %in% "Male", 0.60 / (1152 / 2848), NA)))])][, .(Specimen_No = NA, Site_No = 15, .N), .(Individual_No, Original_Specimen_No = Specimen_No, Element, Element_Portion, Immature, Group)])
```

```{r summarize the simulations, include = FALSE, eval = TRUE}
#Summarize the simulations
simulation_summary <- list(
  single_assemblage_n_specimens = single_assemblage_mixmod_data[, .N, Specimen_No][, .N],
  single_assemblage_n_measurements = single_assemblage_mixmod_data[, .N],
  single_assemblage_n_indivudals = single_assemblage_mixmod_data[, .N, `Accession  no`][, .N],
  multi_assemblage_n_sites = multisite_mixmod_data[, .N, Site_No][, .N],
  single_assemblage_n_modeled_specimens = single_modeled_assemblage[is.na(Specimen_No), .N],
  single_assemblage_n_modeled_assemblage = single_modeled_assemblage[, .N]
)

#Table 3 information (elemental composition of the simulated assemblages)
table_3 <- dcast(rbind(single_assemblage_mixmod_data[, .(.N, Assemblage = "Single Assemblage", `Demographics` = "$13\\%$ Immature, $46\\%$ Female, $40\\%$ Male", `Size` = "1.00"), .(Specimen_No, Group)][, .N, .(Assemblage, Demographics, Size, Group)],
                       multisite_mixmod_data[, .N, .(Specimen_No, Group, Assemblage = ifelse(Site_No >= 10, paste0("Site ", Site_No), paste0("Site 0", Site_No)),
                                                        `Demographics` = ifelse(Site_No %in% 1:5, "$13\\%$ Immature, $46\\%$ Female, $40\\%$ Male", ifelse(Site_No %in% 6:10, "$20\\%$ Immature, $70\\%$ Female, $10\\%$ Male", ifelse(Site_No %in% 11:15, "$5\\%$ Immature, $35\\%$ Female, $60\\%$ Male", NA))),
                                                        `Size` = ifelse(Site_No %in% c(1:2, 6:7, 11:12), "1.00", ifelse(Site_No %in% c(3, 8, 13), "1.20", ifelse(Site_No %in% c(4, 9, 14), "0.80", ifelse(Site_No %in% c(5, 10, 15), "1.20 (Males)", NA)))))][, .N, .(Assemblage, Demographics, Size, Group)]),
                 Assemblage + `Demographics` + `Size` ~ Group, value.var = "N", fill = 0)
#add totals column
table_3[, Total := sum(.SD), Assemblage, .SDcols = names(table_3)[-(1:3)]]

#add in footnotes manually
table_3[Size %in% "1.20 (Males)", Size := paste0("1.20", footnote_marker_symbol(1, "latex"))]
```

A series of simulated assemblages of known-age and sex composition are created from the Shetland sheep population by randomly drawing element portions (and all associated measurements) from the total assemblage without replacement. The first test, using a single-assemblage model, uses `r simulation_summary$single_assemblage_n_specimens` element portions from the Shetland sheep population where every element portion has an equal probability of being selected. There is no guarantee, however, that the element portions have equal representation or even that all element portions are present in the simulated assemblage, which better approximates archaeological assemblages. The result of this first simulation produces an assemblage of `r simulation_summary$single_assemblage_n_measurements` measurements from `r simulation_summary$single_assemblage_n_individuals` individual animals. The second test creates `r simulation_summary$multi_assemblage_n_sites` simulated assemblages using the same procedure that are analyzed in a single multi-assemblage model. To further test the model’s flexibility, these assemblages vary in sample size and some are manipulated to vary in average body size and expected composition from the original Shetland sheep population. Demographic observations for phalanx fusion rates and pelvis sex ratios were also simulated from the Shetland sheep population using the same underlying probabilities as the measurement assemblages. Table 3 describes the sample sizes of the measurement assemblages, including any manipulations to the measurement values. The specific elemental composition and measurements of the assemblages, along with the simulated demographic observations, used in both simulations can be recovered from the replication script with the recorded random seed (see also Supplemental Tables 1-3); using another random seed would provide a conceptual replication of new assemblages drawn from the same underlying populations.

```{r table_3, echo = FALSE}
kbl(table_3[, .(Assemblage, Demographics, Size, Immature, Female, Male, Total)], caption = "Group Composition of the Simulated Measurement Assemblages (Element Portions)", booktabs = T, escape = FALSE, linesep = c('\\addlinespace', rep(c('', '', '', '', '\\addlinespace'), 3))) %>%
  kable_styling("hold_position", "scale_down") %>%
  column_spec(ncol(table_3), bold = TRUE) %>%
  footnote(general = "Demographics in the Single Assemblage and Sites 01-05 reflect original Shetland sheep composition",
           symbol = c("Size increased for males only"))
```

For each model test, accuracy is evaluated in two ways. First, the posterior distributions of the mixture model hyper-parameters are compared to the known values for the population (“parametric accuracy”). The model hyper-parameters are first transformed into estimates of composition ($\pi$), body size ($\mu$) and size variability ($\sigma$) rather than the unconstrained variables that were modeled directly. These known values are calculated from the entire Shetland sheep population from which the assemblages were sampled [@popkin_etal_2012], including any manipulations of composition or size as described in Table 3. Second, the mixture model results are used to estimate the age and sex composition of the relevant measured and modeled assemblages—estimates of the number of immature, female, and male specimens for each element portion—that are compared to the actual composition of the assemblages (“compositional accuracy”). For the multi-assemblage model, compositional accuracy is evaluated both overall (all the assemblages combined) and for each assemblage individually. As described in Section 2.5, modeled assemblages are the measured and unmeasured specimens from the relevant element portions that are modeled with the mixture model. The measurement assemblage is considered a sample from this modeled assemblage, under the assumption that measurability—sufficient preservation of anatomical structures to be measured—is unrelated to the age and sex category of the specimen. Thus, just as the parametric accuracy is compared against the “population” parameters from which the measured assemblages were sampled, so to the compositional accuracy can be compared against the “modeled” assemblage that includes non-measured specimens sampled from the same underlying population.

Modeled assemblages were created for the single-assemblage simulation and the multi-assemblage simulation by assuming that measured specimens represent 20% of the overall assemblage and sampling more specimens from the Shetland sheep population to create the remaining 80% of the assemblage. For example, in the single-assemblage simulation with `r simulation_summary$single_assemblage_n_specimens` measured specimens, this means sampling `r simulation_summary$single_assemblage_n_modeled_specimens` more specimens from the Shetland sheep population to create a total modeled assemblage of `r simulation_summary$single_assemblage_n_modeled_assemblage` specimens. Specimens could not be repeatedly sampled, though multiple specimens could be from the same individual. As described in Section 2.5, unmeasured specimens use the relevant $\pi$ parameters for the element portion. For the multisite simulation, this potentially includes element portions where there are no relevant measurements in the specific assemblage.

Because the "grand mean" parameters in the multisite simulation no longer represent the same thing as in the single assemblage model (see Section 2.4.1), the prior distributions must also be changed to reflect different expectations. Again, the goal of these prior distribution definitions is to prevent extreme overfitting so that parameter estimates are biologically feasible [@gelman_etal_2008]. In general, the centers of the distributions stayed the same but the uncertainty was increased, reflecting the fact that there's less certainty about what may be a biologically feasible value to describe multiple populations, especially if there is size variation expected between the assemblages.

*Prior Distribution Definitions for the Multisite Simulation Model Hyper-Parameters*
\begin{equation}
\begin{split}
\theta_1 & \sim \operatorname{Normal}(-0.5, 1.5) \\
\theta_2 & \sim \operatorname{Normal}(0.0, 1.5) \\
\mu_2 & \sim \operatorname{Normal}(0.0, 0.2) \\
\log \delta_1 & \sim \operatorname{Normal}(-3.5, 0.5) \\
\log \delta_2 & \sim \operatorname{Normal}(-2.7, 0.5) \\
\log \sigma_1 & \sim \operatorname{Normal}(-3.05, 0.25) \\
\log \sigma_2 & \sim \operatorname{Normal}(-3.10, 0.2) \\
\log \sigma_3 & \sim \operatorname{Normal}(-3.10, 0.2)
\end{split}
\end{equation}

### *3.2 Archaeological Case Studies*

```{r making the archaeological assemblages and map, eval = TRUE, include = FALSE, warning = FALSE}
####1. Import the archaeological data####
#list of elements (names from OpenContext standards)
modeled_elements <- c("scapula", "humerus", "radius bone", "fused metacarpal bones 3 and 4", "femur", "tibia", "talus", "calcaneus", "fused metatarsal bones 3 and 4", "proximal phalanx")

#Barcin Hoyuk Cattle####
barcin <- fread("./Data/Barcin Hoyuk Zooarchaeology Data (OpenContext - DOI 10.678-M7MS3QN7).csv")
#Have to include element names that are not in the modeled_elements categories because they're collapsed categories of multiple metacarpal/metatarsal identifications
barcin_data <- barcin[`Has Biological Taxonomy [Label]` %in% c("Bos taurus Linnaeus, 1758", "Bos primigenius") & `Has anatomical identification [Label]` %in% c(modeled_elements, "fused metacarpal bones 3 and 4; metacarpal bone of digit 3; metacarpal bone of digit 4; metacarpal bone of digit 5", "metatarsal bone of digit 5; metatarsal bone of digit 2; fused metatarsal bones 3 and 4", "middle phalanx"), .(ID = paste("Barcin", `Label`, sep = " "), Site = "Barcin", Taxon = `Has Biological Taxonomy [Label]`, Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = `Has fusion character [Proximal Label]`, `Distal Fusion` = `Has fusion character [Distal Label]`, GLP = `Scap_glp`, Bd = ifelse(`Has anatomical identification [Label]` %in% "talus", Tal_bd, Bd), BT = NA, Bp = Bp, BFp = Bfp, DC = NA, GB = Gb)][!is.na(GLP) | !is.na(Bd) | !is.na(BT) | !is.na(Bp) | !is.na(BFp) | !is.na(DC) | !is.na(GB)]

#Troubleshooting
barcin_data[ID %in% c("Barcin Bone 448", "Barcin Bone 358"), c("Bp") := NA] #anomalously small Bp measurements (17.2, 18.1); error in taxon coding?

#Create key between the "Anatomy" label from the original dataset and the "Element" label that will be used in the model
barcin_element_key <- data.table(`Anatomy Label` = c("scapula", "humerus", "radius bone", "fused metacarpal bones 3 and 4; metacarpal bone of digit 3; metacarpal bone of digit 4; metacarpal bone of digit 5", "femur", "tibia", "talus", "calcaneus", "metatarsal bone of digit 5; metatarsal bone of digit 2; fused metatarsal bones 3 and 4", "proximal phalanx", "middle phalanx"),
                                 `Element Label` = c("Sca", "Hum", "Rad", "Mtc", "Fem", "Tib", "Ast", "Cal", "Mtt", "PH1", "PH2"))

#Ilipinar Cattle####
ilipinar <- fread("./Data/Ilipinar Zooarchaeology Main Zooarchaeological Dataset (OpenContext - DOI 10.6078-M72R3PM2).csv")
ilipinar_data <- ilipinar[`Has Biological Taxonomy [Label]` %in% c("Bos taurus Linnaeus, 1758", "Bos", "Bos primigenius") & `Period` %in% c("X", "IX", "IX/VIII", "VIII", "VII", "VI", "VI/VA", "VA", "VB") & `Has anatomical identification [Label]` %in% c(modeled_elements, "middle phalanx"), .(ID = paste("Ilipinar", `Label`, sep = " "), Site = ifelse(`Period` %in% c("X", "IX", "IX/VIII", "VIII"), "Ilipinar 1 (Late Neolithic/Transitional)", ifelse(`Period` %in% c("VII", "VI", "VI/VA", "VA", "VB"), "Ilipinar 2 (Early Chalcolithic)", NA)), Taxon = `Has Biological Taxonomy [Label]`, Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = `Has fusion character [Proximal Label]`, `Distal Fusion` = `Has fusion character [Distal Label]`, GLP = GLP, Bd = ifelse(`Has anatomical identification [Label]` %in% c("fused metacarpal bones 3 and 4", "fused metatarsal bones 3 and 4"), `Bd (breadth of distal end- epi)`, `Bd`), BT = BT, Bp = Bp, BFp = BFp, DC = DC, GB = GB, Taxon = `Has Biological Taxonomy [Label]`)][!is.na(GLP) | !is.na(Bd) | !is.na(BT) | !is.na(Bp) | !is.na(BFp) | !is.na(DC) | !is.na(GB)]

#Troubleshooting
ilipinar_data[ID %in% "Ilipinar Bone 8029", c("Bp", "Bd") := .(NA, 68.8)] #originally listed as Bp
ilipinar_data[ID %in% "Ilipinar Bone 2706", c("Bd") := .(61.1)] #appears to be switched with SD (44.7)
ilipinar_data[ID %in% "Ilipinar Bone 1576", c("Bd") := .(45)] #appears to be switched with GLm (64.7)
ilipinar_data[ID %in% "Ilipinar Bone 2073", c("Bd") := NA] #appears to be a copy of GLm (63.2), unclear what original measurement was
ilipinar_data[ID %in% c("Ilipinar Bone 6592", "Ilipinar Bone 31126"), c("Bp") := NA] #Bp appears to be a copy of GLpe (58.6, 65.7)
ilipinar_data[ID %in% c("Ilipinar Bone 1813"), c("Bd") := NA] #Bd appears anomalously low; possibly typo on the anatomy?
ilipinar_data[ID %in% c("Ilipinar Bone 8680"), c("Bp", "BFp") := .(NA, NA)] #values are anomalously low and distant from one another, unclear if taxon or anatomy are correct (Bp = 55.3, BFp = 36.0)
ilipinar_data[ID %in% "Ilipinar Bone 20694", c("Bp") := 38.1] #switched with GL (66)
ilipinar_data[ID %in% "Ilipinar Bone 20427", c("Bp") := NA] #remove measurement (anomalously low), unclear if typo in measurement or taxon?

#Creating key between the "Anatomy" label from the original dataset and the "Element" label that will be used in the model
ilipinar_element_key <- data.table(`Anatomy Label` = c("scapula", "humerus", "radius bone", "fused metacarpal bones 3 and 4", "femur", "tibia", "talus", "calcaneus", "fused metatarsal bones 3 and 4", "proximal phalanx", "middle phalanx"),
                                   `Element Label` = c("Sca", "Hum", "Rad", "Mtc", "Fem", "Tib", "Ast", "Cal", "Mtt", "PH1", "PH2"))

#Mentese Cattle####
mentese <- fread("./Data/Neolithic Mentese Faunal Data Table (OpenContext - DOI 10.6078-M7MG7MD8).csv")
mentese_data <- mentese[`Has Biological Taxonomy [Label]` %in% "Bos" & `Has anatomical identification [Label]` %in% c(modeled_elements, "middle phalanx"), .(ID = paste("Mentese", `Label`, sep = " "), Site = "Mentese", Taxon = `Has Biological Taxonomy [Label]`, Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = `Has fusion character [Proximal Label]`, `Distal Fusion` = `Has fusion character [Distal Label]`, GLP = GLP, Bd = Bd, BT = BT, Bp = Bp, BFp = BFp, DC = NA, GB = GB)][!is.na(GLP) | !is.na(Bd) | !is.na(BT) | !is.na(Bp) | !is.na(BFp) | !is.na(DC) | !is.na(GB)]

#Troubleshooting
mentese_data[ID %in% "Mentese Bone 2403", Bp := 10.8] #Bp measurement is way too large relative to the Bd value (10.9); shifting to 10.8 seems more reasonable
mentese_data[Anatomy %in% "calcaneus", `Proximal Fusion` := ifelse(`Distal Fusion` %in% "Distal epiphysis unfused", "Proximal epiphysis unfused", ifelse(`Distal Fusion` %in% "Distal epiphysis fusing", "Proximal epiphysis fusing", ifelse(`Distal Fusion` %in% "Distal epiphysis fused", "Proximal epiphysis fused", ifelse(`Distal Fusion` %in% "", "", NA))))] #calcaneus fusion is listed as `Distal Fusion` but is `Proximal Fusion` in other sites/codes

#Creating key between the "Anatomy" label from the original dataset and the "Element" label that will be used in the model
mentese_element_key <- data.table(`Anatomy Label` = c("scapula", "humerus", "radius bone", "fused metacarpal bones 3 and 4", "femur", "tibia", "talus", "calcaneus", "fused metatarsal bones 3 and 4", "proximal phalanx", "middle phalanx"),
                                  `Element Label` = c("Sca", "Hum", "Rad", "Mtc", "Fem", "Tib", "Ast", "Cal", "Mtt", "PH1", "PH2"))

#Pinarbasi Sheep####
pinarbasi <- fread("./Data/Pinarbasi EOL Computational Data Challenge Revised Zooarchaeology Dataset (OpenContext - DOI 10.607-8M7X34VD1).csv")
#Have to include element names that are not in the modeled_elements categories because they're collapsed categories of multiple metacarpal/metatarsal identifications
pinarbasi_data <- pinarbasi[`Has Biological Taxonomy [Label]` %in% "Ovis" & `Context (3)` %in% "Site B" & `Has anatomical identification [Label]` %in% c(modeled_elements, "fused metacarpal bones 3 and 4; metacarpal bone of digit 1; metacarpal bone of digit 4; metacarpal bone of digit 5; metacarpal bone of digit 2; metacarpal bone; metacarpal bone of digit 3", "metatarsal bone of digit 2; metatarsal bone of digit 4; fused metatarsal bones 3 and 4; metatarsal bone of digit 3"), .(ID = paste("Pinarbasi B", `Label`, sep = " "), Site = "Pinarbasi B", Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = ifelse(!is.na(`GB (unfused)`) | !is.na(`Bp (unfused)`), "Proximal epiphysis unfused", `Has fusion character [Proximal Label]`), `Distal Fusion` = ifelse(!is.na(`Bd (unfused)`), "Distal epiphysis unfused", `Has fusion character [Distal Label]`), GLP = NA, Bd = ifelse(!is.na(`Bd (unfused)`), `Bd (unfused)`, Bd), BT = NA, Bp = ifelse(!is.na(`Bp (unfused)`), `Bp (unfused)`, Bp), BFp = BFp, DC = NA, GB = ifelse(!is.na(`GB (unfused)`), `GB (unfused)`, GB))][!is.na(GLP) | !is.na(Bd) | !is.na(BT) | !is.na(Bp) | !is.na(BFp) | !is.na(DC) | !is.na(GB)]

#Creating key between the "Anatomy" label from the original dataset and the "Element" label that will be used in the model
pinarbasi_element_key <- data.table(`Anatomy Label` = c("scapula", "humerus", "radius bone", "fused metacarpal bones 3 and 4; metacarpal bone of digit 1; metacarpal bone of digit 4; metacarpal bone of digit 5; metacarpal bone of digit 2; metacarpal bone; metacarpal bone of digit 3", "femur", "tibia", "talus", "calcaneus", "metatarsal bone of digit 2; metatarsal bone of digit 4; fused metatarsal bones 3 and 4; metatarsal bone of digit 3", "proximal phalanx"),
                                    `Element Label` = c("Sca", "Hum", "Rad", "Mtc", "Fem", "Tib", "Ast", "Cal", "Mtt", "PH1"))


#Reference animal from `zoolog` package
sheep_standard_animal <- data.table(referencesDatabase$`Ovis orientalis`$Uerpmann) #redoing sheep even though it was done in the simulations
bos_standard_animal <- data.table(referencesDatabase$`Bos primigenius`$Degerbol)
#add in the measurement of the Scapula GLP (89.0 mm), Calcaneus GB (46.0 mm); Degerbol 1970: Table 13, Table 18
bos_standard_animal <- rbind(bos_standard_animal, data.table(TAX = rep("Bos primigenius", 2), EL = c("Scapula", "Calcaneus"), Measure = c("GLP", "GB"), Standard = c(89.0, 46)))

####2. Structuring the Datasets####

#Reference Data
#Rename standard animal measurements to match the names in the dataset
sheep_standard_animal[EL %in% "Scapula", c("Element", "Measurement") := .("Sca", paste("Sca", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Humerus", c("Element", "Measurement") := .("Hum", paste("Hum", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Radius", c("Element", "Measurement") := .("Rad", paste("Rad", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metacarpus", c("Element", "Measurement") := .("Mtc", paste("Mtc", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Femur", c("Element", "Measurement") := .("Fem", paste("Fem", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Tibia", c("Element", "Measurement") := .("Tib", paste("Tib", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Astragalus", c("Element", "Measurement") := .("Ast", paste("Ast", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Calcaneus", c("Element", "Measurement") := .("Cal", paste("Cal", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Metatarsus", c("Element", "Measurement") := .("Mtt", paste("Mtt", Measure, sep = "_"))]
sheep_standard_animal[EL %in% "Phalanx 1 ant.", c("Element", "Measurement") := .("PH1", paste("PH1", Measure, sep = "_"))]
#
bos_standard_animal[EL %in% "Scapula", c("Element", "Measurement") := .("Sca", paste("Sca", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Humerus", c("Element", "Measurement") := .("Hum", paste("Hum", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Radius", c("Element", "Measurement") := .("Rad", paste("Rad", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Metacarpus", c("Element", "Measurement") := .("Mtc", paste("Mtc", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Femur", c("Element", "Measurement") := .("Fem", paste("Fem", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Tibia", c("Element", "Measurement") := .("Tib", paste("Tib", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Astragalus", c("Element", "Measurement") := .("Ast", paste("Ast", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Calcaneus", c("Element", "Measurement") := .("Cal", paste("Cal", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Metatarsus", c("Element", "Measurement") := .("Mtt", paste("Mtt", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Phalanx 1 ant.", c("Element", "Measurement") := .("PH1", paste("PH1", Measure, sep = "_"))]
bos_standard_animal[EL %in% "Phalanx 2 ant.", c("Element", "Measurement") := .("PH1", paste("PH2", Measure, sep = "_"))]

#Function to restructure the measurement data into a format for the model
assemblage_restructure <- function(dataset, reference_dataset, element_key, included_measurements = c("Sca_GLP", "Hum_Bd", "Hum_BT", "Rad_Bp", "Rad_BFp", "Rad_Bd", "Mtc_Bp", "Mtc_Bd", "Fem_DC", "Fem_Bd", "Tib_Bp", "Tib_Bd", "Ast_Bd", "Cal_GB", "Mtt_Bp", "Mtt_Bd", "PH1_Bp")) {
  #Element: identify what end of the bone (proximal/distal) is included in the measurements (for element portions).
  #goes through element_key to change anatomical part names to the new labels
  #Note: key may have multiple Anatomy Labels that fit onto the same `Element Label`
  for(i in 1:nrow(element_key)) {
    dataset[Anatomy %in% element_key[i, `Anatomy Label`], Element := element_key[i, `Element Label`]]
    #Separate out proximal and distal element portions based on presence of later-fusing measurements (e.g., radius bone is proximal/distal based on presence of Bd measurement)
    if(element_key[i, `Element Label`] %in% c("Rad", "Mtc", "Fem", "Mtt")) {
      dataset[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(!is.na(Bd), paste(element_key[i, `Element Label`], "dist", sep = "_"), paste(element_key[i, `Element Label`], "prox", sep = "_"))]
    }
    if(element_key[i, `Element Label`] %in% c("Tib")) {
      dataset[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(!is.na(Bp), paste(element_key[i, `Element Label`], "prox", sep = "_"), paste(element_key[i, `Element Label`], "dist", sep = "_"))]
    }
  }
  #Immature: identify whether specimens COULD be immature based on element portion and fusion status, if relevant
  dataset[Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
  dataset[Element %in% c("Hum", "Cal", "PH1", "PH2"), Immature := as.numeric(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") == F)]
  dataset[Element %in% c("Rad_prox", "Rad_dist", "Mtc_prox", "Mtc_dist", "Mtt_prox", "Mtt_dist"), Immature := as.numeric(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing") == F)]
  dataset[Element %in% c("Fem_prox", "Fem_dist", "Tib_prox", "Tib_dist"), Immature := as.numeric((`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing")) == F)]
  #transform into long-form data
  dataset_longdata <- melt(dataset, id.vars = c("ID", "Site", "Anatomy", "Element", "Proximal Fusion", "Distal Fusion", "Immature"), measure.vars = c("GLP", "Bd", "BT", "Bp", "BFp", "DC", "GB"), variable.name = "Measure", value.name = "Measurement_value")[!is.na(Measurement_value)]
  #Measurement: combine element and measurement names (for measurement sets)
  #goes through element_key to change anatomical part names to the new labels
  #Note: key may have mlutiple Anatomy Labels that fit onto the same `Element Label`
  for(i in 1:nrow(element_key)) {
    dataset_longdata[Anatomy %in% element_key[i, `Anatomy Label`], Measurement := paste(element_key[i, `Element Label`], Measure, sep = "_")]
  }
  #bring in the reference measurement for each value (joined by measurement) and limiting the assemblage to the measurements that we're interested in modeling
  mixmod_data <- dataset_longdata[reference_dataset[, .(Reference_value = Standard, Measurement)], on = c("Measurement")][!is.na(ID) & Measurement %in% included_measurements]
  #Create numeric labels for measurement sets, element portions, and specimens (for Stan modeling)
  mixmod_data[, Measurement_Set := as.numeric(as.factor(Measurement))]
  mixmod_data[, Element_Portion := as.numeric(as.factor(Element))]
  mixmod_data[, Specimen_No := as.numeric(as.factor(ID))]
  #return new dataset
  mixmod_data
}
#List of included measurements
measurement_list <- c("Sca_GLP", "Hum_Bd", "Hum_BT", "Rad_Bp", "Rad_BFp", "Rad_Bd", "Mtc_Bp", "Mtc_Bd", "Fem_DC", "Fem_Bd", "Tib_Bp", "Tib_Bd", "Ast_Bd", "Cal_GB", "Mtt_Bp", "Mtt_Bd", "PH1_Bp")

#Applying the function
pinarbasi_mixmod_data <- assemblage_restructure(pinarbasi_data, sheep_standard_animal, pinarbasi_element_key, included_measurements = measurement_list)
#
barcin_mixmod_data <- assemblage_restructure(barcin_data, bos_standard_animal, barcin_element_key, included_measurements = c(measurement_list, "PH2_Bp"))
ilipinar_mixmod_data <- assemblage_restructure(ilipinar_data, bos_standard_animal, ilipinar_element_key, included_measurements = c(measurement_list, "PH2_Bp"))
mentese_mixmod_data <- assemblage_restructure(mentese_data, bos_standard_animal, mentese_element_key, included_measurements = c(measurement_list, "PH2_Bp"))

####3. Collecting the demographic data####

#Pinarbasi Sheep#
#Use sheep code and sheep/goat code (being liberal, taking all that aren't conclusively goats)
#This undoubtedly includes some goats, but the biases against unfused specimens (which are much more likely to be considered sheep/goat) is judged to be a bigger issue
#This is a modeling choice, however, so can be changed depending on the context
pinarbasi_demographic_observations <- pinarbasi[`Has Biological Taxonomy [Label]` %in% c("Ovis", "Sheep/goat") & `Context (3)` %in% c("Site B"), .(Site = "Pinarbasi B", N_Unfused = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "Proximal epiphysis unfused"), N_Ageable = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "" == F), N_Female = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% "female organism"), N_Sexable = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% c("female organism", "male organism")))]

#NW Anatolian Cattle#
barcin_demographic_observations <- barcin[`Has Biological Taxonomy [Label]` %in% c("Bos taurus Linnaeus, 1758", "Bos primigenius"), .(Site = "Barcin Hoyuk", N_Unfused = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "Proximal epiphysis unfused"), N_Ageable = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "" == F), N_Female = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% "female organism"), N_Sexable = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% c("female organism", "male organism")))]
ilipinar_demographic_observations <- ilipinar[`Has Biological Taxonomy [Label]` %in% c("Bos taurus Linnaeus, 1758", "Bos primigenius", "Bos") & `Period` %in% c("X", "IX", "IX/VIII", "VIII", "VII", "VI", "VI/VA", "VA", "VB"), .(N_Unfused = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "Proximal epiphysis unfused"), N_Ageable = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "" == F), N_Female = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% "female organism"), N_Sexable = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% c("female organism", "male organism"))), .(Site = ifelse(`Period` %in% c("X", "IX", "IX/VIII", "VIII"), "Ilipinar 1 (Late Neolithic/Transitional)", ifelse(`Period` %in% c("VII", "VI", "VI/VA", "VA", "VB"), "Ilipinar 2 (Early Chalcolithic)", NA)))][order(Site)]
mentese_demographic_observations <- mentese[`Has Biological Taxonomy [Label]` %in% c("Bos"), .(Site = "Mentese", N_Unfused = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "Proximal epiphysis unfused"), N_Ageable = sum(`Has anatomical identification [Label]` %in% c("proximal phalanx", "middle phalanx") & `Has fusion character [Proximal Label]` %in% "" == F), N_Female = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% "female organism"), N_Sexable = sum(`Has anatomical identification [Label]` %in% "innominate bone" & `Has physiological sex determination [Label]` %in% c("female organism", "male organism")))]


####Formatting####
#Single Assemblage analysis: add in "Site_No" field (model expects)
pinarbasi_mixmod_data[, Site_No := 1]

#Multisite analysis: Combine the site-level data together, add Site_No field
nw_anatolian_mixmod_data <- rbind(
  data.table(Site_No = 1, barcin_mixmod_data),
  data.table(Site_No = 2, ilipinar_mixmod_data[Site %in% "Ilipinar 1 (Late Neolithic/Transitional)"]),
  data.table(Site_No = 3, mentese_mixmod_data),
  data.table(Site_No = 4, ilipinar_mixmod_data[Site %in% "Ilipinar 2 (Early Chalcolithic)"])
)
#Re-assign numeric codes for element portions, measurement sets, and individual specimens (to prevent mismatches/overlap)
nw_anatolian_mixmod_data[, Measurement_Set := as.numeric(as.factor(Measurement))]
nw_anatolian_mixmod_data[, Element_Portion := as.numeric(as.factor(Element))]
nw_anatolian_mixmod_data[, Specimen_No := as.numeric(as.factor(ID))]

#Combine the demographic data together, add Site_No field
nw_anatolian_demographic_observations <- rbind(
  data.table(Site_No = 1, barcin_demographic_observations),
  data.table(Site_No = 2, ilipinar_demographic_observations[Site %in% "Ilipinar 1 (Late Neolithic/Transitional)"]),
  data.table(Site_No = 3, mentese_demographic_observations),
  data.table(Site_No = 4, ilipinar_demographic_observations[Site %in% "Ilipinar 2 (Early Chalcolithic)"])
)

#

####Constructing modeled (and full) assemblages from OpenContext data for compositional and fusion analyses####
#gather the different assemblages: measured assemblage, assemblage of modeled elements, full assemblage (including unmodeled elements)

#Pinarbasi Sheep#
pinarbasi_additional_elements <- c("innominate bone", "middle phalanx", "ulna") #additional elements for compositional analysis
pinarbasi_measured_assemblage <- pinarbasi_mixmod_data[, .N, .(ID, Specimen_No, Anatomy, Element, Element_Portion, Immature, `Proximal Fusion`, `Distal Fusion`)]
pinarbasi_modeled_assemblage <- pinarbasi[`Has Biological Taxonomy [Label]` %in% "Ovis" & `Context (3)` %in% "Site B" & `Has anatomical identification [Label]` %in% pinarbasi_measured_assemblage[, .N, Anatomy][, Anatomy], .(ID = paste("Pinarbasi B", `Label`, sep = " "), Site = "Pinarbasi B", Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = ifelse(!is.na(`GB (unfused)`) | !is.na(`Bp (unfused)`), "Proximal epiphysis unfused", `Has fusion character [Proximal Label]`), `Distal Fusion` = ifelse(!is.na(`Bd (unfused)`), "Distal epiphysis unfused", `Has fusion character [Distal Label]`))]
pinarbasi_full_assemblage <- pinarbasi[`Has Biological Taxonomy [Label]` %in% "Ovis" & `Context (3)` %in% "Site B" & `Has anatomical identification [Label]` %in% c(pinarbasi_measured_assemblage[, .N, Anatomy][, Anatomy], pinarbasi_additional_elements), .(ID = paste("Pinarbasi B", `Label`, sep = " "), Site = "Pinarbasi B", Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = ifelse(!is.na(`GB (unfused)`) | !is.na(`Bp (unfused)`), "Proximal epiphysis unfused", `Has fusion character [Proximal Label]`), `Distal Fusion` = ifelse(!is.na(`Bd (unfused)`), "Distal epiphysis unfused", `Has fusion character [Distal Label]`))]

#Assign specimen numbers for the specimens that were modeled directly (measured specimens) in the modeled and full assemblages
pinarbasi_modeled_assemblage <- pinarbasi_measured_assemblage[, .(ID, Specimen_No, Element_Portion, Immature)][pinarbasi_modeled_assemblage, on = "ID"]
pinarbasi_full_assemblage <- pinarbasi_measured_assemblage[, .(ID, Specimen_No, Element_Portion, Immature)][pinarbasi_full_assemblage, on = "ID"]

#Assign the element portion numbers for specimens whose element portions were modeled
pinarbasi_full_element_key <- rbind(pinarbasi_element_key,
                                    data.table(`Anatomy Label` = c("innominate bone", "middle phalanx", "ulna"), `Element Label` = c("Pel", "PH2", "Uln")))
for(i in 1:pinarbasi_full_element_key[, .N]) {
  pinarbasi_modeled_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := pinarbasi_full_element_key[i, `Element Label`]]
  pinarbasi_full_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := pinarbasi_full_element_key[i, `Element Label`]]
  #Separate out proximal and distal element portions based on presence of later-fusing measurements (e.g., radius bone is proximal/distal based on presence of Bd measurement)
  if(pinarbasi_full_element_key[i, `Element Label`] %in% c("Rad", "Mtc", "Fem", "Mtt")) {
    pinarbasi_modeled_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := ifelse(`Distal Fusion` %in% "" == F, paste(pinarbasi_full_element_key[i, `Element Label`], "dist", sep = "_"), paste(pinarbasi_full_element_key[i, `Element Label`], "prox", sep = "_"))]
    pinarbasi_full_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := ifelse(`Distal Fusion` %in% "" == F, paste(pinarbasi_full_element_key[i, `Element Label`], "dist", sep = "_"), paste(pinarbasi_full_element_key[i, `Element Label`], "prox", sep = "_"))]
  }
  if(pinarbasi_full_element_key[i, `Element Label`] %in% c("Tib")) {
    pinarbasi_modeled_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := ifelse(`Proximal Fusion` %in% "" == F, paste(pinarbasi_full_element_key[i, `Element Label`], "prox", sep = "_"), paste(pinarbasi_full_element_key[i, `Element Label`], "dist", sep = "_"))]
    pinarbasi_full_assemblage[Anatomy %in% pinarbasi_full_element_key[i, `Anatomy Label`], Element := ifelse(`Proximal Fusion` %in% "" == F, paste(pinarbasi_full_element_key[i, `Element Label`], "prox", sep = "_"), paste(pinarbasi_full_element_key[i, `Element Label`], "dist", sep = "_"))]
  }
}

#Remove unobserved element portions (Rad_prox and Mtc_prox) from modeled assemblage (we don't have direct observations of the parameters from the model)
pinarbasi_modeled_assemblage <- pinarbasi_measured_assemblage[, .N, .(Element_Portion, Element)][, .(Element_Portion, Element)][pinarbasi_modeled_assemblage, on = "Element"][!is.na(Element_Portion)]
pinarbasi_full_assemblage <- pinarbasi_measured_assemblage[, .N, .(Element_Portion, Element)][, .(Element_Portion, Element)][pinarbasi_full_assemblage, on = "Element"]

#Assign new element portion numbers for unmodeled elements (including Rad_prox and Mtc_prox)
pinarbasi_full_assemblage[Element %in% "Rad_prox", Element_Portion := 11]
pinarbasi_full_assemblage[Element %in% "Mtc_prox", Element_Portion := 12]
pinarbasi_full_assemblage[Element %in% "Pel", Element_Portion := 13]
pinarbasi_full_assemblage[Element %in% "PH2", Element_Portion := 14]
pinarbasi_full_assemblage[Element %in% "Uln", Element_Portion := 15]

#Define the Immature variable (potentially immature status based on fusion)
pinarbasi_modeled_assemblage[is.na(Immature) & Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
pinarbasi_modeled_assemblage[is.na(Immature) & Element %in% c("Hum", "Cal", "PH1"), Immature := as.numeric(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") == F)]
pinarbasi_modeled_assemblage[is.na(Immature) & Element %in% c("Rad_prox", "Rad_dist", "Mtc_prox", "Mtc_dist", "Mtt_prox", "Mtt_dist"), Immature := as.numeric(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing") == F)]
pinarbasi_modeled_assemblage[is.na(Immature) & Element %in% c("Fem_prox", "Fem_dist", "Tib_prox", "Tib_dist"), Immature := as.numeric((`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing")) == F)]
#
pinarbasi_full_assemblage[is.na(Immature) & Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
pinarbasi_full_assemblage[is.na(Immature) & Element %in% c("Hum", "Cal", "PH1", "PH2"), Immature := as.numeric(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") == F)]
pinarbasi_full_assemblage[is.na(Immature) & Element %in% c("Rad_prox", "Rad_dist", "Mtc_prox", "Mtc_dist", "Mtt_prox", "Mtt_dist"), Immature := as.numeric(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing") == F)]
pinarbasi_full_assemblage[is.na(Immature) & Element %in% c("Uln", "Pel", "Fem_prox", "Fem_dist", "Tib_prox", "Tib_dist"), Immature := as.numeric((`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing")) == F)]

#NW Anatolian Cattle#
#create full assemblage for fusion analysis
full_assemblage_maker <- function(original_data, biology_code, site_code, mixmod_data, element_list, full_elements, element_key) {
  full_assemblage <- original_data[`Has Biological Taxonomy [Label]` %in% biology_code & `Has anatomical identification [Label]` %in% full_elements, .(ID = paste(site_code, Label, sep = " "), Site = site_code, Taxon = `Has Biological Taxonomy [Label]`, Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = `Has fusion character [Proximal Label]`, `Distal Fusion` = `Has fusion character [Distal Label]`)]
  #Assign specimen numbers for the specimens that were modeled directly (measured specimens) in the modeled and full assemblages
  full_assemblage <- mixmod_data[, .N, .(ID, Specimen_No, Immature)][full_assemblage, on = "ID"]
  #Assign the element portion labels for specimens that weren't modeled directly (no measurements)
  for(i in 1:element_key[, .N]) {
    full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := element_key[i, `Element Label`]]
    #Separate out proximal and distal element portions based on presence of later-fusing measurements (e.g., radius bone is proximal/distal based on presence of Bd measurement)
    if(element_key[i, `Element Label`] %in% c("Rad", "Mtc", "Fem", "Mtt")) {
      full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(`Distal Fusion` %in% "" == F, paste(element_key[i, `Element Label`], "dist", sep = "_"), paste(element_key[i, `Element Label`], "prox", sep = "_"))]
    }
    if(element_key[i, `Element Label`] %in% c("Tib")) {
      full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(`Proximal Fusion` %in% "" == F, paste(element_key[i, `Element Label`], "prox", sep = "_"), paste(element_key[i, `Element Label`], "dist", sep = "_"))]
    }
  }
  #Assign Element_Portion values that match the original sets (and add new ones for unmodeled element portions)
  full_assemblage <- element_list[, .N, .(Element, Element_Portion)][full_assemblage, on = "Element"]
  full_assemblage[Element %in% "Pel", Element_Portion := 17]
  full_assemblage[Element %in% "Uln", Element_Portion := 18]
  #Get the Immature variable (potentially immature status based on fusion)
  full_assemblage[is.na(Immature) & Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
  full_assemblage[is.na(Immature) & Element %in% c("Hum", "Cal", "PH1", "PH2"), Immature := as.numeric(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") == F)]
  full_assemblage[is.na(Immature) & Element %in% c("Rad_prox", "Rad_dist", "Mtc_prox", "Mtc_dist", "Mtt_prox", "Mtt_dist"), Immature := as.numeric(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing") == F)]
  full_assemblage[is.na(Immature) & Element %in% c("Uln", "Pel", "Fem_prox", "Fem_dist", "Tib_prox", "Tib_dist"), Immature := as.numeric((`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing")) == F)]
  #
  full_assemblage[, .(ID, Specimen_No, Site, Taxon, Anatomy, Element, Element_Portion, Immature, `Proximal Fusion`, `Distal Fusion`)]
}

nw_anatolian_additional_elements <- c("innominate bone", "ulna") #additional elements for fusion analysis

barcin_full_assemblage <- full_assemblage_maker(original_data = barcin, biology_code = c("Bos taurus Linnaeus, 1758", "Bos primigenius"), site_code = "Barcin", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Barcin"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements, "fused metacarpal bones 3 and 4; metacarpal bone of digit 3; metacarpal bone of digit 4; metacarpal bone of digit 5", "metatarsal bone of digit 5; metatarsal bone of digit 2; fused metatarsal bones 3 and 4"), element_key = rbind(barcin_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
ilipinar1_full_assemblage <- full_assemblage_maker(original_data = ilipinar[Period %in% c("X", "IX", "IX/VIII", "VIII", "VII")], biology_code = c("Bos taurus Linnaeus, 1758", "Bos", "Bos primigenius"), site_code = "Ilipinar", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Ilipinar 1 (Late Neolithic/Transitional)"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(ilipinar_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
ilipinar2_full_assemblage <- full_assemblage_maker(original_data = ilipinar[Period %in% c("VI", "VI/VA", "VA", "VB")], biology_code = c("Bos taurus Linnaeus, 1758", "Bos", "Bos primigenius"), site_code = "Ilipinar", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Ilipinar 2 (Early Chalcolithic)"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(ilipinar_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
mentese_full_assemblage <- full_assemblage_maker(original_data = mentese, biology_code = "Bos", site_code = "Mentese", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Mentese"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(mentese_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))

#Troubleshooting
ilipinar1_full_assemblage[, Site := "Ilipinar 1 (Late Neolithic/Transitional)"]
ilipinar2_full_assemblage[, Site := "Ilipinar 2 (Early Chalcolithic)"]
mentese_full_assemblage[Anatomy %in% "calcaneus", `Proximal Fusion` := ifelse(`Distal Fusion` %in% "Distal epiphysis unfused", "Proximal epiphysis unfused", ifelse(`Distal Fusion` %in% "Distal epiphysis fusing", "Proximal epiphysis fusing", ifelse(`Distal Fusion` %in% "Distal epiphysis fused", "Proximal epiphysis fused", ifelse(`Distal Fusion` %in% "", "", NA))))] #calcaneus fusion is listed as `Distal Fusion` but is `Proximal Fusion` in other sites/codes

#Turn the full assemblages into "fusion assemblages" of specimens with fusion data#
#Key that fits specimens into fusion stages (based on fusion timing in Grigson (1989))
bos_element_stage_key <- data.table(Fusion_Element = c("Rad_prox", "Hum_dist", "Pel", "Sca", "PH1", "PH2", "Tib_dist", "Mtc_dist", "Mtt_dist", "Cal", "Fem_prox", "Fem_dist", "Uln", "Rad_dist", "Tib_prox", "Hum_prox"),
                                Stage = c(1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4))
#
fusion_assemblage_maker <- function(full_assemblage, element_stage_key) {
  full_assemblage[Element %in% "Rad_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Rad_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Hum" & `Distal Fusion` %in% "" == F & `Proximal Fusion` %in% "", c("Fusion_Element", "Fusion") := .("Hum_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Pel" & (`Proximal Fusion` %in% "" == F | `Distal Fusion` %in% "" == F), c("Fusion_Element", "Fusion") := .("Pel", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Sca" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Sca", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "PH1" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("PH1", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "PH2" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("PH2", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Tib_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Tib_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Mtc_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Mtc_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Mtt_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Mtt_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Cal" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Cal", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Fem_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Fem_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Fem_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Fem_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Uln" & (`Proximal Fusion` %in% "" == F | `Distal Fusion` %in% "" == F), c("Fusion_Element", "Fusion") := .("Uln", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Rad_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Rad_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Tib_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Tib_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Hum" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Hum_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  fusion_assemblage <- full_assemblage[, .(ID, Specimen_No, Site, Anatomy, Element, Element_Portion, Immature, `Proximal Fusion`, `Distal Fusion`, Fusion_Element, Fusion)][element_stage_key, on = "Fusion_Element"][!is.na(Fusion_Element) & !is.na(Fusion)]
  fusion_assemblage
}

#Create the fusion assemblages
barcin_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = barcin_full_assemblage, element_stage_key = bos_element_stage_key)
ilipinar1_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = ilipinar1_full_assemblage, element_stage_key = bos_element_stage_key)
mentese_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = mentese_full_assemblage, element_stage_key = bos_element_stage_key)
ilipinar2_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = ilipinar2_full_assemblage, element_stage_key = bos_element_stage_key)
```

```{r making figure 4, include = FALSE, eval = TRUE}
#Create map of sites (Figure 4)
world <- ne_countries(scale = "medium", returnclass = "sf") #for visualization/examining spatial trends
#

site_locations <- rbind(
  pinarbasi[`Context (3)` %in% "Site B", .(Site = "Pinarbaşı B", .N), .(Latitude = `Latitude (WGS-84)`, Longitude = `Longitude (WGS-84)`)],
  barcin[, .(Site = "Barcın Höyük", .N), .(Latitude = `Latitude (WGS-84)`, Longitude = `Longitude (WGS-84)`)],
  ilipinar[, .(Site = "Ilıpınar Höyük", .N), .(Latitude = `Latitude (WGS-84)`, Longitude = `Longitude (WGS-84)`)],
  mentese[, .(Site = "Menteşe Höyük", .N), .(Latitude = `Latitude (WGS-84)`, Longitude = `Longitude (WGS-84)`)]
)
#
figure_4 <- ggplot(data = world) + geom_sf(color = "black", fill = "grey80") +
  coord_sf(xlim = c(25, 40), ylim = c(36, 42), expand = TRUE) +
  geom_point(data = site_locations, aes(x = Longitude, y = Latitude)) +
  geom_label_repel(data = site_locations, aes(x = Longitude, y = Latitude, label = Site), min.segment.length = 0, point.padding = 0.5, segment.color = "black") + theme_bw()
#
Cairo(width = 5, height = 5, units = "in", file = "./Output/Figures/figure_4.png", type = "png", dpi = 600)
figure_4
dev.off()
```

```{r making tables 2 and 3, include = FALSE, eval = TRUE}
#Summarize the archaeological data for in-text numbers (and Table 2)
archaeological_sites_summary <- list(
  pinarbasi_msres_N = pinarbasi_mixmod_data[, .N],
  pinarbasi_specimens_N = pinarbasi_mixmod_data[, .N, Specimen_No][, .N],
  pinarbasi_age_observation = pinarbasi_demographic_observations[, ifelse(N_Ageable > 0, paste0(N_Unfused, " / ", N_Ageable, " (", round(100 * (N_Unfused / N_Ageable), 0), "%)"), paste0(N_Unfused, " / ", N_Ageable))],
  pinarbasi_sexable_pelves_N = pinarbasi_demographic_observations[, N_Sexable],
  pinarbasi_sex_observation = pinarbasi_demographic_observations[, ifelse(N_Sexable > 0, paste0(N_Female, " / ", N_Sexable, " (", round(100 * (N_Female / N_Sexable), 0), "%)"), paste0(N_Female, " / ", N_Sexable))],
  #
  nw_anatolian_cattle_specimens_N = nw_anatolian_mixmod_data[, .N, Specimen_No][, .N],
  barcin_specimens_N = nw_anatolian_mixmod_data[Site_No %in% 1, .N, Specimen_No][, .N],
  ilipinar1_specimens_N = nw_anatolian_mixmod_data[Site_No %in% 2, .N, Specimen_No][, .N],
  mentese_specimens_N = nw_anatolian_mixmod_data[Site_No %in% 3, .N, Specimen_No][, .N],
  ilipinar2_specimens_N = nw_anatolian_mixmod_data[Site_No %in% 4, .N, Specimen_No][, .N],
  ilipinar_measured_bos_primigenius_N = ilipinar_data[Taxon %in% "Bos primigenius", .N],
  ilipinar_measured_bos_spp_N = ilipinar_data[Taxon %in% "Bos", .N],
  ilipinar_full_bos_primigenius_N = ilipinar1_full_assemblage[Taxon %in% "Bos primigenius", .N] + ilipinar2_full_assemblage[Taxon %in% "Bos primigenius", .N],
  ilipinar_full_bos_spp_N = ilipinar1_full_assemblage[Taxon %in% "Bos", .N] + ilipinar2_full_assemblage[Taxon %in% "Bos", .N],
  barcin_age_observation = nw_anatolian_demographic_observations[Site_No %in% 1, ifelse(N_Ageable > 0, paste0(N_Unfused, " / ", N_Ageable, " (", round(100 * (N_Unfused / N_Ageable), 0), "%)"), paste0(N_Unfused, " / ", N_Ageable))],
  ilipinar1_age_observation = nw_anatolian_demographic_observations[Site_No %in% 2, ifelse(N_Ageable > 0, paste0(N_Unfused, " / ", N_Ageable, " (", round(100 * (N_Unfused / N_Ageable), 0), "%)"), paste0(N_Unfused, " / ", N_Ageable))],
  mentese_age_observation = nw_anatolian_demographic_observations[Site_No %in% 3, ifelse(N_Ageable > 0, paste0(N_Unfused, " / ", N_Ageable, " (", round(100 * (N_Unfused / N_Ageable), 0), "%)"), paste0(N_Unfused, " / ", N_Ageable))],
  ilipinar2_age_observation = nw_anatolian_demographic_observations[Site_No %in% 4, ifelse(N_Ageable > 0, paste0(N_Unfused, " / ", N_Ageable, " (", round(100 * (N_Unfused / N_Ageable), 0), "%)"), paste0(N_Unfused, " / ", N_Ageable))],
  barcin_sex_observation = nw_anatolian_demographic_observations[Site_No %in% 1, ifelse(N_Sexable > 0, paste0(N_Female, " / ", N_Sexable, " (", round(100 * (N_Female / N_Sexable), 0), "%)"), paste0(N_Female, " / ", N_Sexable))],
  ilipinar1_sex_observation = nw_anatolian_demographic_observations[Site_No %in% 2, ifelse(N_Sexable > 0, paste0(N_Female, " / ", N_Sexable, " (", round(100 * (N_Female / N_Sexable), 0), "%)"), paste0(N_Female, " / ", N_Sexable))],
  mentese_sex_observation = nw_anatolian_demographic_observations[Site_No %in% 3, ifelse(N_Sexable > 0, paste0(N_Female, " / ", N_Sexable, " (", round(100 * (N_Female / N_Sexable), 0), "%)"), paste0(N_Female, " / ", N_Sexable))],
  ilipinar2_sex_observation = nw_anatolian_demographic_observations[Site_No %in% 4, ifelse(N_Sexable > 0, paste0(N_Female, " / ", N_Sexable, " (", round(100 * (N_Female / N_Sexable), 0), "%)"), paste0(N_Female, " / ", N_Sexable))]
)

####Summarize the elemental composition of the archaeological assemblages####
table_4 <- pinarbasi_mixmod_data[, .N, .(Element_Portion, Element, Measurement = tstrsplit(Measurement, "_")[[2]])][order(Element_Portion), .(`Element Portion` = c("Astragalus", "Calcaneus", "Humerus", "Metacarpal (Distal)", "Metatarsal (Distal)", "Metatarsal (Proximal)", "First Phalanx", "Radius (Distal)", "Tibia (Distal)", "Tibia (Proximal)"), Measurement, N)]
table_5 <- data.table(reshape2::dcast(nw_anatolian_mixmod_data[, .N, .(Element_Portion, Element, Site_No, Site)][order(Site_No, Element), .(Element, Site, N)], Element ~ Site, fun.aggregate = sum, value.var = "N", fill = 0, margins = "Element"))[, .(`Element Portion` = c("Astragalus", "Calcaneus", "Femur (Distal)", "Femur (Proximal)", "Humerus", "Metacarpal (Distal)", "Metacarpal (Proximal)", "Metatarsal (Distal)", "Metatarsal (Proximal)", "First Phalanx", "Second Phalanx", "Radius (Distal)", "Radius (Proximal)", "Scapula", "Tibia (Distal)", "Tibia (Proximal)", "Total"), `Barcın Höyük` = Barcin, `Ilıpınar Höyük (Late Neolithic/Transitional)` = `Ilipinar 1 (Late Neolithic/Transitional)`, `Ilıpınar Höyük (Early Chalcolithic)` = `Ilipinar 2 (Early Chalcolithic)`, `Menteşe Höyük` = Mentese)]
```

The Bayesian multilevel mixture model is applied to two archaeological case studies to showcase the utility of the model for both interpreting a single assemblage and examining multiple assemblages. In both case studies, the sheep and cattle measurements have been previously published on OpenContext and the general zooarchaeological summaries of the assemblages have been published, as well [@carruthers_pinarbasi_data; @buitenhuis_ilipinar_data; @galik_barcin_data; @gourichon_helmer_mentese_data; @carruthers_2005; @gerritsen_ozbal_2019; @gourichon_helmer_2008; @buitenhuis_2008]. Again, $\operatorname{LSI}_e$ values are calculated using the same standard animal as the simulation analysis for the single assemblage analysis, the *Ovis orientalis* female standard animal (FMC 57951) from Uerpmann and Uerpmann [-@uerpmann_uerpmann_1994: Table 12] and the *Bos primigenius* female standard animal [Ullerslev: @degerbol_1970; @grigson_1989], operationalized through 'zoolog' functions [@zoolog]. Alongside metric data, the OpenContext faunal tables provide demographic data that can be used to observe relevant estimates of the age and sex composition of the assemblages. The goal of applying the mixture model to these assemblages, then, is to use the metric data to improve these estimates of the age and sex composition of the assemblage, biometric estimates, and sex-specific fusion rates.

#### *3.2.1 Single Assemblage: Biometric Analysis of Sheep from 7th Millennium BCE Central Anatolia (Pinarbaşı B)*\

The site of Pinarbaşı, located in the Konya Plain of central Turkey, consists of a series of rock shelter and open-air sites at the foothills of the Karadag volcanic region and Lake Hotamis and associated wetlands [@baird_etal_2013; @kabukcu_2017]. This case study examines the Pinarbaşı B late Neolithic occupation, which is dated to the second half of the 7th millennium BCE and includes a large number of domesticated sheep and goat remains (?). @carruthers_2005 analyzed fauna from the 1994-1995 excavations by Trevor Watkins [@watkins_1996], interpreting the presence of fetal sheep remains and other juvenile remains in the assemblage as evidence for herders penning sheep on-site. The Neolithic assemblage was thus described as the result of seasonal occupation by sheep and goat herders during the lambing season and the fall, with culling in the spring possibly focused on young males [@carruthers_2005]. This analysis makes several claims that can be evaluated with the Bayesian multilevel mixture model: the dominance of immature remains, a female-dominated adult sex ratio, and sex-specific differences in fusion rates for later-fusing elements.

The Bayesian multilevel mixture model for the late Neolithic Pinarbaşı B assemblage uses `r archaeological_sites_summary$pinarbasi_msres_N` sheep measurements from `r archaeological_sites_summary$pinarbasi_specimens_N` specimens (see Table 4). In addition to these measurements, the observed proportion of immature animals from unfused first and second phalanges is `r archaeological_sites_summary$pinarbasi_age_observation`, including specimens identified to sheep and to sheep/goat. There are `r archaeological_sites_summary$pinarbasi_sexable_pelves_N` observed sheep (or sheep/goat) pelvis bones with sex identifications; this is entered into the model by having an observed adult sex ratio for the assemblage of `r archaeological_sites_summary$pinarbasi_sex_observation` (females / females + males). All data come from the Pinarbaşı faunal assemblage uploaded to OpenContext, focusing only on specimens in the Site B Neolithic contexts [@carruthers_pinarbasi_data]. The Pinarbaşı B sheep model uses the same prior distribution definitions for the model hyper-parameters as the single assemblage simulation since both models, even though the sheep body sizes likely differ between the two populations, showcasing the flexibility of the standard prior distribution definitions.

```{r table_4, echo = FALSE}
kbl(table_4, caption = "Elemental Composition of the Pinarbaşı B Assemblage", booktabs = T, linesep = '') %>%
  kable_styling(latex_options = c("hold_position"))
```

#### *3.2.2 Multiple Assemblages: Biometric Analysis of Cattle from 7th-6th Milennium BCE Northwest Anatolia (Barcın Höyük, Ilıpınar Höyük, Menteşe Höyük)*\

Understanding the development of Neolithic communities in northwestern Anatolia has long been of interest for researchers interested in studying the spread of agricultural lifeways from southwest Asia into Europe [e.g., @cakirlar_2013; @karul_2019; @ozdogan_2011; @ozdogan_2019]. Agricultural communities first appear in the Marmara region in the mid-seventh millennium BCE in sites like Barcın Höyük [@gerritsen_ozbal_2019; @karul_2019]. The domestic animal economies of these Late Neolithic and Early Chalcolithic communities appears to be focused on cattle and caprine (sheep and goat) herding, rather than pig husbandry [@buitenhuis_2008; @cakirlar_2013; @gourichon_helmer_2008]. Milk residues on pottery recovered from these sites suggest that these communities regularly consumed milk, potentially orienting herd management strategies of sheep, goats, and particularly cattle to specialize in milk production [@evershed_etal_2008; @thissen_etal_2010].

```{r figure_4 (map), echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Map of archaeological sites included in this analysis"}
knitr::include_graphics("./Output/Figures/figure_4.png")
```

Four archaeological components from three sites are used in this case study, located near Lake Iznik and on the Yenisehir Plain in the Bursa province of Turkey (Figure 4). The Neolithic layers from Barcın Höyük (Phase VI) is the earliest of these assemblages, with occupation roughly from 6500-6000 cal BCE; excavations revealed a subsistence economy focused on cereal agriculture and the herding of cattle, sheep, and goat [@galik_barcin_data; @gerritsen_ozbal_2019]. Menteşe Höyük is located approximately five km west of Barcın Höyük on the Yenisehir Plain; the three Neolithic layers at the site date to 5800-5600 cal BCE [@gourichon_helmer_mentese_data; @roodenberg_etal_2003]. Previous faunal analysis of the Neolithic assemblage identified animal economies that shifted from predominantly cattle to sheep herding over the course of the occupation [@gourichon_helmer_2008]. Ilıpınar Höyük is located near Lake Iznik, separated from the Yenisehir Plain by a mountain ridge [@roodenberg_2012_article]. The Neolithic/Early Chalcolithic occupation of the site spanned 6200-5400 cal BCE [@buitenhuis_ilipinar_data]; I divided the assemblage is into two sub-assemblages (Neolithic Ilıpınar = Phases X-VII, 6000-5700 cal BCE; Chalcolithic Ilıpınar = Phases VI-V, 5600-5400 cal BCE), marked by the introduction of mudbrick architecture and expanded storage [@roodenberg_2012_article; @roodenberg_2012_handbook]. Sheep and goat are common in the earlier assemblages of the site, with cattle becoming predominate in later phases of the site [@buitenhuis_2008; @roodenberg_2012_article]. Notably for this biometric analysis, @buitenhuis_2008 notes that cattle body sizes are stable throughout the Neolithic layers.

The northwest Anatolian cattle bone assemblages consists of `r archaeological_sites_summary$nw_anatolian_cattle_specimens_N` measured specimens spread unevenly across the four components (Barcın Höyük N = `r archaeological_sites_summary$barcin_specimens_N`, Menteşe Höyük N = `r archaeological_sites_summary$mentese_specimens_N`, Neolithic Ilıpınar N = `r archaeological_sites_summary$ilipinar1_specimens_N`, Chalcolithic Ilıpınar N = `r archaeological_sites_summary$ilipinar2_specimens_N`). All measured *Bos* remains were included in the analysis, rather than separating out those identified as aurochs (*Bos primigenius*, N = `r archaeological_sites_summary$ilipinar_measured_bos_primigenius_N`) or identified only to *Bos* spp. (N = `r archaeological_sites_summary$ilipinar_measured_bos_spp_N`) in the Ilıpınar Höyük dataset; all specimens were only labeled as “Bos” in the Menteşe Höyük dataset. Table 5 shows the measurement composition of the four northwest Anatolian assemblages. Demographic observations of the proportion of immature animals and the adult sex ratio for each assemblage describe these assemblage-level parameters. For the four northwest Anatolian assemblages, estimates of the assemblage-level proportion of immature specimens based on the fusion rates of proximal and middle phalanges for cattle specimens are `r archaeological_sites_summary$barcin_age_observation` for Barcın Höyük, `r archaeological_sites_summary$ilipinar1_age_observation` for Neolithic Ilıpınar, `r archaeological_sites_summary$mentese_age_observation` for Menteşe Höyük, and `r archaeological_sites_summary$ilipinar2_age_observation` for Chalcolithic Ilıpınar. The observed adult sex ratios (females / females + males) based on cattle pelvis morphology are `r archaeological_sites_summary$barcin_sex_observation` for Barcın Höyük, `r archaeological_sites_summary$ilipinar1_sex_observation` for Neolithic Ilıpınar, `r archaeological_sites_summary$mentese_sex_observation` for Menteşe Höyük, and `r archaeological_sites_summary$ilipinar2_sex_observation` for Chalcolithic Ilıpınar. As in the Pinarbaşı B example, observations of 0 / 0 impart no information onto the prior distribution of the adult sex ratio. All demographic and measurement data come from the OpenContext datasets [@buitenhuis_ilipinar_data; @galik_barcin_data; @gourichon_helmer_mentese_data]; the ‘R script for replication’ includes the steps for data processing and analysis.

```{r table_5, echo = FALSE}
kbl(table_5, caption = "Elemental Composition of the Northwest Anatolian Cattle Assemblages", booktabs = T, linesep = '') %>%
  kable_styling(latex_options = c("hold_position", "scale_down")) %>%
  row_spec(nrow(table_5), bold = TRUE)
```

Previous syntheses of the Late Neolithic and Early Chalcolithic animal economies in northwest Anatolia provide several assumptions about the age and sex structure of cattle bone assemblages that can be evaluated with the results of the Bayesian multilevel mixture model. First, the general cultural continuity of the assemblages suggests that the biometry and composition of cattle bone assemblages may be similar at the sites, having been produced by similar processes [e.g., @cakirlar_2013; @ozdogan_2019]. Second, the widespread evidence of milk consumption from pottery residue analyses from these sites and others in the region [@evershed_etal_2008; @thissen_etal_2010] suggest that cattle were managed for milk production [@gourichon_helmer_2008; @roodenberg_2012_article]; thus, one may expect that each assemblage has a female-dominated sex ratio and potentially higher fusion rates for later-fusing elements among females than males. The multilevel modeling results can be used to evaluate the feasibility of these assumptions by examining posterior distributions of relevant parameters and simulations of sex-specific fusion rates.

Because the model is a multisite model and deals with a different taxon than the original simulations, the prior distributions for the model hyper-parameters are again redefined to reflect different expectations of biological feasibility. While the multisite simulation provides useful prior distribution definitions for most of the parameters, two other parameters (average body size of females $\mu_2$ and index of sexual dimorphism $\log(\delta_2)$) should be further changed because of different expectations modeling cattle rather than sheep. The change in the prior distribution definition of $\mu_2$ reflects the fact that the standard measurements for cattle come from an aurochs female [@degerbol_1970], which is expected to be larger than the domestic cattle females in the assemblages. Cattle are expected to be more sexually dimorphic than sheep, which is reflected in increasing the average expected value of $\log(\delta_2)$, resulting in an expectation of `r round(exp(-2), 2)` $\operatorname{LSI}_e$ units between males and females on average. This is slightly lower than index of sexual dimorphism seen in the @degerbol_1970 aurochs specimens [@grigson_1989, Figure 2, which uses $\operatorname{LSI}_{10}$; the equivalent size difference is `r round(log(1 + exp(-2), base = 10), 2)` on the $\operatorname{LSI}_{10}$ scale], though domestic cattle may be expected to be less seuxally dimorphic than their wild counterparts [e.g., @tchernov_horwitz_1991].

*Prior Distribution Definitions for the Northwest Anatolian Cattle Model Hyper-Parameters*
\begin{equation}
\begin{split}
\theta_1 & \sim \operatorname{Normal}(-0.5, 1.5) \\
\theta_2 & \sim \operatorname{Normal}(0.0, 1.5) \\
\mu_2 & \sim \operatorname{Normal}(-0.1, 0.1) \\
\log \delta_1 & \sim \operatorname{Normal}(-3.5, 0.5) \\
\log \delta_2 & \sim \operatorname{Normal}(-2.0, 0.5) \\
\log \sigma_1 & \sim \operatorname{Normal}(-3.05, 0.25) \\
\log \sigma_2 & \sim \operatorname{Normal}(-3.10, 0.2) \\
\log \sigma_3 & \sim \operatorname{Normal}(-3.10, 0.2)
\end{split}
\end{equation}

## 4. RESULTS

### *4.1 Simulated Assemblages*

```{r simulation: single assemblage stanfit, include = FALSE, eval = TRUE}
#Single Assemblage Analysis
single_assemblage_mixmod_standata <- list(
  #Sample sizes
  N_Specimens = single_assemblage_mixmod_data[, .N, Specimen_No][, .N],
  N_Measurements = single_assemblage_mixmod_data[, .N],
  N_Element_Portions = single_assemblage_mixmod_data[, .N, Element_Portion][, .N],
  N_Measurement_Sets = single_assemblage_mixmod_data[, .N, Measurement_Set][, .N],
  #Specimen observations
  Element_Portion = single_assemblage_mixmod_data[, .N, .(Specimen_No, Element_Portion, Immature)][order(Specimen_No), Element_Portion],
  Immature = single_assemblage_mixmod_data[, .N, .(Specimen_No, Element_Portion, Immature)][order(Specimen_No), Immature],
  Immature_Proportion = as.matrix(dcast(single_assemblage_mixmod_data[, .(Immature_Proportion = mean(Immature)), .(Site_No, Element_Portion)], Site_No ~ Element_Portion, value.var = "Immature_Proportion", fill = 0))[, 2:(single_assemblage_mixmod_data[, .N, Element_Portion][, .N] + 1)],
  #Measurement observations
  Measurement_obs = single_assemblage_mixmod_data[, Measurement_value],
  Measurement_sd = single_assemblage_mixmod_data[, Measurement_value * 0.01], #Calculate measurement error for observed measurements and reference data (1% based on data from Breslawksi and Byers 2015)
  Reference_obs = single_assemblage_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value],
  Reference_sd = single_assemblage_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value * 0.01],
  Measurement_Set = single_assemblage_mixmod_data[, Measurement_Set],
  Specimen = single_assemblage_mixmod_data[, Specimen_No],
  #Demographic observations
  Immature_obs = single_assemblage_demographic_observations[, N_Unfused],
  Immature_obs_n = single_assemblage_demographic_observations[, N_Ageable],
  Female_obs = single_assemblage_demographic_observations[, N_Female],
  Female_obs_n = single_assemblage_demographic_observations[, N_Sexable],
  #Prior distributions for hyper-parameters
  prior_theta_raw_1 = c(-0.5, 1.5),
  prior_theta_raw_2 = c(0, 1.5),
  prior_mu_female = c(0, 0.1),
  prior_logdelta_immature = c(-3.5, 0.4),
  prior_logdelta_male = c(-2.7, 0.1),
  prior_logsigma_immature = c(-3.05, 0.1),
  prior_logsigma_female = c(-3.1, 0.1),
  prior_logsigma_male = c(-3.1, 0.1)
)
singlesite_mixture_stanmodel <- cmdstan_model("./Scripts/LSI_mixture_model_singlesite.stan")
single_assemblage_samples <- singlesite_mixture_stanmodel$sample(
  data = single_assemblage_mixmod_standata,
  chains = 4,
  parallel_chains = 4,
  refresh = 250,
  seed = 1303894618, #change seed to generalize/if the data are changed
  adapt_delta = 0.90,
  max_treedepth = 15
)
single_assemblage_stanfit <- rstan::read_stan_csv(single_assemblage_samples$output_files())
single_assemblage_post <- extract(single_assemblage_stanfit)
```

```{r simulation: multisite stanfit, include = FALSE, eval = TRUE}
#Multisite Analysis
multisite_mixmod_standata <- list(
  #Sample sizes
  N_Sites = multisite_mixmod_data[, .N, Site_No][, .N],
  N_Specimens = multisite_mixmod_data[, .N, Specimen_No][, .N],
  N_Measurements = multisite_mixmod_data[, .N],
  N_Element_Portions = multisite_mixmod_data[, .N, Element_Portion][, .N],
  N_Measurement_Sets = multisite_mixmod_data[, .N, Measurement_Set][, .N],
  #Specimen observations
  Site = multisite_mixmod_data[, .N, .(Specimen_No, Element_Portion, Site_No, Immature)][order(Specimen_No), Site_No],
  Element_Portion = multisite_mixmod_data[, .N, .(Specimen_No, Element_Portion, Site_No, Immature)][order(Specimen_No), Element_Portion],
  Immature = multisite_mixmod_data[, .N, .(Specimen_No, Element_Portion, Site_No, Immature)][order(Specimen_No), Immature],
  Immature_Proportion = as.matrix(dcast(multisite_mixmod_data[, .(Immature_Proportion = mean(Immature)), .(Site_No, Element_Portion)], Site_No ~ Element_Portion, value.var = "Immature_Proportion", fill = 0))[, 2:(multisite_mixmod_data[, .N, Element_Portion][, .N] + 1)],
  #Measurement observations
  Measurement_obs = multisite_mixmod_data[, Measurement_value],
  Measurement_sd = multisite_mixmod_data[, Measurement_value * 0.01], #Calculate measurement error for observed measurements and reference data (1% based on data from Breslawksi and Byers 2015)
  Reference_obs = multisite_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value],
  Reference_sd = multisite_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value * 0.01],
  Measurement_Set = multisite_mixmod_data[, Measurement_Set],
  Specimen = multisite_mixmod_data[, Specimen_No],
  #Demographic observations
  N_Immature_obs = multisite_demographic_observations[, .N],
  Immature_obs_site = multisite_demographic_observations[, Site_No],
  Immature_obs = multisite_demographic_observations[, N_Unfused],
  Immature_obs_n = multisite_demographic_observations[, N_Ageable],
  N_Female_obs = multisite_demographic_observations[, .N],
  Female_obs_site = multisite_demographic_observations[, Site_No],
  Female_obs = multisite_demographic_observations[, N_Female],
  Female_obs_n = multisite_demographic_observations[, N_Sexable],
  #Prior distributions for hyper-parameters
  prior_theta_raw_1 = c(-0.5, 1.5),
  prior_theta_raw_2 = c(0, 1.5),
  prior_mu_female = c(0, 0.2),
  prior_logdelta_immature = c(-3.5, 0.5),
  prior_logdelta_male = c(-2.7, 0.5),
  prior_logsigma_immature = c(-3.05, 0.25),
  prior_logsigma_female = c(-3.1, 0.2),
  prior_logsigma_male = c(-3.1, 0.2)
)
LSI_multisite_model <- cmdstan_model("./Scripts/LSI_mixture_model_multisite.stan")
multisite_samples <- LSI_multisite_model$sample(
  data = multisite_mixmod_standata,
  chains = 4,
  parallel_chains = 4,
  refresh = 250,
  adapt_delta = 0.80,
  seed = 1963899504,
  max_treedepth = 15
)
multisite_stanfit <- rstan::read_stan_csv(multisite_samples$output_files())
multisite_post <- extract(multisite_stanfit)
```

```{r posterior analysis of simulated assemblages, include = FALSE, eval = TRUE}
####Posterior Analyses####
#Parametric accuracy
parametric_accuracy <- function(true_values, posterior, single_assemblage = T, ci_limit = 0.95) {
  outcome_datatable <- data.table(CI_limit = ci_limit, Total = length(true_values) * true_values[, .N])
  if(single_assemblage) {
    accuracy <- sum(c(
      true_values[, p_immature] >= quantile(posterior$grand_theta[, 1], (1 - ci_limit) / 2) & true_values[, p_immature] <= quantile(posterior$grand_theta[, 1], 1 - (1 - ci_limit) / 2),
      true_values[, p_female] >= quantile(posterior$grand_theta[, 2], (1 - ci_limit) / 2) & true_values[, p_female] <= quantile(posterior$grand_theta[, 2], 1 - (1 - ci_limit) / 2),
      true_values[, p_male] >= quantile(posterior$grand_theta[, 3], (1 - ci_limit) / 2) & true_values[, p_male] <= quantile(posterior$grand_theta[, 3], 1 - (1 - ci_limit) / 2),
      #
      true_values[, mu_immature] >= quantile(posterior$grand_mu_immature, (1 - ci_limit) / 2) & true_values[, mu_immature] <= quantile(posterior$grand_mu_immature, 1 - (1 - ci_limit) / 2),
      true_values[, mu_female] >= quantile(posterior$grand_mu_female, (1 - ci_limit) / 2) & true_values[, mu_female] <= quantile(posterior$grand_mu_female, 1 - (1 - ci_limit) / 2),
      true_values[, mu_male] >= quantile(posterior$grand_mu_male, (1 - ci_limit) / 2) & true_values[, mu_male] <= quantile(posterior$grand_mu_male, 1 - (1 - ci_limit) / 2),
      #
      true_values[, sigma_immature] >= quantile(posterior$grand_sigma_immature, (1 - ci_limit) / 2) & true_values[, sigma_immature] <= quantile(posterior$grand_sigma_immature, 1 - (1 - ci_limit) / 2),
      true_values[, sigma_female] >= quantile(posterior$grand_sigma_female, (1 - ci_limit) / 2) & true_values[, sigma_female] <= quantile(posterior$grand_sigma_female, 1 - (1 - ci_limit) / 2),
      true_values[, sigma_male] >= quantile(posterior$grand_sigma_male, (1 - ci_limit) / 2) & true_values[, sigma_male] <= quantile(posterior$grand_sigma_male, 1 - (1 - ci_limit) / 2)
    ))
  }
  if(!single_assemblage) {
    accuracy <- sum(c(
      sapply(1:15, function(x) true_values[x, p_immature] >= quantile(posterior$site_theta[, 1, x], (1 - ci_limit) / 2) & true_values[x, p_immature] <= quantile(posterior$site_theta[, 1, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, p_female] >= quantile(posterior$site_theta[, 2, x], (1 - ci_limit) / 2) & true_values[x, p_female] <= quantile(posterior$site_theta[, 2, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, p_male] >= quantile(posterior$site_theta[, 3, x], (1 - ci_limit) / 2) & true_values[x, p_male] <= quantile(posterior$site_theta[, 3, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, mu_immature] >= quantile(posterior$site_mu_immature[, x], (1 - ci_limit) / 2) & true_values[x, mu_immature] <= quantile(posterior$site_mu_immature[, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, mu_female] >= quantile(posterior$site_mu_female[, x], (1 - ci_limit) / 2) & true_values[x, mu_female] <= quantile(posterior$site_mu_female[, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, mu_male] >= quantile(posterior$site_mu_male[, x], (1 - ci_limit) / 2) & true_values[x, mu_male] <= quantile(posterior$site_mu_male[, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, sigma_immature] >= quantile(posterior$site_sigma_immature[, x], (1 - ci_limit) / 2) & true_values[x, sigma_immature] <= quantile(posterior$site_sigma_immature[, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, sigma_female] >= quantile(posterior$site_sigma_female[, x], (1 - ci_limit) / 2) & true_values[x, sigma_female] <= quantile(posterior$site_sigma_female[, x], 1 - (1 - ci_limit) / 2)),
      sapply(1:15, function(x) true_values[x, sigma_male] >= quantile(posterior$site_sigma_male[, x], (1 - ci_limit) / 2) & true_values[x, sigma_male] <= quantile(posterior$site_sigma_male[, x], 1 - (1 - ci_limit) / 2))
    ))
  }
  outcome_datatable[, c("Accurate", "Rate") := .(sum(accuracy), round(sum(accuracy) / Total, 2))]
  outcome_datatable[, .(CI_limit, Accurate, Total, Rate)]
}
#parameters are from the Popkin, et al. (2012) Shetland sheep population
true_single_assemblage_parameters <- sheep_mixmod_data[, .(LSI = mean(log(Measurement_value / Reference_value))), .(Specimen_No, Group)][, .(p_immature = mean(Group %in% "Immature"), p_female = mean(Group %in% "Female"), p_male = mean(Group %in% "Male"), mu_immature = mean(LSI[Group %in% "Immature"]), mu_female = mean(LSI[Group %in% "Female"]), mu_male = mean(LSI[Group %in% "Male"]), sigma_immature = sd(LSI[Group %in% "Immature"]), sigma_female = sd(LSI[Group %in% "Female"]), sigma_male = sd(LSI[Group %in% "Male"]))]
#
true_multisite_parameters <- data.table(
  p_immature = rep(c(true_single_assemblage_parameters[, p_immature], 0.20, 0.05), each = 5),
  p_female = rep(c(true_single_assemblage_parameters[, p_female], 0.70, 0.35), each = 5),
  p_male = rep(c(true_single_assemblage_parameters[, p_male], 0.10, 0.60), each = 5),
  mu_immature = rep(true_single_assemblage_parameters[, mu_immature], 15),
  mu_female = rep(true_single_assemblage_parameters[, mu_female], 15),
  mu_male = rep(true_single_assemblage_parameters[, mu_male], 15),
  sigma_immature = rep(true_single_assemblage_parameters[, sigma_immature], 15),
  sigma_female = rep(true_single_assemblage_parameters[, sigma_female], 15),
  sigma_male = rep(true_single_assemblage_parameters[, sigma_male], 15)
)
#size modifications for different simulated assemblages
true_multisite_parameters[c(3, 8, 13), c("mu_immature", "mu_female", "mu_male") :=
                            .(sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 1.20) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Immature", mean(LSI)],
                              sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 1.20) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Female", mean(LSI)],
                              sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 1.20) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Male", mean(LSI)])]
true_multisite_parameters[c(4, 9, 14), c("mu_immature", "mu_female", "mu_male") :=
                            .(sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 0.80) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Immature", mean(LSI)],
                              sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 0.80) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Female", mean(LSI)],
                              sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 0.80) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Male", mean(LSI)])]
true_multisite_parameters[c(5, 10, 15), c("mu_male") :=
                            .(sheep_mixmod_data[, .(Specimen_No, Group, LSI = log((Measurement_value * 1.20) / Reference_value))][, .(LSI = mean(LSI)), .(Specimen_No, Group)][Group %in% "Male", mean(LSI)])]

#calculating accuracy only for site-level means
multisite_site_mu_80CI <- sum(c(
      sapply(1:15, function(x) true_multisite_parameters[x, mu_immature] >= quantile(multisite_post$site_mu_immature[, x], (1 - 0.8) / 2) & true_multisite_parameters[x, mu_immature] <= quantile(multisite_post$site_mu_immature[, x], 1 - (1 - 0.8) / 2)),
      sapply(1:15, function(x) true_multisite_parameters[x, mu_female] >= quantile(multisite_post$site_mu_female[, x], (1 - 0.8) / 2) & true_multisite_parameters[x, mu_female] <= quantile(multisite_post$site_mu_female[, x], 1 - (1 - 0.8) / 2)),
      sapply(1:15, function(x) true_multisite_parameters[x, mu_male] >= quantile(multisite_post$site_mu_male[, x], (1 - 0.8) / 2) & true_multisite_parameters[x, mu_male] <= quantile(multisite_post$site_mu_male[, x], 1 - (1 - 0.8) / 2))
    ))
multisite_site_mu_95CI <- sum(c(
      sapply(1:15, function(x) true_multisite_parameters[x, mu_immature] >= quantile(multisite_post$site_mu_immature[, x], (1 - 0.95) / 2) & true_multisite_parameters[x, mu_immature] <= quantile(multisite_post$site_mu_immature[, x], 1 - (1 - 0.95) / 2)),
      sapply(1:15, function(x) true_multisite_parameters[x, mu_female] >= quantile(multisite_post$site_mu_female[, x], (1 - 0.95) / 2) & true_multisite_parameters[x, mu_female] <= quantile(multisite_post$site_mu_female[, x], 1 - (1 - 0.95) / 2)),
      sapply(1:15, function(x) true_multisite_parameters[x, mu_male] >= quantile(multisite_post$site_mu_male[, x], (1 - 0.95) / 2) & true_multisite_parameters[x, mu_male] <= quantile(multisite_post$site_mu_male[, x], 1 - (1 - 0.95) / 2))
    ))
```

```{r compositional analysis for simulated assemblages, include = FALSE, eval = TRUE}
#equations to simulate a specimen as immature/female/male and count up the composition
ifm_sample <- function(p_immature, p_female, p_male) {
  sample(c("Immature", "Female", "Male"), 1, replace = T, prob = c(p_immature, p_female, p_male))
}
#Simulates the composition of an assemblage with Immature/Female/male probabilities
ifm_composition <- function(measured_specimens) {
  #simulate sex assignments
  measured_specimens[, Simulated_Group := sapply(1:.N, function(x) ifm_sample(p_immature[x], p_female[x], p_male[x]))]
  #counts of the different elements by group (make sure there's a 0 if a value is missing)
  melt(measured_specimens[, .(`Immature` = sum(Simulated_Group %in% "Immature"),
                              `Female` = sum(Simulated_Group %in% "Female"),
                              `Male` = sum(Simulated_Group %in% "Male")), .(Site_No, Element_Portion, Element)], id.vars = c("Site_No", "Element_Portion", "Element"), variable.name = "Simulated_Group", value.name = "N")[order(Site_No, Element_Portion, Simulated_Group)]
}

theta_finder <- function(Specimen_No, Element_Portion, Immature, Immature_Proportions, element_thetas, specimen_probs) {
  thetas <- rep(NA, 3)
  immature_proportion <- Immature_Proportions[Portion %in% Element_Portion, Immature_Proportion]
  thetas[1:3] <- ifelse(rep(!is.na(Specimen_No), 3),
                        specimen_probs[Specimen_No, 1:3],
                        ifelse(rep(Immature == 1, 3),
                               c(element_thetas[1, Element_Portion] / immature_proportion,
                                 element_thetas[2, Element_Portion] * immature_proportion,
                                 element_thetas[3, Element_Portion] * immature_proportion),
                               c(0,
                                 element_thetas[2, Element_Portion] / (1 - min(c(element_thetas[1, Element_Portion], 0.99999))), #fail-safe for extreme values
                                 element_thetas[3, Element_Portion] / (1 - min(c(element_thetas[1, Element_Portion], 0.99999)))))
  )
  list(p_immature = thetas[1] / sum(thetas), p_female = thetas[2] / sum(thetas), p_male = thetas[3] / sum(thetas))
}

#

composition_analysis <- function(composition_data, true_data, site_no = 1, site_title = "") {
  ggplot(composition_data[Site_No %in% site_no, .(N = sum(N)), .(Iteration, Simulated_Group, Element, Element_Portion)][, .(Element, Element_Portion, group = Simulated_Group, Plot_Group = paste(Element, as.numeric(Simulated_Group), sep = "."), N)]) + aes(y = N, x = Plot_Group) +
    stat_slab(normalize = "groups", slab_type = "histogram", breaks = 0:(composition_data[Site_No %in% site_no, .(N = sum(N)), .(Iteration, Simulated_Group, Element, Element_Portion)][, max(N)]), aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.80, 0.95, 1), labels = scales::percent_format())))) +
    stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
    geom_segment(data = true_data[Site_No %in% site_no, .(Count = sum(Count)), .(Element, Element_Portion, Group)][, .(Element, Element_Portion, group = Group, Plot_Group = factor(paste(Element, as.numeric(factor(Group, levels = c("Immature", "Female", "Male"))), sep = ".")), N = Count)][, .(group, Plot_Group, x = as.numeric(Plot_Group) - 0.1, xend = as.numeric(Plot_Group) + 0.75, y = N, yend = N)], aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
    scale_fill_ramp_discrete(name = "Interval", range = c(0.5, 0.15), na.translate = F) +
    scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
    scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
    scale_x_discrete(name = "Element", breaks = composition_data[, .N, .(Element, Element_Portion)][order(Element_Portion), paste(Element, ".2", sep = "")], labels = composition_data[, .N, .(Full_Element_Name, Element_Portion)][order(Element_Portion), Full_Element_Name]) +
    scale_linetype_manual(name = "True Count", values = 1, labels = NULL) +
    scale_y_continuous(name = "Estimated Count") + coord_cartesian(expand = FALSE) +
    labs(title = site_title) +
    theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(angle = 90, size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
}

####Determining the true composition of the measured and modeled assemblages####
single_measured_assemblage_composition <- melt(dcast(single_measured_assemblage[, .N, .(Site_No, Element, Original_Specimen_No, Element_Portion, Group)], Site_No + Group ~ Element_Portion, value.var = "N", fun.aggregate = length), id.vars = c("Group", "Site_No"), variable.name = "Element_Portion", value.name = "Count")
#ensure that every combination is present (add in 0s for missing combinations)
single_measured_assemblage_composition <- single_measured_assemblage_composition[data.table(Site_No = 1, Group = rep(c("Immature", "Female", "Male"), single_assemblage_mixmod_data[, .N, Element_Portion][, .N]), Element_Portion = factor(rep(1:single_assemblage_mixmod_data[, .N, Element_Portion][, .N], each = 3)), Element = rep(single_assemblage_mixmod_data[, .N, .(Element, Element_Portion)][order(Element_Portion), Element], each = 3)), on = c("Site_No", "Group", "Element_Portion")]
single_measured_assemblage_composition[is.na(Count), Count := 0]

#Single assemblage simulation (modeled)
single_modeled_assemblage_composition <- melt(dcast(single_modeled_assemblage[, .N, .(Site_No, Element, Original_Specimen_No, Element_Portion, Group)], Site_No + Group ~ Element_Portion, value.var = "N", fun.aggregate = length), id.vars = c("Group", "Site_No"), variable.name = "Element_Portion", value.name = "Count")
#ensure that every combination is present (add in 0s for missing combinations)
single_modeled_assemblage_composition <- single_modeled_assemblage_composition[data.table(Site_No = 1, Group = rep(c("Immature", "Female", "Male"), single_assemblage_mixmod_data[, .N, Element_Portion][, .N]), Element_Portion = factor(rep(1:single_assemblage_mixmod_data[, .N, Element_Portion][, .N], each = 3)), Element = rep(single_assemblage_mixmod_data[, .N, .(Element, Element_Portion)][order(Element_Portion), Element], each = 3)), on = c("Site_No", "Group", "Element_Portion")]
single_modeled_assemblage_composition[is.na(Count), Count := 0]
single_modeled_assemblage_composition
```

```{r simulation: single assemblage composition analysis, include = FALSE, eval = TRUE}
single_measured_assemblage_immature_proportions <- single_measured_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
single_modeled_assemblage_immature_proportions <- single_modeled_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
#
clusterExport(cl, list('data.table', 'melt', 'ifm_sample', 'theta_finder', 'ifm_composition', 'single_measured_assemblage', 'single_measured_assemblage_immature_proportions', 'single_modeled_assemblage', 'single_modeled_assemblage_immature_proportions', 'single_assemblage_post'))

single_measured_assemblage_simulated_composition <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(single_measured_assemblage[, theta_finder(Specimen_No, Element_Portion, Immature, single_measured_assemblage_immature_proportions, element_thetas = single_assemblage_post$theta[x, , ], specimen_probs = single_assemblage_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
single_modeled_assemblage_simulated_composition <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(single_modeled_assemblage[, theta_finder(Specimen_No, Element_Portion, Immature, single_modeled_assemblage_immature_proportions, element_thetas = single_assemblage_post$theta[x, , ], specimen_probs = single_assemblage_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))

#
single_measured_assemblage_simulated_composition[Element %in% "Ast", Full_Element_Name := "Astragalus"]
single_measured_assemblage_simulated_composition[Element %in% "Fem", Full_Element_Name := "Femur"]
single_measured_assemblage_simulated_composition[Element %in% "Hum", Full_Element_Name := "Humerus"]
single_measured_assemblage_simulated_composition[Element %in% "Mtc", Full_Element_Name := "Metacarpus"]
single_measured_assemblage_simulated_composition[Element %in% "Mtt", Full_Element_Name := "Metatarsus"]
single_measured_assemblage_simulated_composition[Element %in% "Rad", Full_Element_Name := "Radius"]
single_measured_assemblage_simulated_composition[Element %in% "Sca", Full_Element_Name := "Scapula"]
single_measured_assemblage_simulated_composition[Element %in% "Tib", Full_Element_Name := "Tibia"]
#
single_modeled_assemblage_simulated_composition[Element %in% "Ast", Full_Element_Name := "Astragalus"]
single_modeled_assemblage_simulated_composition[Element %in% "Fem", Full_Element_Name := "Femur"]
single_modeled_assemblage_simulated_composition[Element %in% "Hum", Full_Element_Name := "Humerus"]
single_modeled_assemblage_simulated_composition[Element %in% "Mtc", Full_Element_Name := "Metacarpus"]
single_modeled_assemblage_simulated_composition[Element %in% "Mtt", Full_Element_Name := "Metatarsus"]
single_modeled_assemblage_simulated_composition[Element %in% "Rad", Full_Element_Name := "Radius"]
single_modeled_assemblage_simulated_composition[Element %in% "Sca", Full_Element_Name := "Scapula"]
single_modeled_assemblage_simulated_composition[Element %in% "Tib", Full_Element_Name := "Tibia"]
```

```{r simulation: multisite composition analysis, include = FALSE, eval = TRUE}
#Multisite composition analysis#
multisite_measured_assemblage_composition <- melt(dcast(multisite_measured_assemblage[, .N, .(Site_No, Element, Original_Specimen_No, Element_Portion, Group)], Site_No + Group ~ Element_Portion, value.var = "N", fun.aggregate = length), id.vars = c("Group", "Site_No"), variable.name = "Element_Portion", value.name = "Count")
#ensure that every combination is present (add in 0s for missing combinations)
multisite_measured_assemblage_composition <- multisite_measured_assemblage_composition[
  data.table(Site_No = rep(1:multisite_measured_assemblage[, .N, Site_No][, .N], each = 3), Group = rep(c("Immature", "Female", "Male"), multisite_measured_assemblage[, .N, Element_Portion][, .N] * multisite_measured_assemblage[, .N, Site_No][, .N]), Element_Portion = factor(rep(1:multisite_measured_assemblage[, .N, Element_Portion][, .N], each = 3 * multisite_measured_assemblage[, .N, Site_No][, .N])), Element = rep(multisite_measured_assemblage[, .N, .(Element, Element_Portion)][order(Element_Portion), Element], each = 3 * multisite_measured_assemblage[, .N, Site_No][, .N])),
  on = c("Site_No", "Group", "Element_Portion")]
multisite_measured_assemblage_composition[is.na(Count), Count := 0]

#Multisite simulation (modeled)
multisite_modeled_assemblage_composition <- melt(dcast(multisite_modeled_assemblage[, .N, .(Site_No, Element, Original_Specimen_No, Element_Portion, Group)], Site_No + Group ~ Element_Portion, value.var = "N", fun.aggregate = length), id.vars = c("Group", "Site_No"), variable.name = "Element_Portion", value.name = "Count")
#ensure that every combination is present (add in 0s for missing combinations)
multisite_modeled_assemblage_composition <- multisite_modeled_assemblage_composition[
  data.table(Site_No = rep(1:multisite_modeled_assemblage[, .N, Site_No][, .N], each = 3), Group = rep(c("Immature", "Female", "Male"), multisite_modeled_assemblage[, .N, Element_Portion][, .N] * multisite_modeled_assemblage[, .N, Site_No][, .N]), Element_Portion = factor(rep(1:multisite_modeled_assemblage[, .N, Element_Portion][, .N], each = 3 * multisite_modeled_assemblage[, .N, Site_No][, .N])), Element = rep(multisite_modeled_assemblage[, .N, .(Element, Element_Portion)][order(Element_Portion), Element], each = 3 * multisite_modeled_assemblage[, .N, Site_No][, .N])),
  on = c("Site_No", "Group", "Element_Portion")]
multisite_modeled_assemblage_composition[is.na(Count), Count := 0]

#Immature proportions
multisite_measured_assemblage_immature_proportions <- multisite_measured_assemblage[, .(Immature_Proportion = mean(Immature)), .(Site_No, Portion = Element_Portion)][order(Site_No, Portion)]
multisite_modeled_assemblage_immature_proportions <- multisite_modeled_assemblage[, .(Immature_Proportion = mean(Immature)), .(Site_No, Portion = Element_Portion)][order(Site_No, Portion)]
#
clusterExport(cl, list('data.table', 'melt', 'ifm_sample', 'theta_finder', 'ifm_composition', 'multisite_measured_assemblage', 'multisite_measured_assemblage_immature_proportions', 'multisite_modeled_assemblage', 'multisite_modeled_assemblage_immature_proportions', 'multisite_post'))

multisite_measured_assemblage_simulated_composition <- rbind(
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 1, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 1], element_thetas = multisite_post$theta[x, , 1, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 2, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 2], element_thetas = multisite_post$theta[x, , 2, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 2, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 3, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 3], element_thetas = multisite_post$theta[x, , 3, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 3, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 4, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 4], element_thetas = multisite_post$theta[x, , 4, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 4, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 5, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 5], element_thetas = multisite_post$theta[x, , 5, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 5, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 6, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 6], element_thetas = multisite_post$theta[x, , 6, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 6, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 7, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 7], element_thetas = multisite_post$theta[x, , 7, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 7, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 8, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 8], element_thetas = multisite_post$theta[x, , 8, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 8, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 9, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 9], element_thetas = multisite_post$theta[x, , 9, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 9, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 10, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 10], element_thetas = multisite_post$theta[x, , 10, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 10, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 11, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 11], element_thetas = multisite_post$theta[x, , 11, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 11, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 12, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 12], element_thetas = multisite_post$theta[x, , 12, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 12, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 13, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 13], element_thetas = multisite_post$theta[x, , 13, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 13, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 14, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 14], element_thetas = multisite_post$theta[x, , 14, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 14, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_measured_assemblage[Site_No %in% 15, theta_finder(Specimen_No, Element_Portion, Immature, multisite_measured_assemblage_immature_proportions[Site_No %in% 15], element_thetas = multisite_post$theta[x, , 15, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 15, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
)
multisite_modeled_assemblage_simulated_composition <- rbind(
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 1, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 1], element_thetas = multisite_post$theta[x, , 1, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 2, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 2], element_thetas = multisite_post$theta[x, , 2, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 2, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 3, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 3], element_thetas = multisite_post$theta[x, , 3, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 3, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 4, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 4], element_thetas = multisite_post$theta[x, , 4, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 4, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 5, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 5], element_thetas = multisite_post$theta[x, , 5, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 5, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 6, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 6], element_thetas = multisite_post$theta[x, , 6, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 6, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 7, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 7], element_thetas = multisite_post$theta[x, , 7, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 7, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 8, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 8], element_thetas = multisite_post$theta[x, , 8, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 8, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 9, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 9], element_thetas = multisite_post$theta[x, , 9, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 9, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 10, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 10], element_thetas = multisite_post$theta[x, , 10, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 10, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 11, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 11], element_thetas = multisite_post$theta[x, , 11, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 11, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 12, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 12], element_thetas = multisite_post$theta[x, , 12, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 12, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 13, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 13], element_thetas = multisite_post$theta[x, , 13, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 13, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 14, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 14], element_thetas = multisite_post$theta[x, , 14, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 14, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)])),
  rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(multisite_modeled_assemblage[Site_No %in% 15, theta_finder(Specimen_No, Element_Portion, Immature, multisite_modeled_assemblage_immature_proportions[Site_No %in% 15], element_thetas = multisite_post$theta[x, , 15, ], specimen_probs = multisite_post$specimen_prob[x, , ]), .(Original_Specimen_No, Specimen_No, Element, Element_Portion, Immature)][, .(Original_Specimen_No, Specimen_No, Site_No = 15, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
)
#
multisite_measured_assemblage_simulated_composition[Element %in% "Ast", Full_Element_Name := "Astragalus"]
multisite_measured_assemblage_simulated_composition[Element %in% "Fem", Full_Element_Name := "Femur"]
multisite_measured_assemblage_simulated_composition[Element %in% "Hum", Full_Element_Name := "Humerus"]
multisite_measured_assemblage_simulated_composition[Element %in% "Mtc", Full_Element_Name := "Metacarpus"]
multisite_measured_assemblage_simulated_composition[Element %in% "Mtt", Full_Element_Name := "Metatarsus"]
multisite_measured_assemblage_simulated_composition[Element %in% "Rad", Full_Element_Name := "Radius"]
multisite_measured_assemblage_simulated_composition[Element %in% "Sca", Full_Element_Name := "Scapula"]
multisite_measured_assemblage_simulated_composition[Element %in% "Tib", Full_Element_Name := "Tibia"]
#
multisite_modeled_assemblage_simulated_composition[Element %in% "Ast", Full_Element_Name := "Astragalus"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Fem", Full_Element_Name := "Femur"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Hum", Full_Element_Name := "Humerus"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Mtc", Full_Element_Name := "Metacarpus"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Mtt", Full_Element_Name := "Metatarsus"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Rad", Full_Element_Name := "Radius"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Sca", Full_Element_Name := "Scapula"]
multisite_modeled_assemblage_simulated_composition[Element %in% "Tib", Full_Element_Name := "Tibia"]
```

```{r summarizing and making figures, include = FALSE, eval = TRUE}
####Summarizing the simulated assemblage results for in-text reporting####
simulation_parameter_accuracy <- list(
  single_assemblage_80CI = parametric_accuracy(true_single_assemblage_parameters, single_assemblage_post, single_assemblage = T, ci_limit = 0.80)[, paste0(Accurate, " / ", Total, " (", 100 * Rate, "%)")],
  single_assemblage_95CI = parametric_accuracy(true_single_assemblage_parameters, single_assemblage_post, single_assemblage = T, ci_limit = 0.95)[, paste0(Accurate, " / ", Total, " (", 100 * Rate, "%)")],
  multisite_site_parameter_80CI = parametric_accuracy(true_multisite_parameters, multisite_post, single_assemblage = F, ci_limit = 0.80)[, paste0(Accurate, " / ", Total, " (", 100 * Rate, "%)")],
  multisite_site_parameter_95CI = parametric_accuracy(true_multisite_parameters, multisite_post, single_assemblage = F, ci_limit = 0.95)[, paste0(Accurate, " / ", Total, " (", 100 * Rate, "%)")],
  multisite_site_mu_80CI = paste0(multisite_site_mu_80CI, " / ", 45, " (", round(100 * multisite_site_mu_80CI / 45, 0), "%)"),
  multisite_site_mu_95CI = paste0(multisite_site_mu_95CI, " / ", 45, " (", round(100 * multisite_site_mu_95CI / 45, 0), "%)")
)
#
simulation_composition_accuracy <- list(
  single_assemblage_measured_80CI = single_measured_assemblage_simulated_composition[, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Element, Element_Portion, Simulated_Group)][single_measured_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  single_assemblage_measured_95CI = single_measured_assemblage_simulated_composition[, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Element, Element_Portion, Simulated_Group)][single_measured_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_measured_combined_80CI = multisite_measured_assemblage_simulated_composition[Site_No %in% 1:15][, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Element, Element_Portion, Simulated_Group)][multisite_measured_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_measured_combined_95CI = multisite_measured_assemblage_simulated_composition[Site_No %in% 1:15][, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Element, Element_Portion, Simulated_Group)][multisite_measured_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_measured_bysite_80CI = multisite_measured_assemblage_simulated_composition[, .(Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_measured_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][!is.na(Accurate), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_measured_bysite_95CI = multisite_measured_assemblage_simulated_composition[, .(Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_measured_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][!is.na(Accurate), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  #
  single_assemblage_modeled_80CI = single_modeled_assemblage_simulated_composition[, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Element, Element_Portion, Simulated_Group)][single_modeled_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  single_assemblage_modeled_95CI = single_modeled_assemblage_simulated_composition[, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Element, Element_Portion, Simulated_Group)][single_modeled_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_modeled_combined_80CI = multisite_modeled_assemblage_simulated_composition[Site_No %in% 1:15][, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Element, Element_Portion, Simulated_Group)][multisite_modeled_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_modeled_combined_95CI = multisite_modeled_assemblage_simulated_composition[Site_No %in% 1:15][, .(N = sum(N)), .(Iteration, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][, .(Average = mean(N), Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Element, Element_Portion, Simulated_Group)][multisite_modeled_assemblage_composition[, .(True_N = sum(Count)), .(Element, Element_Portion, Simulated_Group = Group)], on = c("Element", "Element_Portion", "Simulated_Group")][, .(Element, Element_Portion, Simulated_Group, Average, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][, .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_modeled_bysite_80CI = multisite_modeled_assemblage_simulated_composition[, .(Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_modeled_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][!is.na(Accurate), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_modeled_bysite_95CI = multisite_modeled_assemblage_simulated_composition[, .(Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_modeled_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)][!is.na(Accurate), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  #
  multisite_modeled_newelements_N = multisite_measured_assemblage_simulated_composition[, .N, .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_measured_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, N)][multisite_modeled_assemblage_simulated_composition[, .(Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_modeled_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][is.na(N), .N, .(Site_No, Element)][, .N],
  multisite_modeled_newelements_80CI = multisite_measured_assemblage_simulated_composition[, .N, .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_measured_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, N)][multisite_modeled_assemblage_simulated_composition[, .(Low = quantile(N, 0.10), High = quantile(N, 0.90)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_modeled_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][is.na(N), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")],
  multisite_modeled_newelements_95CI = multisite_measured_assemblage_simulated_composition[, .N, .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_measured_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, N)][multisite_modeled_assemblage_simulated_composition[, .(Low = quantile(N, 0.025), High = quantile(N, 0.975)), .(Site_No, Element, Element_Portion = as.factor(Element_Portion), Simulated_Group)][multisite_modeled_assemblage_composition[, .(Site_No, Element, Element_Portion, Simulated_Group = Group, True_N = Count)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][, .(Site_No, Element, Element_Portion, Simulated_Group, Low, High, True_N, Accurate = True_N >= Low & True_N <= High)], on = c("Site_No", "Element", "Element_Portion", "Simulated_Group")][is.na(N), .(Accurate = sum(Accurate), Total = .N, Accuracy_Rate = mean(Accurate))][, paste0(Accurate, " / ", Total, " (", round(100 * Accuracy_Rate, 0), "%)")]
)
```

```{r making figure 5, include = FALSE, eval = TRUE}
#Figure 5: prior and posterior comparison of single assemblage simulation hyper-parameters
#Collect the prior and posterior estimates
single_assemblage_p_immature_prior_samples <- boot::inv.logit(rnorm(4000, -0.5, 1.5) + log(0.5))
single_assemblage_p_immature_posterior_samples <- single_assemblage_post$p_immature
single_assemblage_p_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_p_immature_prior_samples, single_assemblage_p_immature_posterior_samples))
#
single_assemblage_sex_ratio_prior_samples <- boot::inv.logit(rnorm(4000, 0, 1.5))
single_assemblage_sex_ratio_posterior_samples <- single_assemblage_post$theta_female
single_assemblage_sex_ratio_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_sex_ratio_prior_samples, single_assemblage_sex_ratio_posterior_samples))
#
single_assemblage_mu_female_prior_samples <- rnorm(4000, 0, 0.1)
single_assemblage_mu_female_posterior_samples <- single_assemblage_post$grand_mu_female
single_assemblage_mu_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_mu_female_prior_samples, single_assemblage_mu_female_posterior_samples))
#
single_assemblage_delta_immature_prior_samples <- exp(rnorm(4000, -3.5, 0.4))
single_assemblage_delta_immature_posterior_samples <- single_assemblage_post$grand_mu_female - single_assemblage_post$grand_mu_immature
single_assemblage_delta_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_delta_immature_prior_samples, single_assemblage_delta_immature_posterior_samples))
#
single_assemblage_delta_male_prior_samples <- exp(rnorm(4000, -2.7, 0.1))
single_assemblage_delta_male_posterior_samples <- single_assemblage_post$grand_mu_male - single_assemblage_post$grand_mu_female
single_assemblage_delta_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_delta_male_prior_samples, single_assemblage_delta_male_posterior_samples))
#
single_assemblage_sigma_immature_prior_samples <- exp(rnorm(4000, -3.05, 0.1))
single_assemblage_sigma_immature_posterior_samples <- single_assemblage_post$grand_sigma_immature
single_assemblage_sigma_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_sigma_immature_prior_samples, single_assemblage_sigma_immature_posterior_samples))
#
single_assemblage_sigma_female_prior_samples <- exp(rnorm(4000, -3.1, 0.1))
single_assemblage_sigma_female_posterior_samples <- single_assemblage_post$grand_sigma_female
single_assemblage_sigma_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_sigma_female_prior_samples, single_assemblage_sigma_female_posterior_samples))
#
single_assemblage_sigma_male_prior_samples <- exp(rnorm(4000, -3.1, 0.1))
single_assemblage_sigma_male_posterior_samples <- single_assemblage_post$grand_sigma_male
single_assemblage_sigma_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(single_assemblage_sigma_male_prior_samples, single_assemblage_sigma_male_posterior_samples))

#make the plots
single_assemblage_p_immature_plot <-
  ggplot(single_assemblage_p_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Proportion Immature, ", pi[1])), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_sex_ratio_plot <-
  ggplot(single_assemblage_sex_ratio_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_mu_female_plot <-
  ggplot(single_assemblage_mu_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Average Female LSI, ", mu[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_delta_immature_plot <-
  ggplot(single_assemblage_delta_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Size Penalty, ", delta[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_delta_male_plot <-
  ggplot(single_assemblage_delta_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism, ", delta[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_sigma_immature_plot <-
  ggplot(single_assemblage_sigma_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Variability, ", sigma[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_sigma_female_plot <-
  ggplot(single_assemblage_sigma_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Female Variability, ", sigma[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
single_assemblage_sigma_male_plot <-
  ggplot(single_assemblage_sigma_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Male Variability, ", sigma[3])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
figure_5 <- ggarrange(
  single_assemblage_p_immature_plot, single_assemblage_sex_ratio_plot,
  single_assemblage_mu_female_plot, single_assemblage_delta_immature_plot,
  single_assemblage_delta_male_plot, single_assemblage_sigma_immature_plot,
  single_assemblage_sigma_female_plot, single_assemblage_sigma_male_plot,
  ncol = 2, nrow = 4,
  common.legend = T, legend = "bottom")
#
Cairo(width = 8, height = 10, units = "in", file = "./Output/Figures/figure_5.png", type = "png", dpi = 600)
figure_5
dev.off()
```

```{r making figure 6, include = FALSE, eval = TRUE}
#Figure 6: posterior distributions of single assemblage hyper-parameters
pi_df <- data.frame(group = factor(rep(c("Immature", "Female", "Male"), each = nrow(single_assemblage_post$grand_theta)), levels = c("Immature", "Female", "Male")),
                    value = c(single_assemblage_post$grand_theta))
#
pi_plot <- ggplot(pi_df) + aes(y = value, x = group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = data.frame(group = c("Immature", "Female", "Male"), x = c(0.9, 1.9, 2.9), xend = c(1.9, 2.9, 3.9), y = c(true_single_assemblage_parameters[, p_immature], true_single_assemblage_parameters[, p_female], true_single_assemblage_parameters[, p_male]), yend = c(true_single_assemblage_parameters[, p_immature], true_single_assemblage_parameters[, p_female], true_single_assemblage_parameters[, p_male])), aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = NULL, breaks = NULL) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "Proportion", limits = c(0, 1)) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
#
mu_df <- data.frame(group = factor(rep(c("Immature", "Female", "Male"), each = nrow(single_assemblage_post$grand_theta)), levels = c("Immature", "Female", "Male")),
                    value = c(single_assemblage_post$grand_mu_immature, single_assemblage_post$grand_mu_female, single_assemblage_post$grand_mu_male))
mu_plot <- ggplot(mu_df) + aes(y = value, x = group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = data.frame(group = c("Immature", "Female", "Male"), x = c(0.9, 1.9, 2.9), xend = c(1.9, 2.9, 3.9), y = c(true_single_assemblage_parameters[, mu_immature], true_single_assemblage_parameters[, mu_female], true_single_assemblage_parameters[, mu_male]), yend = c(true_single_assemblage_parameters[, mu_immature], true_single_assemblage_parameters[, mu_female], true_single_assemblage_parameters[, mu_male])), aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = NULL, breaks = NULL) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "LSI Mean Value") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
#
sigma_df <- data.frame(group = factor(rep(c("Immature", "Female", "Male"), each = nrow(single_assemblage_post$grand_theta)), levels = c("Immature", "Female", "Male")),
                    value = c(single_assemblage_post$grand_sigma_immature, single_assemblage_post$grand_sigma_female, single_assemblage_post$grand_sigma_male))
sigma_plot <- ggplot(sigma_df) + aes(y = value, x = group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = data.frame(group = c("Immature", "Female", "Male"), x = c(0.9, 1.9, 2.9), xend = c(1.9, 2.9, 3.9), y = c(true_single_assemblage_parameters[, sigma_immature], true_single_assemblage_parameters[, sigma_female], true_single_assemblage_parameters[, sigma_male]), yend = c(true_single_assemblage_parameters[, sigma_immature], true_single_assemblage_parameters[, sigma_female], true_single_assemblage_parameters[, sigma_male])), aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = NULL, breaks = NULL) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "LSI Standard Deviation Value") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
#
figure_6 <- ggarrange(pi_plot, mu_plot, sigma_plot, labels = c("A", "B", "C"), common.legend = T, legend = "bottom", nrow = 1, ncol = 3)
#
Cairo(width = 10, height = 7, units = "in", file = "./Output/Figures/figure_6.png", type = "png", dpi = 600)
figure_6
dev.off()
```

```{r making figure 7, include = FALSE, eval = TRUE}
#Figure 7: posterior distribution of multisite simulation site-level parameters
multisite_pi_df <- data.table(site = rep(rep(multisite_demographic_observations[order(Site_No), Site], each = nrow(multisite_post$site_theta)), 3),
                              group = factor(rep(c("Immature", "Female", "Male"), each = 15 * nrow(multisite_post$site_theta)), levels = c("Immature", "Female", "Male")),
                              value = c(multisite_post$site_theta[, 1, ], multisite_post$site_theta[, 2, ], multisite_post$site_theta[, 3, ]))
multisite_pi_df[, plotting_group := paste(site, as.numeric(group), sep = ".")]
multisite_pi_true_df <- data.table(site = rep(multisite_demographic_observations[order(Site_No), Site], 3),
                                   group = factor(rep(c("Immature", "Female", "Male"), each = 15), levels = c("Immature", "Female", "Male")), x = 1:15, xend = 1:15 + 0.1, y = c(true_multisite_parameters[, p_immature], true_multisite_parameters[, p_female], true_multisite_parameters[, p_male]), yend = c(true_multisite_parameters[, p_immature], true_multisite_parameters[, p_female], true_multisite_parameters[, p_male]))
multisite_pi_true_df[, plotting_group := factor(paste(site, as.numeric(group), sep = "."))]
multisite_pi_true_df[, c("x", "xend") := .(as.numeric(plotting_group) - 0.1, as.numeric(plotting_group) + 0.75)]
#
multisite_pi_plot <- ggplot(multisite_pi_df) + aes(y = value, x = plotting_group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = multisite_pi_true_df, aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Site", breaks = sapply(1:15, function(x) paste(ifelse(x < 10, "Site 0", "Site "), x, ".2", sep = "")), labels = sapply(1:15, function(x) paste("Site ", x, sep = ""))) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "Proportion") + coord_cartesian(ylim = c(0, 1)) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))

#
multisite_mu_df <- data.table(site = rep(rep(multisite_demographic_observations[order(Site_No), Site], each = nrow(multisite_post$site_theta)), 3),
                              group = factor(rep(c("Immature", "Female", "Male"), each = 15 * nrow(multisite_post$site_theta)), levels = c("Immature", "Female", "Male")),
                              value = c(multisite_post$site_mu_immature, multisite_post$site_mu_female, multisite_post$site_mu_male))
multisite_mu_df[, plotting_group := paste(site, as.numeric(group), sep = ".")]
multisite_mu_true_df <- data.table(site = rep(multisite_demographic_observations[order(Site_No), Site], 3),
  group = factor(rep(c("Immature", "Female", "Male"), each = 15), levels = c("Immature", "Female", "Male")), x = 1:15, xend = 1:15 + 0.1, y = c(true_multisite_parameters[, mu_immature], true_multisite_parameters[, mu_female], true_multisite_parameters[, mu_male]), yend = c(true_multisite_parameters[, mu_immature], true_multisite_parameters[, mu_female], true_multisite_parameters[, mu_male]))
multisite_mu_true_df[, plotting_group := factor(paste(site, as.numeric(group), sep = "."))]
multisite_mu_true_df[, c("x", "xend") := .(as.numeric(plotting_group) - 0.1, as.numeric(plotting_group) + 0.75)]

multisite_mu_plot <- ggplot(multisite_mu_df) + aes(y = value, x = plotting_group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = multisite_mu_true_df, aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Site", breaks = sapply(1:15, function(x) paste(ifelse(x < 10, "Site 0", "Site "), x, ".2", sep = "")), labels = sapply(1:15, function(x) paste("Site ", x, sep = ""))) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "LSI Mean Value") + 
  coord_cartesian(ylim = c(-0.5, 0.5)) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
#
multisite_sigma_df <- data.table(site = rep(rep(multisite_demographic_observations[order(Site_No), Site], each = nrow(multisite_post$site_theta)), 3),
                              group = factor(rep(c("Immature", "Female", "Male"), each = 15 * nrow(multisite_post$site_theta)), levels = c("Immature", "Female", "Male")),
                              value = c(multisite_post$site_sigma_immature, multisite_post$site_sigma_female, multisite_post$site_sigma_male))
multisite_sigma_df[, plotting_group := paste(site, as.numeric(group), sep = ".")]
multisite_sigma_true_df <- data.table(site = rep(multisite_demographic_observations[order(Site_No), Site], 3),
                                   group = factor(rep(c("Immature", "Female", "Male"), each = 15), levels = c("Immature", "Female", "Male")), x = 1:15, xend = 1:15 + 0.1, y = c(true_multisite_parameters[, sigma_immature], true_multisite_parameters[, sigma_female], true_multisite_parameters[, sigma_male]), yend = c(true_multisite_parameters[, sigma_immature], true_multisite_parameters[, sigma_female], true_multisite_parameters[, sigma_male]))
multisite_sigma_true_df[, plotting_group := factor(paste(site, as.numeric(group), sep = "."))]
multisite_sigma_true_df[, c("x", "xend") := .(as.numeric(plotting_group) - 0.1, as.numeric(plotting_group) + 0.75)]

multisite_sigma_plot <- ggplot(multisite_sigma_df) + aes(y = value, x = plotting_group) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  geom_segment(data = multisite_sigma_true_df, aes(x = x, xend = xend, y = y, yend = yend, color = group, linetype = "solid"), lwd = 1) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Site", breaks = sapply(1:15, function(x) paste(ifelse(x < 10, "Site 0", "Site "), x, ".2", sep = "")), labels = sapply(1:15, function(x) paste("Site ", x, sep = ""))) +
  scale_linetype_manual(name = "Population Value", values = 1, labels = NULL) +
  scale_y_continuous(name = "LSI Mean Value") + coord_cartesian(ylim = c(0, 0.10)) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90, size = 10, hjust = 0.5))
#
figure_7 <- ggarrange(multisite_pi_plot, multisite_mu_plot, multisite_sigma_plot, labels = c("A", "B", "C"), common.legend = T, legend = "bottom", nrow = 3, ncol = 1)
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_7.png", type = "png", dpi = 600)
figure_7
dev.off()
```

```{r making figure 8, include = FALSE, eval = TRUE}
#Figure 8: four-panel compositional estimates of the single assemblage measured (A), multisite measured (B), single assemblaged modeled (C), and multisite modeled (D) assemblages
single_assemblage_measured_composition_plot <- composition_analysis(composition_data = single_measured_assemblage_simulated_composition, true_data = single_measured_assemblage_composition, site_no = 1, site_title = "Single Assemblage")
single_assemblage_modeled_composition_plot <- composition_analysis(composition_data = single_modeled_assemblage_simulated_composition, true_data = single_modeled_assemblage_composition, site_no = 1, site_title = "Single Assemblage")
multisite_measured_composition_plot <- composition_analysis(composition_data = multisite_measured_assemblage_simulated_composition, true_data = multisite_measured_assemblage_composition, site_no = 1:15, site_title = "Multisite")
multisite_modeled_composition_plot <- composition_analysis(composition_data = multisite_modeled_assemblage_simulated_composition, true_data = multisite_modeled_assemblage_composition, site_no = 1:15, site_title = "Multisite")
#
figure_8 <- ggarrange(single_assemblage_measured_composition_plot, single_assemblage_modeled_composition_plot, multisite_measured_composition_plot, multisite_modeled_composition_plot, labels = c("A", "B", "C", "D"), nrow = 2, ncol = 2, common.legend = T, legend = "bottom")
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_8.png", type = "png", dpi = 600)
figure_8
dev.off()
```

Bayesian models work by updating prior information with new data to produce posterior distributions of parameters of interest [@otarolacastillo_etal_2022]. Thus, the difference between a model parameter's prior and posterior distribution shows the amount that the model "learns" from the data-if the data do not provide relevant information on a parameter's potential values, then the posterior distribution will resemble the prior distribution. Figure 5 compares the prior and posterior distributions of the main model hyper-parameters for the single assemblage simulation. The results show that the data provides much more information about the likely values of the two demographic parameters (the proportion of immature animals, $\pi_1$, and the adult sex ratio, $\tfrac{\pi_2}{\pi_2 + \pi_3}$) and the average body size for females ($\mu_2$). This is largely to be expected, as the prior distribution definitions were weakly-informative priors [@gelman_etal_2008], but also shows how these choices did not appear to severely influence the resulting posterior distributions. 

The prior distribution definitions for the size offsets ($\delta_1$ and $\delta_2$) and the size variability estimates ($\sigma_1$, $\sigma_2$, and $\sigma_3$) have a lot more overlap between the prior distributions and their respective posterior distributions. This overlap stresses the importance of using a Bayesian framework, particularly one relying on informative prior distributions, to produce meaningful parameter estimates from zooarchaeological data. But it also highlights the interpretive weight given to the reference population. However, the overlap is not necessarily a drawback of the model, as again the prior distribution definitions were designed as informative priors, specifically to ensure that the resulting parameter estimates would be biologically feasible. Further, the simulated population also has the same underlying biological population (the Shetland sheep population) that was used to develop the prior distributions, so it is possible that this overlap reflects that fact.

```{r figure_5, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Prior-Posterior Comparison of Single Assemblage Simulation Model Hyper-Parameters"}
knitr::include_graphics("./Output/Figures/figure_5.png")
```

Parametric accuracy for the simulations relies on relating the posterior distributions for “assemblage-level” parameters to the known values for the overall Shetland sheep population (including any relevant modifications). Ideally, the 80% and 95% credible intervals from these posterior distributions should contain the true population value 80% and 95% of the time, respectively. An overfit model would contain the population value less frequently than the stated interval, producing false confidence in the applicability of the results. An underfit model, by contrast, would contain the population value more frequently than the stated interval, producing results that are too conservative. The single-assemblage simulation produces overfit results: `r simulation_parameter_accuracy$single_assemblage_80CI` of the 80% credible intervals and `r simulation_parameter_accuracy$single_assemblage_95CI` of the 95% credible intervals from the posterior distributions of the population parameters contain the true value of the Shetland sheep population. The multisite simulation produces relatively well-calibrated estimates for assemblage-level parameters, with `r simulation_parameter_accuracy$multisite_site_parameter_80CI` of the 80% credible intervals and `r simulation_parameter_accuracy$multisite_site_parameter_95CI` of the 95% credible intervals from the posterior distributions of the (site-level) population parameters containing the true values of the Shetland sheep population with relevant modifications.

```{r figure_6, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Model Parameters for the Simulated Single Assemblage with Relevant Population Parameter Values"}
knitr::include_graphics("./Output/Figures/figure_6.png")
```

Figure 6 shows the posterior distributions of the population parameters for the single-assemblage model, highlighting the 80% and 95% credible intervals and the corresponding value from the overall Shetland sheep assemblage (“Population Value”). The single assemblage model estimates all of the model hyper-parameters relatively accurately, though does tend to underestimate within-group size variability ($\sigma_{1,2,3}$). The multisite model severely overfits when estimating the average body size for the three groups at each site, with `r simulation_parameter_accuracy$multisite_site_mu_80CI` of the 80% credible intervals and `r simulation_parameter_accuracy$multisite_site_mu_95CI` of the 95% credible intervals for the posterior distributions of the site-specific model parameters containing the true population values (Figure 7). Size variability ($\sigma_{1,2,3}$) is estimated relatively well, though again tends to underestimate size variability, while proportions may not be accurate for extremely low populations values (e.g., immature animals in Sites 11-15).

```{r figure_7, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Model Parameters for the Simulated Multisite Assemblage with Relevant Population Parameter Values"}
knitr::include_graphics("./Output/Figures/figure_7.png")
```

Figure 8 shows posterior distributions of simulated group-specific compositions for both the single-assemblage and total composition of the multisite models (i.e., all sites combined) alongside true counts for each group. The models estimate the group-specific composition of the assemblages with great accuracy: `r simulation_composition_accuracy$single_assemblage_measured_80CI` of the 80% and `r simulation_composition_accuracy$single_assemblage_measured_95CI` of the 95% credible intervals contain the true group-specific count for the element portion in the single-assemblage model and `r simulation_composition_accuracy$multisite_measured_combined_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$multisite_measured_combined_95CI` of the 95% credible intervals contain the true group-specific count for the element portion in the combined multisite model. The multisite model also accurately estimates the group-specific composition of each assemblage: `r simulation_composition_accuracy$multisite_measured_bysite_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$multisite_measured_bysite_95CI` of the 95% credible intervals contain the true group-specific count.

```{r figure_8, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Group-Specific Compositions for the Simulated Measured and Modeled Assemblages"}
knitr::include_graphics("./Output/Figures/figure_8.png")
```

This overfitting is to be expected since the measured assemblage is a subsample of the modeled assemblage. The model does not overfit as much when estimating the composition of the modeled assemblages: for the single-assemblage model, `r simulation_composition_accuracy$single_assemblage_modeled_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$single_assemblage_modeled_95CI` of the 95% credible intervals contain the true group-specific counts for the element portions. For the multisite model, the model does not perform well for the combined assemblages (`r simulation_composition_accuracy$multisite_modeled_combined_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$multisite_modeled_combined_95CI` of the 95% credible intervals) but produces well-calibrated estimates for the site-specific estimates of group composition, with `r simulation_composition_accuracy$multisite_modeled_bysite_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$multisite_modeled_bysite_95CI` of the 95% credible intervals containing the true group-specific counts. Note that the denominator for the site-specific estimates differs between the measured and modeled assemblages. This is caused by the additional sampling to create modeled assemblages and the multilevel structure of the model, which estimates element-specific offsets and interaction terms ($\nu_{\operatorname{element}}$ and $\nu_{\operatorname{interaction}}$) for elements that are present in at least one site. Among the `r simulation_composition_accuracy$multisite_modeled_newelements_N` newly-observed elements in the modeled assemblage, `r simulation_composition_accuracy$multisite_modeled_newelements_80CI` of the 80% credible intervals and `r simulation_composition_accuracy$multisite_modeled_newelements_95CI` of the 95% credible intervals included the true group-specific abundance, despite having no observed measurements. That these estimates are broadly as accurate as the estimates from observed element portions suggests that the hyper-parameters can be used to create estimates of unobserved (i.e., unmeasured) element portions in an assemblage.

### *4.2 Archaeological Case Studies*

```{r Pinarbasi B sheep stanfit, include = FALSE, eval = TRUE}
#Format the data for Stan and run the analyses
pinarbasi_mixmod_standata <- list(
  #Sample sizes
  N_Specimens = pinarbasi_mixmod_data[, .N, Specimen_No][, .N],
  N_Measurements = pinarbasi_mixmod_data[, .N],
  N_Element_Portions = pinarbasi_mixmod_data[, .N, Element_Portion][, .N],
  N_Measurement_Sets = pinarbasi_mixmod_data[, .N, Measurement_Set][, .N],
  #Specimen observations
  Element_Portion = pinarbasi_mixmod_data[, .N, .(Specimen_No, Element_Portion, Immature)][order(Specimen_No), Element_Portion],
  Immature = pinarbasi_mixmod_data[, .N, .(Specimen_No, Element_Portion, Immature)][order(Specimen_No), Immature],
  Immature_Proportion = as.matrix(dcast(pinarbasi_mixmod_data[, .(Immature_Proportion = mean(Immature)), .(Site_No, Element_Portion)], Site_No ~ Element_Portion, value.var = "Immature_Proportion", fill = 0))[, 2:(pinarbasi_mixmod_data[, .N, Element_Portion][, .N] + 1)],
  #Measurement observations
  Measurement_obs = pinarbasi_mixmod_data[, Measurement_value],
  Measurement_sd = pinarbasi_mixmod_data[, Measurement_value * 0.01],
  Reference_obs = pinarbasi_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value],
  Reference_sd = pinarbasi_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value * 0.01],
  Measurement_Set = pinarbasi_mixmod_data[, Measurement_Set],
  Specimen = pinarbasi_mixmod_data[, Specimen_No],
  #Demographic observations
  Immature_obs = pinarbasi_demographic_observations[, N_Unfused],
  Immature_obs_n = pinarbasi_demographic_observations[, N_Ageable],
  Female_obs = pinarbasi_demographic_observations[, N_Female],
  Female_obs_n = pinarbasi_demographic_observations[, N_Sexable],
  #Prior distributions for hyper-parameters
  prior_theta_raw_1 = c(-0.5, 1.5),
  prior_theta_raw_2 = c(0, 1.5),
  prior_mu_female = c(0, 0.1),
  prior_logdelta_immature = c(-3.5, 0.4),
  prior_logdelta_male = c(-2.7, 0.1),
  prior_logsigma_immature = c(-3.05, 0.1),
  prior_logsigma_female = c(-3.1, 0.1),
  prior_logsigma_male = c(-3.1, 0.1)
)

singlesite_mixture_stanmodel <- cmdstan_model("./Scripts/LSI_mixture_model_singlesite.stan")
pinarbasi_samples <- singlesite_mixture_stanmodel$sample(
  data = pinarbasi_mixmod_standata,
  chains = 4,
  parallel_chains = 4,
  refresh = 250,
  adapt_delta = 0.95,
  seed = 16374862,
  max_treedepth = 15
)
pinarbasi_stanfit <- rstan::read_stan_csv(pinarbasi_samples$output_files())
pinarbasi_post <- extract(pinarbasi_stanfit)
#
```

```{r Northwest Anatolian cattle stanfit, include = FALSE, eval = TRUE}
nw_anatolian_mixmod_standata <- list(
  #Sample sizes
  N_Sites = nw_anatolian_mixmod_data[, .N, Site_No][, .N],
  N_Specimens = nw_anatolian_mixmod_data[, .N, Specimen_No][, .N],
  N_Measurements = nw_anatolian_mixmod_data[, .N],
  N_Element_Portions = nw_anatolian_mixmod_data[, .N, Element_Portion][, .N],
  N_Measurement_Sets = nw_anatolian_mixmod_data[, .N, Measurement_Set][, .N],
  #Specimen observations
  Site = nw_anatolian_mixmod_data[, .N, .(Specimen_No, Site_No, Element_Portion, Immature)][order(Specimen_No), Site_No],
  Element_Portion = nw_anatolian_mixmod_data[, .N, .(Specimen_No, Site_No, Element_Portion, Immature)][order(Specimen_No), Element_Portion],
  Immature = nw_anatolian_mixmod_data[, .N, .(Specimen_No, Site_No, Element_Portion, Immature)][order(Specimen_No), Immature],
  Immature_Proportion = as.matrix(dcast(nw_anatolian_mixmod_data[, .(Immature_Proportion = mean(Immature)), .(Site_No, Element_Portion)], Site_No ~ Element_Portion, value.var = "Immature_Proportion", fill = 0))[, 2:(nw_anatolian_mixmod_data[, .N, Element_Portion][, .N] + 1)],
  #Measurement observations
  Measurement_obs = nw_anatolian_mixmod_data[, Measurement_value],
  Measurement_sd = nw_anatolian_mixmod_data[, Measurement_value * 0.01],
  Reference_obs = nw_anatolian_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value],
  Reference_sd = nw_anatolian_mixmod_data[, .N, .(Measurement_Set, Reference_value)][order(Measurement_Set), Reference_value * 0.01],
  Measurement_Set = nw_anatolian_mixmod_data[, Measurement_Set],
  Specimen = nw_anatolian_mixmod_data[, Specimen_No],
  #Demographic observations
  N_Immature_obs = nw_anatolian_demographic_observations[, .N],
  Immature_obs_site = nw_anatolian_demographic_observations[, Site_No],
  Immature_obs = nw_anatolian_demographic_observations[, N_Unfused],
  Immature_obs_n = nw_anatolian_demographic_observations[, N_Ageable],
  N_Female_obs = nw_anatolian_demographic_observations[, .N],
  Female_obs_site = nw_anatolian_demographic_observations[, Site_No],
  Female_obs = nw_anatolian_demographic_observations[, N_Female],
  Female_obs_n = nw_anatolian_demographic_observations[, N_Sexable],
  #Prior distributions for hyper-parameters
  prior_theta_raw_1 = c(-0.5, 1.5),
  prior_theta_raw_2 = c(0, 1.5),
  prior_mu_female = c(-0.1, 0.1),
  prior_logdelta_immature = c(-3.5, 0.5),
  prior_logdelta_male = c(-2, 0.5),
  prior_logsigma_immature = c(-3.05, 0.25),
  prior_logsigma_female = c(-3.1, 0.2),
  prior_logsigma_male = c(-3.1, 0.2)
)

multisite_mixture_stanmodel <- cmdstan_model("./Scripts/LSI_mixture_model_multisite.stan")
nw_anatolian_multisite_samples <- multisite_mixture_stanmodel$sample(
  data = nw_anatolian_mixmod_standata,
  chains = 4,
  parallel_chains = 4,
  refresh = 250,
  adapt_delta = 0.99,
  seed = 192536027,
  max_treedepth = 15
)
#
nw_anatolian_multisite_stanfit <- rstan::read_stan_csv(nw_anatolian_multisite_samples$output_files())
nw_anatolian_post <- extract(nw_anatolian_multisite_stanfit)
```

```{r posterior analysis (archaeological), include = FALSE, eval = TRUE}
####Composition analysis: simulate the composition of the assemblage(s) by sampling from probabilities####
#for measured specimens (with Specimen_No): the specific probabilities for that specimen
#for modeled specimens (no Specimen_No but has relevant Element_Portion): the probabilities for that Element_Portion (theta[1:3])
#for unmodeled specimens (no relevant Element_Portion): calculate new element_portion-specific theta values using the hyper-parameters

####Functions needed for the compositional analyses####
#(some of these are copies of those used for the simulations)

#Identify the relevant mixture components for a specimen
theta_finder <- function(Specimen_No, Element_Portion, Immature, Immature_Proportions, element_thetas, specimen_probs) {
  thetas <- rep(NA, 3)
  immature_proportion <- Immature_Proportions[Portion %in% Element_Portion, Immature_Proportion]
  thetas[1:3] <- ifelse(rep(!is.na(Specimen_No), 3),
                        specimen_probs[Specimen_No, 1:3],
                        ifelse(rep(Immature == 1, 3),
                               c(element_thetas[1, Element_Portion] / immature_proportion,
                                 element_thetas[2, Element_Portion] * immature_proportion,
                                 element_thetas[3, Element_Portion] * immature_proportion),
                               c(0,
                                 element_thetas[2, Element_Portion] / (1 - min(c(element_thetas[1, Element_Portion], 0.99999))), #fail-safe for extreme values
                                 element_thetas[3, Element_Portion] / (1 - min(c(element_thetas[1, Element_Portion], 0.99999)))))
  )
  list(p_immature = thetas[1] / sum(thetas), p_female = thetas[2] / sum(thetas), p_male = thetas[3] / sum(thetas))
}

#Sample a group identity from a set of specimen probabilities
ifm_sample <- function(p_immature, p_female, p_male) {
  sample(c("Immature", "Female", "Male"), 1, replace = T, prob = c(p_immature, p_female, p_male))
}

#Simulates the composition of an assemblage with Immature/Female/male probabilities
ifm_composition <- function(measured_specimens) {
  #simulate sex assignments
  measured_specimens[, Simulated_Group := sapply(1:.N, function(x) ifm_sample(p_immature[x], p_female[x], p_male[x]))]
  #counts of the different elements by group (make sure there's a 0 if a value is missing)
  melt(measured_specimens[, .(`Immature` = sum(Simulated_Group %in% "Immature"),
                              `Female` = sum(Simulated_Group %in% "Female"),
                              `Male` = sum(Simulated_Group %in% "Male")), .(Site_No, Element_Portion, Element)], id.vars = c("Site_No", "Element_Portion", "Element"), variable.name = "Simulated_Group", value.name = "N")[order(Site_No, Element_Portion, Simulated_Group)]
}

#Simulates the fusion rates for an assemblage with Immature/Female/male probabilities
ifm_fusion_rate <- function(measured_specimens) {
  #simulate sex assignments
  measured_specimens[, Simulated_Group := sapply(1:.N, function(x) ifm_sample(p_immature[x], p_female[x], p_male[x]))]
  #counts of the different elements by group and fusion status
  
  melt(measured_specimens[, .(`Immature` = sum(Simulated_Group %in% "Immature"),
                              `Female` = sum(Simulated_Group %in% "Female"),
                              `Male` = sum(Simulated_Group %in% "Male")), .(Site_No, Fusion_Element, Stage, Fusion)], id.vars = c("Site_No", "Fusion_Element", "Stage", "Fusion"), variable.name = "Simulated_Group", value.name = "N")[order(Site_No, Stage, Fusion_Element, Fusion, Simulated_Group)]
}

#function to get integer y-axis values only (source: https://gist.github.com/jhrcook/eb7b63cc57c683a6eb4986c4107a88ec)
integer_breaks <- function(n = 5, ...) {
  fxn <- function(x) {
    breaks <- floor(pretty(x, n, ...))
    names(breaks) <- attr(breaks, "labels")
    breaks
  }
  return(fxn)
}

#Plots the distributions of group-specific composition
archaeological_composition_analysis <- function(composition_data, site_no = 1, site_name = "Pinarbasi Measured Assemblage", full_element_name_key = pinarbasi_element_name_key) {
  ggplot(composition_data[Site_No %in% site_no, .(N = sum(N)), .(Iteration, Simulated_Group, Element, Element_Portion)][, .(Element, Element_Portion, group = Simulated_Group, Plot_Group = paste(Element, as.numeric(Simulated_Group), sep = "."), N)]) + aes(y = N, x = Plot_Group) +
    stat_slab(normalize = "groups", slab_type = "histogram", breaks = 0:(composition_data[Site_No %in% site_no, .(N = sum(N)), .(Iteration, Simulated_Group, Element, Element_Portion)][, max(N)]), aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.80, 0.95, 1), labels = scales::percent_format())))) +
    stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
    scale_fill_ramp_discrete(name = "Interval", range = c(0.5, 0.15), na.translate = F) +
    scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
    scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
    scale_x_discrete(name = "Element", breaks = composition_data[, .N, .(Element, Element_Portion)][order(Element_Portion), paste(Element, ".2", sep = "")], labels = composition_data[, .N, .(Element, Element_Portion)][full_element_name_key, on = "Element"][!is.na(Element_Portion)][order(Element_Portion), Full_Element_Name]) +
    scale_y_continuous(name = "Estimated Count", breaks = integer_breaks()) + coord_cartesian(expand = FALSE) +
    labs(title = site_name) +
    theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 8, angle = -90, hjust = 0), axis.title = element_text(size = 12), axis.text.y = element_text(size = 8), axis.title.x = element_blank())
}

#create full assemblage for analysis
full_assemblage_maker <- function(original_data, biology_code, site_code, mixmod_data, element_list, full_elements, element_key) {
  full_assemblage <- original_data[`Has Biological Taxonomy [Label]` %in% biology_code & `Has anatomical identification [Label]` %in% full_elements, .(ID = paste(site_code, Label, sep = " "), Site = site_code, Anatomy = `Has anatomical identification [Label]`, `Proximal Fusion` = `Has fusion character [Proximal Label]`, `Distal Fusion` = `Has fusion character [Distal Label]`)]
  #Assign specimen numbers for the specimens that were modeled directly (measured specimens) in the modeled and full assemblages
  full_assemblage <- mixmod_data[, .N, .(ID, Specimen_No, Immature)][full_assemblage, on = "ID"]
  #Assign the element portion labels for specimens that weren't modeled directly (no measurements)
  for(i in 1:element_key[, .N]) {
    full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := element_key[i, `Element Label`]]
    #Separate out proximal and distal element portions based on presence of later-fusing measurements (e.g., radius bone is proximal/distal based on presence of Bd measurement)
    if(element_key[i, `Element Label`] %in% c("Rad", "Mtc", "Fem", "Mtt")) {
      full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(`Distal Fusion` %in% "" == F, paste(element_key[i, `Element Label`], "dist", sep = "_"), paste(element_key[i, `Element Label`], "prox", sep = "_"))]
    }
    if(element_key[i, `Element Label`] %in% c("Tib")) {
      full_assemblage[Anatomy %in% element_key[i, `Anatomy Label`], Element := ifelse(`Proximal Fusion` %in% "" == F, paste(element_key[i, `Element Label`], "prox", sep = "_"), paste(element_key[i, `Element Label`], "dist", sep = "_"))]
    }
  }
  #Assign Element_Portion values that match the original sets (and add new ones for unmodeled element portions)
  full_assemblage <- element_list[, .N, .(Element, Element_Portion)][full_assemblage, on = "Element"]
  full_assemblage[Element %in% "Pel", Element_Portion := 17]
  full_assemblage[Element %in% "Uln", Element_Portion := 18]
  #Get the Immature variable (potentially immature status based on fusion)
  full_assemblage[is.na(Immature) & Element %in% c("Sca", "Ast"), Immature := 1] #does not fuse / subject to post-fusion growth and has no relevant fusion data to exclude immature status
  full_assemblage[is.na(Immature) & Element %in% c("Hum", "Cal", "PH1", "PH2"), Immature := as.numeric(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") == F)]
  full_assemblage[is.na(Immature) & Element %in% c("Rad_prox", "Rad_dist", "Mtc_prox", "Mtc_dist", "Mtt_prox", "Mtt_dist"), Immature := as.numeric(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing") == F)]
  full_assemblage[is.na(Immature) & Element %in% c("Uln", "Pel", "Fem_prox", "Fem_dist", "Tib_prox", "Tib_dist"), Immature := as.numeric((`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing")) == F)]
  #
  full_assemblage[, .(ID, Specimen_No, Site, Anatomy, Element, Element_Portion, Immature, `Proximal Fusion`, `Distal Fusion`)]
}

#creates the fusion assemblages from a full assemblage with fusion keys
fusion_assemblage_maker <- function(full_assemblage, element_stage_key) {
  full_assemblage[Element %in% "Rad_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Rad_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Hum" & `Distal Fusion` %in% "" == F & `Proximal Fusion` %in% "", c("Fusion_Element", "Fusion") := .("Hum_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Pel" & (`Proximal Fusion` %in% "" == F | `Distal Fusion` %in% "" == F), c("Fusion_Element", "Fusion") := .("Pel", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Sca" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Sca", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "PH1" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("PH1", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "PH2" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("PH2", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Tib_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Tib_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Mtc_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Mtc_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Mtt_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Mtt_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Cal" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Cal", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Fem_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Fem_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Fem_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Fem_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Uln" & (`Proximal Fusion` %in% "" == F | `Distal Fusion` %in% "" == F), c("Fusion_Element", "Fusion") := .("Uln", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing") | `Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Rad_dist" & `Distal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Rad_dist", ifelse(`Distal Fusion` %in% c("Distal epiphysis fused", "Distal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Tib_prox" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Tib_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  full_assemblage[Element %in% "Hum" & `Proximal Fusion` %in% "" == F, c("Fusion_Element", "Fusion") := .("Hum_prox", ifelse(`Proximal Fusion` %in% c("Proximal epiphysis fused", "Proximal epiphysis fusing"), "Fused", "Unfused"))]
  fusion_assemblage <- full_assemblage[, .(ID, Specimen_No, Site, Anatomy, Element, Element_Portion, Immature, `Proximal Fusion`, `Distal Fusion`, Fusion_Element, Fusion)][element_stage_key, on = "Fusion_Element"][!is.na(Fusion_Element) & !is.na(Fusion)]
  fusion_assemblage
}
```

```{r Pinarbasi B sheep composition analysis, include = FALSE, eval = TRUE}
####Compositional analysis (Pinarbasi Sheep)####
#Calculating five new sets of element_portion-specific mixing probabilities for unmodeled element portions
pinarbasi_unmodeled_element_portion_theta <- data.table(Iteration = rep(1:4000, 5),
                                                        Element_Portion = rep(11:15, each = 4000),
                                                        Element = rep(c("Rad_prox", "Mtc_prox", "Man", "Uln", "Pel"), each = 4000))
#specify hyper-parameter values for the model
for(i in 1:5) {
  element_theta_raw <- t(sapply(1:4000, function(x) MASS::mvrnorm(1, mu = pinarbasi_post$grand_theta_raw[x, 1:2], Sigma = diag(pinarbasi_post$element_sigma[x, 1:2]) %*% pinarbasi_post$Rho_element[x, 1:2, 1:2] %*% diag(pinarbasi_post$element_sigma[x, 1:2]))))
  pinarbasi_unmodeled_element_portion_theta[(4000 * (i - 1) + 1):(4000 * i), c("theta_raw_1", "theta_raw_2") := .(element_theta_raw[, 1], element_theta_raw[, 2])]
}
#perform stick-breaking procedure to turn theta_raw into theta values
pinarbasi_unmodeled_element_portion_theta[, theta_1 := boot::inv.logit(theta_raw_1 + log(0.5))]
pinarbasi_unmodeled_element_portion_theta[, theta_2 := (1 - theta_1) * boot::inv.logit(theta_raw_2 + log(1))]
pinarbasi_unmodeled_element_portion_theta[, theta_3 := (1 - (theta_1 + theta_2))]

#set up the datasets necessary to run the simulations for the three assemblages
pinarbasi_measured_immature_proportions <- pinarbasi_measured_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
pinarbasi_modeled_immature_proportions <- pinarbasi_modeled_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
pinarbasi_full_immature_proportions <- pinarbasi_full_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]

clusterExport(cl, list('data.table', 'melt', 'ifm_sample', 'theta_finder', 'ifm_composition', 'pinarbasi_measured_assemblage', 'pinarbasi_measured_immature_proportions', 'pinarbasi_modeled_assemblage', 'pinarbasi_modeled_immature_proportions', 'pinarbasi_full_assemblage', 'pinarbasi_full_immature_proportions', 'pinarbasi_post', 'pinarbasi_unmodeled_element_portion_theta'))

pinarbasi_measured_assemblage_simulated_composition <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(pinarbasi_measured_assemblage[, theta_finder(Specimen_No, Element_Portion, Immature, pinarbasi_measured_immature_proportions, element_thetas = pinarbasi_post$theta[x, , ], specimen_probs = pinarbasi_post$specimen_prob[x, , ]), .(ID, Specimen_No, Element, Element_Portion, Immature)][, .(ID, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
pinarbasi_modeled_assemblage_simulated_composition <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(pinarbasi_modeled_assemblage[, theta_finder(Specimen_No, Element_Portion, Immature, pinarbasi_modeled_immature_proportions, element_thetas = pinarbasi_post$theta[x, , ], specimen_probs = pinarbasi_post$specimen_prob[x, , ]), .(ID, Specimen_No, Element, Element_Portion, Immature)][, .(ID, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
pinarbasi_full_assemblage_simulated_composition <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_composition(pinarbasi_full_assemblage[, theta_finder(Specimen_No, Element_Portion, Immature, pinarbasi_full_immature_proportions, element_thetas = cbind(pinarbasi_post$theta[x, , ], t(pinarbasi_unmodeled_element_portion_theta[Iteration %in% x, .(theta_1, theta_2, theta_3)])), specimen_probs = pinarbasi_post$specimen_prob[x, , ]), .(ID, Specimen_No, Element, Element_Portion, Immature)][, .(ID, Specimen_No, Site_No = 1, Element, Element_Portion, Immature, p_immature, p_female, p_male)])[, .(Iteration = x, Site_No, Element_Portion, Element, Simulated_Group, N)]))
```

```{r Northwest Anatolian cattle composition analysis, include = FALSE, eval = TRUE}
#Calculating three new sets of (site and) element_portion-specific mixing probabilities for unmodeled element portions
nw_anatolian_unmodeled_element_portion_theta <- data.table(Iteration = rep(rep(1:4000, 2), 4),
                                                           Site_Num = rep(1:4, each = 4000 * 2),
                                                           Element_Portion = rep(rep(17:18, each = 4000), 4),
                                                           Element = rep(rep(c("Pel", "Uln"), each = 4000), 4))
#specify hyper-parameter values for the model
for(j in 1:4) {
  for(i in 1:2) {
    element_theta_raw <- t(sapply(1:4000, function(x) nw_anatolian_post$grand_theta_raw[x, 1:2] + nw_anatolian_post$v_site[x, j, 1:2] + MASS::mvrnorm(1, mu = rep(0, 2), Sigma = diag(nw_anatolian_post$element_sigma[x, 1:2]) %*% nw_anatolian_post$Rho_element[x, 1:2, 1:2] %*% diag(nw_anatolian_post$element_sigma[x, 1:2])) + MASS::mvrnorm(1, mu = rep(0, 2), Sigma = diag(nw_anatolian_post$interaction_sigma[x, 1:2]) %*% nw_anatolian_post$Rho_interaction[x, 1:2, 1:2] %*% diag(nw_anatolian_post$interaction_sigma[x, 1:2]))))
    nw_anatolian_unmodeled_element_portion_theta[Site_Num %in% j & Element_Portion %in% (17:18)[i], c("theta_raw_1", "theta_raw_2") := .(element_theta_raw[, 1], element_theta_raw[, 2])]
  }
}
#perform stick-breaking procedure to turn theta_raw into theta values
nw_anatolian_unmodeled_element_portion_theta[, theta_1 := boot::inv.logit(theta_raw_1 + log(0.5))]
nw_anatolian_unmodeled_element_portion_theta[, theta_2 := (1 - theta_1) * boot::inv.logit(theta_raw_2 + log(1))]
nw_anatolian_unmodeled_element_portion_theta[, theta_3 := (1 - (theta_1 + theta_2))]

nw_anatolian_additional_elements <- c("innominate bone", "ulna") #additional elements for fusion analysis

#Create the full assemblages
barcin_full_assemblage <- full_assemblage_maker(original_data = barcin, biology_code = c("Bos taurus Linnaeus, 1758", "Bos primigenius"), site_code = "Barcin", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Barcin"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements, "fused metacarpal bones 3 and 4; metacarpal bone of digit 3; metacarpal bone of digit 4; metacarpal bone of digit 5", "metatarsal bone of digit 5; metatarsal bone of digit 2; fused metatarsal bones 3 and 4"), element_key = rbind(barcin_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
ilipinar1_full_assemblage <- full_assemblage_maker(original_data = ilipinar[Period %in% c("X", "IX", "IX/VIII", "VIII", "VII")], biology_code = c("Bos taurus Linnaeus, 1758", "Bos", "Bos primigenius"), site_code = "Ilipinar", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Ilipinar 1 (Late Neolithic/Transitional)"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(ilipinar_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
ilipinar1_full_assemblage[, Site := "Ilipinar 1 (Late Neolithic/Transitional)"]
ilipinar2_full_assemblage <- full_assemblage_maker(original_data = ilipinar[Period %in% c("VI", "VI/VA", "VA", "VB")], biology_code = c("Bos taurus Linnaeus, 1758", "Bos", "Bos primigenius"), site_code = "Ilipinar", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Ilipinar 2 (Early Chalcolithic)"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(ilipinar_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
ilipinar2_full_assemblage[, Site := "Ilipinar 2 (Early Chalcolithic)"]
mentese_full_assemblage <- full_assemblage_maker(original_data = mentese, biology_code = "Bos", site_code = "Mentese", mixmod_data = nw_anatolian_mixmod_data[Site %in% "Mentese"], element_list = nw_anatolian_mixmod_data[, .N, .(Element, Element_Portion)], full_elements = c(modeled_elements, "middle phalanx", nw_anatolian_additional_elements), element_key = rbind(mentese_element_key, data.table(`Anatomy Label` = c("innominate bone", "ulna"), `Element Label` = c("Pel", "Uln"))))
mentese_full_assemblage[Anatomy %in% "calcaneus", `Proximal Fusion` := ifelse(`Distal Fusion` %in% "Distal epiphysis unfused", "Proximal epiphysis unfused", ifelse(`Distal Fusion` %in% "Distal epiphysis fusing", "Proximal epiphysis fusing", ifelse(`Distal Fusion` %in% "Distal epiphysis fused", "Proximal epiphysis fused", ifelse(`Distal Fusion` %in% "", "", NA))))] #calcaneus fusion is listed as `Distal Fusion` but is `Proximal Fusion` in other sites/codes

#Step 2: estimate male and female fusion rates for earlier-fusing and later-fusing elements
bos_element_stage_key <- data.table(Fusion_Element = c("Rad_prox", "Hum_dist", "Pel", "Sca", "PH1", "PH2", "Tib_dist", "Mtc_dist", "Mtt_dist", "Cal", "Fem_prox", "Fem_dist", "Uln", "Rad_dist", "Tib_prox", "Hum_prox"), Stage = c(1, 1, 1, 1, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4))
#
barcin_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = barcin_full_assemblage, element_stage_key = bos_element_stage_key)
ilipinar1_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = ilipinar1_full_assemblage, element_stage_key = bos_element_stage_key)
mentese_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = mentese_full_assemblage, element_stage_key = bos_element_stage_key)
ilipinar2_fusion_assemblage <- fusion_assemblage_maker(full_assemblage = ilipinar2_full_assemblage, element_stage_key = bos_element_stage_key)
#
barcin_full_immature_proportions <- barcin_full_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
ilipinar1_full_immature_proportions <- ilipinar1_full_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
ilipinar2_full_immature_proportions <- ilipinar2_full_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]
mentese_full_immature_proportions <- mentese_full_assemblage[, .(Immature_Proportion = mean(Immature)), .(Portion = Element_Portion)][order(Portion)]

clusterExport(cl, list('data.table', 'melt', 'ifm_sample', 'theta_finder', 'ifm_fusion_rate', 'barcin_fusion_assemblage', 'barcin_full_immature_proportions', 'ilipinar1_fusion_assemblage', 'ilipinar1_full_immature_proportions', 'mentese_fusion_assemblage', 'mentese_full_immature_proportions', 'ilipinar2_fusion_assemblage', 'ilipinar2_full_immature_proportions', 'nw_anatolian_post', 'nw_anatolian_unmodeled_element_portion_theta'))

barcin_full_assemblage_simulated_fusion <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_fusion_rate(barcin_fusion_assemblage[, .(ID, Site_No = 1, Specimen_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)][, theta_finder(Specimen_No, Element_Portion, Immature, barcin_full_immature_proportions, element_thetas = cbind(nw_anatolian_post$theta[x, , 1, ], t(nw_anatolian_unmodeled_element_portion_theta[Iteration %in% x & Site_Num %in% 1, .(theta_1, theta_2, theta_3)])), specimen_probs = nw_anatolian_post$specimen_prob[x, , ]), .(ID, Specimen_No, Site_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)])[, .(Iteration = x, Site_No, Fusion_Element, Stage, Fusion, Simulated_Group, N)]))
#
ilipinar1_full_assemblage_simulated_fusion <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_fusion_rate(ilipinar1_fusion_assemblage[, .(ID, Site_No = 2, Specimen_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)][, theta_finder(Specimen_No, Element_Portion, Immature, ilipinar1_full_immature_proportions, element_thetas = cbind(nw_anatolian_post$theta[x, , 2, ], t(nw_anatolian_unmodeled_element_portion_theta[Iteration %in% x & Site_Num %in% 2, .(theta_1, theta_2, theta_3)])), specimen_probs = nw_anatolian_post$specimen_prob[x, , ]), .(ID, Specimen_No, Site_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)])[, .(Iteration = x, Site_No, Fusion_Element, Stage, Fusion, Simulated_Group, N)]))
#
mentese_full_assemblage_simulated_fusion <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_fusion_rate(mentese_fusion_assemblage[, .(ID, Site_No = 3, Specimen_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)][, theta_finder(Specimen_No, Element_Portion, Immature, mentese_full_immature_proportions, element_thetas = cbind(nw_anatolian_post$theta[x, , 3, ], t(nw_anatolian_unmodeled_element_portion_theta[Iteration %in% x & Site_Num %in% 3, .(theta_1, theta_2, theta_3)])), specimen_probs = nw_anatolian_post$specimen_prob[x, , ]), .(ID, Specimen_No, Site_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)])[, .(Iteration = x, Site_No, Fusion_Element, Stage, Fusion, Simulated_Group, N)]))
#
ilipinar2_full_assemblage_simulated_fusion <- rbindlist(parLapply(cl = cl, 1:4000, fun = function(x) ifm_fusion_rate(ilipinar2_fusion_assemblage[, .(ID, Site_No = 4, Specimen_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)][, theta_finder(Specimen_No, Element_Portion, Immature, ilipinar2_full_immature_proportions, element_thetas = cbind(nw_anatolian_post$theta[x, , 4, ], t(nw_anatolian_unmodeled_element_portion_theta[Iteration %in% x & Site_Num %in% 4, .(theta_1, theta_2, theta_3)])), specimen_probs = nw_anatolian_post$specimen_prob[x, , ]), .(ID, Specimen_No, Site_No, Element, Element_Portion, Immature, Fusion_Element, Stage, Fusion)])[, .(Iteration = x, Site_No, Fusion_Element, Stage, Fusion, Simulated_Group, N)]))
#

#combine the assemblages
nw_full_anatolian_fusion <- rbind(barcin_full_assemblage_simulated_fusion, ilipinar1_full_assemblage_simulated_fusion, mentese_full_assemblage_simulated_fusion, ilipinar2_full_assemblage_simulated_fusion)
```

```{r posterior summaries and figures (archaeological), include = FALSE, eval = TRUE}
####Analyses to summarize the archaeological material (for in-text numbers and figures)####
pinarbasi_element_name_key <- data.table(
  Element = c("Ast", "Cal", "Hum", "Mtc_dist", "Mtt_dist", "Mtt_prox", "PH1", "Rad_dist", "Tib_dist", "Tib_prox", "Rad_prox", "Mtc_prox", "Pel", "PH2", "Uln"),
  Full_Element_Name = c("Astragalus", "Calcaneus", "Humerus", "D. Metacarpal", "D. Metatarsal", "P. Metatarsal", "Proximal Phalanx", "D. Radius", "D. Tibia", "P. Tibia", "P. Radius", "P. Metacarpal", "Pelvis", "Middle Phalanx", "Ulna")
)

pinarbasi_pi_df <- data.table(Iteration = rep(1:4000, 3), 
                                       Group = rep(c("Immature", "Female", "Male"), each = 4000),
                                       theta = c(pinarbasi_post$grand_theta))
#
pinarbasi_element_pi_df <- data.table(Iteration = rep(rep(1:4000, 3), 10), 
                              Group = rep(rep(factor(c("Immature", "Female", "Male"), levels = c("Immature", "Female", "Male")), each = 4000), 10),
                              Element = rep(pinarbasi_mixmod_data[, .N, .(Element_Portion, Element)][order(Element_Portion), Element], each = 4000 * 3),
                              Element_Portion = rep(pinarbasi_mixmod_data[, .N, .(Element_Portion, Element)][order(Element_Portion), Element_Portion], each = 4000 * 3),
                              theta = c(pinarbasi_post$theta))
#
nw_anatolian_site_mu_df <- data.table(Iteration = rep(rep(1:4000, 3), 4),
                                      Group = rep(factor(c("Immature", "Female", "Male"), levels = c("Immature", "Female", "Male")), each = 4000 * 4),
                                      Site = rep(rep(nw_anatolian_mixmod_data[, .N, .(Site, Site_No)][order(Site_No), Site], each = 4000), 3),
                                      Site_No = rep(rep(nw_anatolian_mixmod_data[, .N, .(Site, Site_No)][order(Site_No), Site_No], each = 4000), 3),
                                      mu = c(cbind(nw_anatolian_post$site_mu_immature, nw_anatolian_post$site_mu_female, nw_anatolian_post$site_mu_male)))
#
nw_anatolian_mu_contrasts <- nw_anatolian_site_mu_df[, .(Site = ifelse(Site_No %in% 1, "Barcin", ifelse(Site_No %in% 2, "Ilipinar_Neolithic", ifelse(Site_No %in% 3, "Mentese", "Ilipinar_Chalcolithic"))), Site_No, Barcin = mu - mu[Site_No %in% 1], Ilipinar_Neolithic = mu - mu[Site_No %in% 2], Mentese = mu - mu[Site_No %in% 3], Ilipinar_Chalcolithic = mu - mu[Site_No %in% 4]), .(Iteration, Group)]
nw_anatolian_mu_contrasts <- melt(nw_anatolian_mu_contrasts, id.vars = c("Iteration", "Group", "Site_No", "Site"), measure.vars = c("Barcin", "Ilipinar_Neolithic", "Mentese", "Ilipinar_Chalcolithic"), variable.name = "Comparand", value.name = "Contrast")[Site != Comparand]
nw_anatolian_mu_contrasts[, "Comparison" := .(paste(Comparand, Site, sep = "."))]
#
nw_anatolian_posterior_data <- data.table(Iteration = rep(1:4000, 4), Site_No = rep(1:4, each = 4000), Site = rep(nw_anatolian_mixmod_data[, .N, .(Site_No, Site)][order(Site_No), Site], each = 4000), p_immature = c(nw_anatolian_post$site_p_immature), sex_ratio = c(nw_anatolian_post$site_theta_female), mu_female = c(nw_anatolian_post$site_mu_female))
nw_anatolian_posterior_data[, euclidean_dist_demographic := .(sqrt((p_immature - mean(p_immature))^2 + (sex_ratio - mean(sex_ratio))^2)), Site_No]
#
hull_data <- rbind(
  rbindlist(lapply(1:4, function(x) data.table(Site_No = x, CI = 1.00, nw_anatolian_posterior_data[Site_No %in% x][chull(nw_anatolian_posterior_data[Site_No %in% x, .(p_immature, sex_ratio)]), .(p_immature, sex_ratio)]))),
  rbindlist(lapply(1:4, function(x) data.table(Site_No = x, CI = 0.95, nw_anatolian_posterior_data[Site_No %in% x & euclidean_dist_demographic <= quantile(euclidean_dist_demographic, 0.95)][chull(nw_anatolian_posterior_data[Site_No %in% x & euclidean_dist_demographic <= quantile(euclidean_dist_demographic, 0.95), .(p_immature, sex_ratio)]), .(p_immature, sex_ratio)]))),
  rbindlist(lapply(1:4, function(x) data.table(Site_No = x, CI = 0.80, nw_anatolian_posterior_data[Site_No %in% x & euclidean_dist_demographic <= quantile(euclidean_dist_demographic, 0.80)][chull(nw_anatolian_posterior_data[Site_No %in% x & euclidean_dist_demographic <= quantile(euclidean_dist_demographic, 0.80), .(p_immature, sex_ratio)]), .(p_immature, sex_ratio)])))
)
#
ilipinar2_mu2_contrasts <- nw_anatolian_mu_contrasts[Comparand %in% "Ilipinar_Chalcolithic" & Group %in% "Female", Contrast, Site]

####Summarizing the archaeological assemblages####
pinarbasi_posterior_summary <- list(
  pinarbasi_pi1_median = paste0(round(100 * median(pinarbasi_post$p_immature), 0), "%"),
  pinarbasi_pi1_95CI = paste0(round(100 * quantile(pinarbasi_post$p_immature, 0.025), 0), "-", round(100 * quantile(pinarbasi_post$p_immature, 0.975), 0), "%"),
  pinarbasi_age_observation = pinarbasi_demographic_observations[, paste0("(", N_Unfused, " / ", N_Ageable, " = ", round(100 * (N_Unfused / N_Ageable), 0), "%)")],
  pinarbasi_femaletheta_over50 = paste0(round(100 * mean(pinarbasi_post$theta_female >= 0.5), 0), "%"),
  pinarbasi_measured_specimens_N = pinarbasi_measured_assemblage[, .N],
  pinarbasi_modeled_specimens_N = pinarbasi_modeled_assemblage[, .N],
  pinarbasi_full_specimens_N = pinarbasi_full_assemblage[, .N]
)
#
nw_anatolian_posterior_summary <- list(
  ilipinar2_avg_contrast = ilipinar2_mu2_contrasts[, .(avg_contrast = mean(Contrast)), Site][, paste0(round(100 * min(avg_contrast), 0), "-", round(100 * max(avg_contrast), 0), "%")],
  ilipinar2_sex_fusion_bias = paste0(nw_full_anatolian_fusion[Stage %in% 4 & Site_No %in% 4, .(N = sum(N)), .(Iteration, Fusion, Simulated_Group)][Simulated_Group %in% c("Female", "Male"), .(Pct_Fused = N[Fusion %in% "Fused"] / sum(N)), .(Iteration, Simulated_Group)][, .(Female_Minus_Male = Pct_Fused[Simulated_Group %in% "Female"] - Pct_Fused[Simulated_Group %in% "Male"]), .(Iteration)][, round(100 * mean(Female_Minus_Male >= 0, na.rm = T), 0)], "%"),
  barcin_thetafemale_over60 = paste0(round(100 * mean(nw_anatolian_post$site_theta_female[, 1] >= 0.60), 0), "%"),
  barcin_thetafemale_over75 = paste0(round(100 * mean(nw_anatolian_post$site_theta_female[, 1] >= 0.75), 0), "%"),
  ilipinar1_thetafemale_over80 = paste0(round(100 * mean(nw_anatolian_post$site_theta_female[, 2] > 0.80), 0), "%")
)
#
```

```{r make figure 9, include = FALSE, eval = TRUE}
#Figure 9: Pinarbasi B Sheep proportions (overall and by element)
pinarbasi_pi_overall_plot <- ggplot(pinarbasi_pi_df) + aes(y = theta, x = Group) +
  stat_slab(normalize = "groups", aes(fill = Group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Group), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Group", limits = c("Immature", "Female", "Male")) +
  scale_y_continuous(name = "Proportion", labels = scales::percent, limits = c(0, 1.02)) + coord_cartesian(expand = FALSE) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10, angle = -90, hjust = 0), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
#
pinarbasi_pi_element_plot <- ggplot(pinarbasi_element_pi_df[, .(Iteration, Group, Element, Element_Portion, theta, Plot_Group = paste(Element, as.numeric(Group), sep = "."))]) + aes(y = theta, x = Plot_Group) +
  stat_slab(normalize = "groups", aes(fill = Group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Group), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("black", "blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Element", breaks = pinarbasi_element_pi_df[, .N, .(Element, Element_Portion)][order(Element_Portion), paste(Element, ".2", sep = "")], labels = pinarbasi_element_pi_df[, .N, .(Element, Element_Portion)][pinarbasi_element_name_key, on = "Element"][!is.na(Element_Portion)][order(Element_Portion), Full_Element_Name]) +
  scale_y_continuous(name = "Proportion", labels = scales::percent, limits = c(0, 1.02)) + coord_cartesian(expand = FALSE) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10, angle = -90, hjust = 0), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))
#
figure_9 <- ggarrange(pinarbasi_pi_overall_plot, pinarbasi_pi_element_plot, ncol = 2, nrow = 1, widths = c(1, 4), labels = c("A", "B"), common.legend = T, legend = "bottom")
#
Cairo(width = 10, height = 7, units = "in", file = "./Output/Figures/figure_9.png", type = "png", dpi = 600)
figure_9
dev.off()
```

```{r make figure 10, include = FALSE, eval = TRUE}
#Figure 10: Estimated composition of Pinarbasi B Measured, Modeled, and Full Assemblages
pinarbasi_measured_composition <- archaeological_composition_analysis(pinarbasi_measured_assemblage_simulated_composition, site_no = 1, site_name = "Measured Assemblage")
pinarbasi_modeled_composition <- archaeological_composition_analysis(pinarbasi_modeled_assemblage_simulated_composition, site_no = 1, site_name = "Modeled Assemblage")
pinarbasi_full_composition <- archaeological_composition_analysis(pinarbasi_full_assemblage_simulated_composition, site_no = 1, site_name = "Full Assemblage")
#
pinarbasi_composition_plots <- ggarrange(pinarbasi_measured_composition, pinarbasi_modeled_composition, pinarbasi_full_composition, nrow = 3, ncol = 1, common.legend = T, legend = "bottom")
#
figure_10 <- annotate_figure(pinarbasi_composition_plots, top = text_grob("Estimated Composition of Pinarbaşı B Sheep", face = "bold", size = 14))
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_10.png", type = "png", dpi = 600)
figure_10
dev.off()
```

```{r make figure 11, include = FALSE, eval = TRUE}
#Figure 11: NW Anatolian Body Size and Contrasts
size_plot <- ggplot(nw_anatolian_site_mu_df[Group %in% "Female", .(Iteration, Group, Site, Site_No, mu, Plot_Group = paste(Site_No, as.numeric(Group), sep = "."))]) + aes(y = mu, x = Plot_Group) +
  stat_slab(normalize = "groups", aes(fill = as.factor(Site_No), fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = as.factor(Site_No)), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar")) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), na.translate = F, labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar")) +
  scale_y_continuous(name = "Female Average LSI Value") +
  scale_x_discrete(name = "Site", breaks = nw_anatolian_site_mu_df[, .N, .(Site, Site_No)][order(Site_No), paste(Site_No, ".2", sep = "")], labels = c("Barcın Höyük", "Neolithic Ilıpınar", "Menteşe Höyük", "Chalcolithic Ilıpınar")) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_blank(), axis.title.x = element_blank(), axis.title = element_text(size = 12), axis.text.y = element_text(angle = 0, size = 10, hjust = 0.5))

#making contrasts for female body size
barcin_plot <- ggplot(nw_anatolian_mu_contrasts[Site_No %in% 1 & Group %in% "Female"]) + aes(x = Contrast, y = Comparand) +
  geom_vline(xintercept = 0) +
  stat_slab(normalize = "groups", aes(fill = Comparand, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Comparand), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), na.translate = F, labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_x_continuous(name = "", limits = c(-0.15, 0.15)) +
  scale_y_discrete(name = element_blank()) +
  labs(subtitle = "Barcın Höyük") +
  theme_classic() + theme(legend.text = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size = 10), axis.title = element_blank(), axis.text.y = element_blank())

ilipinar1_plot <- ggplot(nw_anatolian_mu_contrasts[Site_No %in% 2 & Group %in% "Female"]) + aes(x = Contrast, y = Comparand) +
  geom_vline(xintercept = 0) +
  stat_slab(normalize = "groups", aes(fill = Comparand, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Comparand), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), na.translate = F, labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_x_continuous(name = "", limits = c(-0.15, 0.15)) +
  scale_y_discrete(name = element_blank()) +
  labs(subtitle = "Neolithic Ilıpınar") +
  theme_classic() + theme(legend.text = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size = 10), axis.title = element_blank(), axis.text.y = element_blank())

mentese_plot <- ggplot(nw_anatolian_mu_contrasts[Site_No %in% 3 & Group %in% "Female"]) + aes(x = Contrast, y = Comparand) +
  geom_vline(xintercept = 0) +
  stat_slab(normalize = "groups", aes(fill = Comparand, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Comparand), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), na.translate = F, labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_x_continuous(name = "", limits = c(-0.15, 0.15)) +
  scale_y_discrete(name = element_blank()) +
  labs(subtitle = "Menteşe Höyük") +
  theme_classic() + theme(legend.text = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size = 10), axis.title = element_blank(), axis.text.y = element_blank())

ilipinar2_plot <- ggplot(nw_anatolian_mu_contrasts[Site_No %in% 4 & Group %in% "Female"]) + aes(x = Contrast, y = Comparand) +
  geom_vline(xintercept = 0) +
  stat_slab(normalize = "groups", aes(fill = Comparand, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = Comparand), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), na.translate = F, labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_x_continuous(name = "", limits = c(-0.15, 0.15)) +
  scale_y_discrete(name = element_blank()) +
  labs(subtitle = "Chalcolithic Ilıpınar") +
  theme_classic() + theme(legend.text = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size = 10), axis.title = element_blank(), axis.text.y = element_blank())

contrast_plot <- ggarrange(barcin_plot, ilipinar1_plot, mentese_plot, ilipinar2_plot, nrow = 4, ncol = 1, common.legend = T, align = c("hv"), legend = "none")
contrast_plot <- annotate_figure(contrast_plot, bottom = "Size Contrast (LSI)")
#
figure_11 <- ggarrange(size_plot, contrast_plot, common.legend = T, legend = "bottom")
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_11.png", type = "png", dpi = 600)
figure_11
dev.off()
```

```{r make figure 12, include = FALSE, eval = TRUE}
#Figure 12: NW Anatolian Age/Sex Parameters (Biplot)
#middle panel: bivariate plot
central_plot <- ggplot(nw_anatolian_posterior_data) + aes(x = p_immature, y = sex_ratio) +
  geom_point(data = nw_anatolian_posterior_data[, .(p_immature = mean(p_immature), sex_ratio = mean(sex_ratio), mu_female = mean(mu_female)), Site_No], aes(col = as.factor(Site_No))) +
  geom_polygon(data = hull_data[CI %in% 1.00], aes(fill = as.factor(Site_No), color = as.factor(Site_No)), alpha = 0.3) +
  geom_polygon(data = hull_data[CI %in% 0.95], aes(fill = as.factor(Site_No), color = as.factor(Site_No)), alpha = 0.20) + #should add up to alpha = 0.5
  geom_polygon(data = hull_data[CI %in% 0.80], aes(fill = as.factor(Site_No), color = as.factor(Site_No)), alpha = 0.30) + #should add up to alpha = 0.8
  scale_y_continuous(name = "Adult Sex Ratio (%Female)", labels = scales::percent, limits = c(0.00, 1.00)) +
  scale_x_continuous(name = "Proportion Immature (%Immature)", labels = scales::percent, limits = c(0.00, 1.00)) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  coord_cartesian(expand = FALSE) +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 270, size = 10, hjust = 0.05, vjust = 1), axis.title = element_text(size = 12), axis.text.y = element_text(angle = 45, size = 10, hjust = 0.5))
#
upper_plot <- ggplot(nw_anatolian_posterior_data) + aes(x = p_immature, y = as.factor(Site_No)) +
  stat_slab(normalize = "groups", aes(fill = as.factor(Site_No), fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = as.factor(Site_No)), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_x_continuous(name = "", labels = scales::percent, limits = c(0.00, 1.00)) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  coord_cartesian(expand = FALSE) +
  theme_classic() + theme(axis.line.y = element_blank(), axis.ticks = element_blank(), axis.text.x = element_blank(), axis.title = element_blank(), axis.text.y = element_blank())
#
side_plot <- ggplot(nw_anatolian_posterior_data) + aes(x = as.factor(Site_No), y = sex_ratio) +
  stat_slab(normalize = "groups", aes(fill = as.factor(Site_No), fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = as.factor(Site_No)), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_y_continuous(name = "", labels = scales::percent, limits = c(0.00, 1.00)) +
  scale_color_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  scale_fill_manual(name = "Site", values = c("#e66101", "#b2abd2", "#fdb863", "#5e3c99"), labels = c("1" = "Barcın Höyük", "2" = "Neolithic Ilıpınar", "3" = "Menteşe Höyük", "4" = "Chalcolithic Ilıpınar"), drop = FALSE) +
  coord_cartesian(expand = FALSE) +
  theme_classic() + theme(axis.line.x = element_blank(), axis.ticks = element_blank(), axis.text.x = element_blank(), axis.title = element_blank(), axis.text.y = element_blank())
#
figure_12 <- ggarrange(upper_plot, NULL, central_plot, side_plot, ncol = 2, nrow = 2, heights = c(1, 2), widths = c(2, 1), align = "hv", common.legend = T, legend = "bottom")
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_12.png", type = "png", dpi = 600)
figure_12
dev.off()
```

```{r make figure 13, include = FALSE, eval = TRUE}
#Figure 13: NW Anatolian Sex-Specific Fusion Distributions
figure_13 <- ggplot(nw_full_anatolian_fusion[Stage %in% 3:4, .(N = sum(N)), .(Iteration, Site_No, Fusion, Simulated_Group)][, .(Pct_Fused = N[Fusion %in% "Fused"] / sum(N), N = sum(N)), .(Iteration, Site_No, group = Simulated_Group)][group %in% c("Female", "Male") & N > 0, .(Pct_Fused, group, Plot_Group = paste(Site_No, as.numeric(group), sep = "."))]) + aes(x = Plot_Group, y = Pct_Fused) +
  stat_slab(normalize = "groups", aes(fill = group, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = group), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.8, 0.3), na.translate = F) +
  scale_color_manual(name = "Group", values = c("blue", "red"), na.translate = F) +
  scale_fill_manual(name = "Group", values = c("blue", "red"), na.translate = F) +
  scale_x_discrete(name = "Assemblage", labels = c("1.3" = "Barcın Höyük", "2.3" = "Neolithic Ilıpınar", "3.3" = "Menteşe Höyük", "4.3" = "Chalcolithic Ilıpınar"), breaks = c("1.3", "2.3", "3.3", "4.3"),
                   limits = c("1.2", "1.3", "2.2", "2.3", "3.2", "3.3", "4.2", "4.3")) +
  scale_y_continuous(name = "Percentage Fused", labels = scales::percent, limits = c(0, 1.02)) +
  coord_cartesian(expand = FALSE) + labs(title = "Sex-Stratified Fusion Rates for Late-Fusing Epiphyseal Ends") +
  theme_classic() + theme(legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 270, size = 10, hjust = 0.05, vjust = 1), axis.title = element_text(size = 12), axis.text.y = element_text(angle = 45, size = 10, hjust = 0.5))
#
Cairo(width = 10, height = 10, units = "in", file = "./Output/Figures/figure_13.png", type = "png", dpi = 600)
figure_13
dev.off()
```

```{r making supplementary results tables, echo = FALSE}
#Creating supplemental tables 1-5 (Simulated Results, Simulated Demographic Observations, Archaeological Results)

#Simulated Demographic Observations (as a single table)
simulated_demographic_observations <- rbind(single_assemblage_demographic_observations,
                                            multisite_demographic_observations)

#Measurement assemblages and posterior mean of membership probabilities for specimens: Simulations
simulated_single_assemblage_results <- single_assemblage_mixmod_data[, .N, .(Individual_No, Specimen_No, Element, Immature, Group)][order(Specimen_No), .(Individual_No, Specimen_No, Element, Immature, Group, p_immature = round(colMeans(single_assemblage_post$specimen_prob[, , 1]), 2), p_female = round(colMeans(single_assemblage_post$specimen_prob[, , 2]), 2), p_male = round(colMeans(single_assemblage_post$specimen_prob[, , 3]), 2))]
#
simulated_multisite_results <- multisite_mixmod_data[, .N, .(Site_No, Individual_No, Specimen_No, Element, Immature, Group)][order(Specimen_No), .(Site_No, Individual_No, Specimen_No, Element, Immature, Group, p_immature = round(colMeans(multisite_post$specimen_prob[, , 1]), 2), p_female = round(colMeans(multisite_post$specimen_prob[, , 2]), 2), p_male = round(colMeans(multisite_post$specimen_prob[, , 3]), 2))]

#Measurement assemblages and posterior mean of membership probabilities for specimens: Archaeological Case Studies
pinarbasi_results <- pinarbasi_mixmod_data[, .N, .(Specimen_No, Element, Immature)][order(Specimen_No), .(Specimen_No, Element, p_immature = round(colMeans(pinarbasi_post$specimen_prob[, , 1]), 2), p_female = round(colMeans(pinarbasi_post$specimen_prob[, , 2]), 2), p_male = round(colMeans(pinarbasi_post$specimen_prob[, , 3]), 2))]
#
nw_anatolian_results <- nw_anatolian_mixmod_data[, .N, .(Specimen_No, Site_No, Site, Element, Immature)][order(Specimen_No), .(Specimen_No, Site_No, Site, Element, p_immature = round(colMeans(nw_anatolian_post$specimen_prob[, , 1]), 2), p_female = round(colMeans(nw_anatolian_post$specimen_prob[, , 2]), 2), p_male = round(colMeans(nw_anatolian_post$specimen_prob[, , 3]), 2))]

####Export the relevant files####
write.csv(simulated_demographic_observations, file = "./Output/Table S1 - Simulated Demographic Observations.csv", row.names = F)
write.csv(simulated_single_assemblage_results, file = "./Output/Table S2 - Single Assemblage Simulation Results (Measurement Assemblage).csv", row.names = F)
write.csv(simulated_multisite_results, file = "./Output/Table S3 - Multisite Simulation Results (Measurement Assemblage).csv", row.names = F)
#
write.csv(pinarbasi_results, file = "./Output/Table S4 - Pinarbasi Sheep Results (Measurement Assemblage).csv", row.names = F)
write.csv(nw_anatolian_results, file = "./Output/Table S5 - NW Anatolian Cattle Results (Measurement Assemblage).csv", row.names = F)
```

#### *4.2.1 Pinarbaşı B Sheep*\

Figure 9A shows the posterior distributions assemblage-level $\pi$ mixture components. In general, the Pinarbaşı B sheep assemblage is overwhelmingly composed of immature animals (posterior $\pi_1$ median = `r pinarbasi_posterior_summary$pinarbasi_pi1_median`; 95% posterior confidence interval for $\pi_1$ = `r pinarbasi_posterior_summary$pinarbasi_pi1_95CI`), somewhat lower than the observed fusion rate of proximal and middle phalanges `r pinarbasi_posterior_summary$pinarbasi_age_observation`. The posterior distribution of the overall adult sex ratio ($\theta_{\operatorname{female}}$) suggests that females are more common than males (`r pinarbasi_posterior_summary$pinarbasi_femaletheta_over50` of the posterior samples are above 0.5), but this estimate is uncertain, owing to the low overall proportions of female and male animals.

```{r figure_9, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of (A) Overall Mixture Components ($\\pi$) and (B) Element-Specific Mixture Components ($\\pi$) for the Pinarbaşı B Sheep Assemblage"}
knitr::include_graphics("./Output/Figures/figure_9.png")
```

Figure 9B shows the element-specific distributions of $\pi_1$ for the Pinarbaşı B assemblage. Half of the element-specific $\pi_1$ distributions are similarly concentrated in the upper range of possible $\pi_1$ values, with posterior medians over 85%; all specimens from these element portions were considered potentially immature by the model due to fusion status or being an element that does not fuse or exhibits post-fusion growth. However, these element-specific distributions also have long tails extending into lower $\pi_1$ values, conveying less certainty about element-specific $\pi_1$ estimates relative to the assemblage-wide estimate. This likely owes to small element-specific sample sizes (the astragalus, calcaneus, and proximal phalanx have 9-10 specimens, all other element-specific samples sizes are 1-4, see Table 4) and to the presence of some element portions with lower modeled $\pi_1$ values. These element portions—especially the distal metacarpal and distal metatarsal—have posterior $\pi_1$ median values below 50%, though again have long tails that extend into higher $\pi_1$ values. Notably, all measured specimens from these two elements are not considered potentially immature because their distal epiphyses are fused.

```{r figure_10, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Group-Specific Composition for the Pinarbaşı B Sheep Measured, Modeled, and Full Assemblages"}
knitr::include_graphics("./Output/Figures/figure_10.png")
```

Figure 10 shows the distribution of simulated compositions for immature, female, and male specimens in three Pinarbaşı B assemblages: the measured assemblage (N = `r pinarbasi_posterior_summary$pinarbasi_measured_specimens_N`), the assemblage of modeled element portions (N = `r pinarbasi_posterior_summary$pinarbasi_modeled_specimens_N`), and the full sheep assemblage including five element portions that were not modeled due to lack of measurements (additional elements: proximal radius, ulna, proximal fused metacarpal 3 and 4, pelvis, and middle phalanx; total N = `r pinarbasi_posterior_summary$pinarbasi_full_specimens_N`). While the model has much greater precision in estimating the composition of the measured assemblage, including the non-measured specimens in the modeled assemblage provides a clearer overall picture of the assemblage. Most element portions are composed predominantly of immature specimens rather than adults (males or females), with the notable exceptions of distal metapodials and, to a lesser extent, the distal radius. Inclusion of the unmodeled elements broadly reinforces this pattern, while providing data to explore fusion rates or comparisons of larger animal portions.

#### *4.2.2 7th-6th Millennium BCE Northwest Anatolian Cattle*\

Figure 11 shows the posterior distributions of average body sizes for female cattle ($\mu_2$) from the four analyzed assemblages. These distributions are produced from posterior samples; assemblage-specific estimates from a single posterior sample share the same relevant hyper-parameters ($\mu_{\mu_2}$ and $\sigma_{\operatorname{site}[4]}$), meaning that they covary with one another to an extent. To compare these distributions, then, a contrast is necessary to account for this potential covariation. This is done by simply evaluating the difference between two parameters (e.g., between the average female $\operatorname{LSI}_e$ value $\mu_2$ for Barcın Höyük and $\mu_2$ for Neolithic Ilıpınar) in each posterior sample, shown in the right-hand panel of Figure 11. These contrasts show that the the female cattle from Chalcolithic Ilıpınar are likely smaller, on average, than female cattle from the other sites. These cattle measurements are `r nw_anatolian_posterior_summary$ilipinar2_contrast_range` smaller, on average, than those from the other northwestern Anatolian sites relative to the standard animal’s measurements.

```{r figure_11, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Site-Specific Average Female LSI Values ($\\mu_2$) for the Northwest Anatolian Cattle Assemblages. The right panel shows site-specific contrasts for this parameter, indicating specific size differences between pairs of sites"}
knitr::include_graphics("./Output/Figures/figure_11.png")
```

Despite this size difference in female animals between the assemblages, the age and sex composition of the four assemblages are broadly consistent with one another. Figure 12 shows the distributions of assemblage-level demographic variables—the proportion of immature animals and the adult sex ratio (the proportion of adults that are female)—for the four northwest Anatolian assemblages. As expected from earlier syntheses that indicated herds kept to produce milk, all of the assemblages have female-dominated adult sex ratios. The relatively large proportions of immature cattle in the Menteşe Höyük and Barcın Höyük assemblages may indicate that cattle were penned on the site, where infants killed by herders or natural causes were included in the assemblage [@gillis_etal_2014; @gillis_etal_2015]. Contrasts indicate that both Ilıpınar Höyük assemblages have lower the proportions of immature animals than either the Barcın Höyük or Menteşe Höyük assemblages. This suggests that, despite evidence for penning deposits on-site for Chalcolithic Ilıpınar [@roodenberg_2012_article], cattle were not giving birth at the site or immature specimens did not preserve as well [@gillis_etal_2014]. The small proportion of very young mandibles in the assemblage corroborates the biometric modeling results [@buitenhuis_2008: Figure 18].

```{r figure_12, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Comparison Posterior Distributions of Site-Specific Demographic Parameters ($\\pi_{\\operatorname{immature}}$ and $\\theta_{\\operatorname{female}}$) for the Northwest Anatolian Cattle Assemblages. Side panels show marginal plots to compare the distributions of each parameter individually across sites"}
knitr::include_graphics("./Output/Figures/figure_12.png")
```

Simulating sex-specific fusion rates for late-fusing elements [proximal femur, distal femur, proximal humerus, distal radius, proximal tibia, proximal ulna: @grigson_1982] from the full northwest Anatolian assemblages highlights the complexities of examining sex-specific fusion rates in zooarchaeological assemblages. In each assemblage, estimates of male fusion rates are extremely uncertain, owing to the small number of estimated males in each iteration and thus large potential shifts in the denominator for fusion rates (Figure 13). This uncertainty makes it difficult to clearly establish whether fusion rates differed between males and females; regardless, in `r nw_anatolian_posterior_summary$ilipinar2_sex_fusion_bias` of the posterior samples female fusion rates were higher than male fusion rates for Chalcolithic Ilıpınar. This provides some support for the idea that males in the assemblage were killed at younger ages than females, consistent with a milk-producing management strategy that kept females alive longer than males [@zeder_hesse_2000; @gillis_etal_2014].

```{r figure_13, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Posterior Distributions of Sex-Specific Fusion Rates for Late-Fusing Elements in Northwest Anatolian Cattle Assemblages"}
knitr::include_graphics("./Output/Figures/figure_13.png")
```

## 5. DISCUSSION

The simulation analyses show that the Bayesian multilevel mixture model presented here can accurately reconstruct age- and sex-specific biometry of a faunal population represented in a measured assemblage, while also producing relatively accurate estimates of the “demographic” (age and sex) composition of the assemblage. The performance of the Bayesian multilevel mixture models relies on the prior distributions, which provide constraints against overfitting and ensure that the model produces biologically reasonable parameter estimates. The prior distribution definitions in this paper were derived largely from the measurements of a herd of known-age, known-sex population of Shetland sheep [@popkin_etal_2012], though for the multisite cattle model some of the definitions were changed based on data on European aurochsen [@degerbol_1970]. It is important to note that prior distribution definitions can be derived from many different sources—including quantification based on one’s judgment [e.g., @gelman_etal_2008; @mccarthy_masters_2005]. More important than the source of one’s prior distribution definitions, is investigating the expectations of those prior distribution definitions by performing prior predictive checks as in Section 2.3 [@gabry_etal_2019; @gelman_etal_2020_workflow]. Further, emphasis should be paid to increasing the diversity of known-age, known-sex animal populations with individual measurement data [e.g., @lebenzon_munro_2022; @zeder_lemoine_2020], which could help develop prior distributions relevant to different taxa and to understand how variable different parameters, especially size variability ($\sigma$) parameters, are across populations.

One of the central tenets of the mixture model's extension to modeled assemblages is the idea that "measurability" (adequate preservation to maintain a biological measurement) is unrelated to a specimen's status as immature, female, or male. Variation in the mixture proportions $\pi$ among elements, especially the proportion of immature specimens ($\pi_1$) may highlight group-specific biases in the deposition of specimens but could also indicate issues with the assumption that "measurability" is random. The Pinarbaşı B sheep assemblage potentially demonstrates this issue, as the distal metapodials have much lower element-specific $\pi_1$ estimates than other element portions. While it is plausible that metapodial bones from adult sheep were selectively over-represented in the assemblage, say as a cache of raw materials, it is also likely that distal metapodials from immature animals-particularly very young animals-are less likely to be measurable compared to adult animals. Because the distal breadth measurement requires both distal condyles to be present, distal metapodial specimens from neonatal or extremely juvenile individuals may be missed while those from other element portions (e.g., proximal metapodial, distal humerus) would still be theoretically measurable [@martin_garciagonzalez_2015]. The inclusion of condyle-specific measurements could address this issue, though would require identifying whether the isolated condyle is medial or lateral [e.g., width of condyle: @payne_1969]. Still, noting this inter-element discrepancy in the Pinarbaşı sheep material provides more nuance to the understanding of the assemblage's composition by further corroborating the argument that many of the immature remains derive from neonatal individuals [@carruthers_2005].

The ability to create accurate simulated estimates of age and sex composition provides many opportunities for further analyses. For instance, comparison of the composition of animals in different depositional contexts could support contextual taphonomic analyses [e.g., @meier_2020]. Access to certain kinds of animals could highlight systems of provisioning or status-related restrictions [@arbuckle_2012; @twiss_2019: 73-97]. Differences in the age and sex composition of different body parts could also highlight ritual behaviors reflected in the use of certain contexts or sites [e.g., @madgwick_mulville_2015]. On a more practical level, providing specimen-specific probabilities of being immature, female, or male can provide a useful baseline for sampling strategies focused on ancient DNA or stable isotopes, allowing researchers to explore potential sex differences in diets [e.g., @post_etal_2001] or more easily identify male specimens to isolate Y-chromosomal DNA to explore sex-specific selection [e.g., @mcgrory_etal_2012; @daly_etal_2021].

The archaeological case studies highlight the importance of considering the presence of immature specimens and elemental variation in body size when summarizing the biometry and composition of an assemblage, problems addressed by the Bayesian multilevel mixture model. Variation in the proportion of immature animals in the assemblage, as in the multisite case study for northwestern Anatolia, may also highlight differences in culling strategies or even the seasonality of animal presence at the sites. The vast majority of the Pinarbaşı B material derives from immature specimens, which could complicate inter-assemblage biometric analyses that do not use sex-specific size estimates [e.g., @arbuckle_etal_2014]. Restricting measurements only to fused specimens removes useful information, particularly when fusion rates may differ between male and female animals [@zeder_hesse_2000]; further, it does not resolve the problem of immature animals in the measurement assemblage if early-fusing elements like the distal humerus are still included because of post-fusion growth [@popkin_etal_2012]. The ability to create sex-specific biometric estimates is important to document large-scale spatial and temporal dynamics in animal body size [e.g., @arbuckle_etal_2016].

The increased ability to specify the age and sex composition of faunal assemblages with Bayesian multilevel mixture models also highlights the limitations of our current language used to describe and interpret these compositions. Many discussions that examine changes in the composition of faunal assemblages to identify changes in exploitation patterns use terms like “prime-dominated age structure” [e.g., @stiner_1990], “dominance of females,” [e.g., @peters_etal_2005] or “young male slaughter/kill-off” [e.g., @zeder_hesse_2000; @arbuckle_atici_2013]. These terms are deceptive in their utility—they describe some empirical pattern but it is up to the individual researcher to define the cut-off between a “dominant” and “non-dominant” assemblage. In the case of the adult sex ratio for Barcın Höyük, `r nw_anatolian_posterior_summary$barcin_thetafemale_over60` of the posterior samples are above 60% (1.5 females:1 male), but only `r nw_anatolian_posterior_summary$barcin_thetafemale_over75` of the posterior samples are over 75% (3 females:1 male). Meanwhile, `r nw_anatolian_posterior_summary$ilipinar1_thetafemale_over80` of the posterior samples for the adult sex ratio for Neolithic Ilıpınar are over 80% (4 females:1 male). Are both assemblages “dominated by females”? More formalized language in our hypotheses—or, rather, the adoption of statistical modeling frameworks [@mcelreath_2020_rethinkingbook: 4-17]—is necessary to clarify what changes in assemblage-level estimates of biometry and composition mean for past human-animal interactions.

## 6. CONCLUSIONS

This paper describes a new method for estimating the biometry and age/sex composition of faunal assemblages based on standard measurement data, Bayesian multilevel mixture modeling. The model produces accurate estimates of sex-specific biometry, which can provide a more useful framework for inter-assemblage analysis [e.g., @arbuckle_etal_2016; @helmer_etal_2005]. Such a framework could better explore broad spatial and chronological patterns in animal biometry while accounting for differences in assemblage composition across the assemblages, ensuring reliable comparisons of animal body size in relation to other variables. These analyses could investigate the processes behind size fluctuation in animals, particular in relation to changing human-animal interactions and adaptation to new lifeways and anthropogenic environments.

Furthermore, the estimates of the age and sex composition of the assemblage can be used to simulate assemblages of specimens with known group assignment (immature, female, and male). These simulations are the baseline for comparing differences in the composition of sub-assemblages. Doing so allows researchers to directly test hypotheses about differences in the age and sex composition of animal bones from different parts of a site, different fusion groups, or other categories. The Bayesian structure of the model allows researchers the flexibility to create bespoke hypotheses that can be tested directly, rather than relying on null hypothesis testing for inference [@otarolacastillo_torquato_2018; @otarolacastillo_etal_2022]. Thus, the mixture modeling framework described here provides a foundation for biometric and compositional analyses that operate at multiple scales and present a new avenue for summarizing and comparing zooarchaeological assemblages.

## ACKNOWLEDGEMENTS

The initial modeling work was developed as part of my dissertation research, which as partially funded by a Wenner-Gren Foundation Dissertation Fieldwork Grant (Grant #9192). I am grateful to the comments and insights on earlier versions of this manuscript from Zenobie Garrett and Heather Lynch. Any errors are my own.

## References

<div id = "refs"></div>

\newpage

## Appendix 1 (Supplemental Table 6)

### *Posterior Summary Tables for Overall and Site-Level Model Parameters: Simulated Assemblages*

```{r simulated single assemblage posterior table, include = FALSE, eval = TRUE}
table_simulated_single_assemblage_model_parameters <- data.table(single_assemblage_samples$summary(c("grand_theta", "grand_mu_immature", "grand_mu_female", "grand_mu_male", "grand_sigma_immature", "grand_sigma_female", "grand_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
parameter_names <- c("$\\theta_1$", "$\\theta_2$", "$\\theta_3$", "$\\mu_1$", "$\\mu_2$", "$\\mu_3$", "$\\sigma_1$", "$\\sigma_2$", "$\\sigma_3$")
single_assemblage_overall_name <- "Single Assemblage Model"
table_simulated_single_assemblage_model_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(single_assemblage_overall_name, x, sep = " ")))]
```

```{r make simulated assemblage posterior table, echo = FALSE}
kbl(table_simulated_single_assemblage_model_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Model Parameters (Single Assemblage Simulation)",
    booktabs = T, escape = FALSE, linesep = c('', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down")) %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, align = "c")
```

```{r simulated multisite posterior table, include = FALSE, eval = TRUE}
table_simulated_multisite_model_parameters <- data.table(multisite_samples$summary(c("grand_theta", "grand_mu_immature", "grand_mu_female", "grand_mu_male", "grand_sigma_immature", "grand_sigma_female", "grand_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
multisite_overall_name <- "Multisite Model"
table_simulated_multisite_model_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(multisite_overall_name, x, sep = " ")))]
#
table_simulated_multisite_site_parameters <- data.table(multisite_samples$summary(c("site_theta", "site_mu_immature", "site_mu_female", "site_mu_male", "site_sigma_immature", "site_sigma_female", "site_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
simulated_multisite_site_names <- sapply(1:15, function(x) paste0("Site ", x))
table_simulated_multisite_site_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(simulated_multisite_site_names, x, sep = " ")))]
```

```{r make simulated multisite posterior table, echo = FALSE}
kbl(table_simulated_multisite_model_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Model Parameters (Multisite Simulation)",
    booktabs = T, escape = FALSE, linesep = c('', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down")) %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, align = "c")
```

```{r make simulated multisite site-level table, echo = FALSE}
kbl(table_simulated_multisite_site_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Site-Level Model Parameters (Multisite Simulation)",
    booktabs = T, longtable = T, escape = FALSE, linesep = c('', '', '', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "repeat_header")) %>%
  column_spec(1, border_right = T) %>%
  column_spec(2:6, width = "4em") %>%
  column_spec(7, width = "2em") %>%
  column_spec(8:9, width = "4em")
```

\newpage

## Appendix 2 (Supplemental Table 7)

### *Posterior Summary Tables for Overall and Site-Level Model Parameters: Archaeological Case Studies*

```{r Pinarbasi B sheep posterior table, include = FALSE, eval = TRUE}
table_pinarbasi_model_parameters <- data.table(pinarbasi_samples$summary(c("grand_theta", "grand_mu_immature", "grand_mu_female", "grand_mu_male", "grand_sigma_immature", "grand_sigma_female", "grand_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
pinarbasi_overall_name <- "Pinarbaşı B Sheep"
table_pinarbasi_model_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(pinarbasi_overall_name, x, sep = " ")))]
```

```{r make Pinarbasi B table, echo = FALSE}
kbl(table_pinarbasi_model_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Model Parameters (Pinarbaşı B Sheep)",
    booktabs = T, escape = FALSE, linesep = c('', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down")) %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, align = "c")
```

```{r Northwest Anatolian cattle posterior table, include = FALSE, eval = TRUE}
table_nw_anatolian_model_parameters <- data.table(nw_anatolian_multisite_samples$summary(c("grand_theta", "grand_mu_immature", "grand_mu_female", "grand_mu_male", "grand_sigma_immature", "grand_sigma_female", "grand_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
nw_anatolian_overall_name <- "NW Anatolian Cattle"
table_nw_anatolian_model_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(nw_anatolian_overall_name, x, sep = " ")))]

#
table_nw_anatolian_site_parameters <- data.table(nw_anatolian_multisite_samples$summary(c("site_theta", "site_mu_immature", "site_mu_female", "site_mu_male", "site_sigma_immature", "site_sigma_female", "site_sigma_male")))[, .(`Posterior Mean` = round(mean, 2), `Posterior Median` = round(median, 2), `Posterior SD` = round(sd, 2), `$5\\%$ Quantile` = round(q5, 2), `$95\\%$ Quantile` = round(q95, 2), `$\\hat{R}$` = round(rhat, 2), `Effective Sample Size (Bulk)` = round(ess_bulk, 0), `Effective Sample Size (Tail)` = round(ess_tail, 0))]
nw_anatolian_site_names <- c("Barcın", "Neolithic Ilıpınar", "Menteşe", "Chalcolithic Ilıpınar")
table_nw_anatolian_site_parameters[, Parameter := c(sapply(parameter_names, function(x) paste(nw_anatolian_site_names, x, sep = " ")))]
```

```{r make Northwest Anatolian table, echo = FALSE}
kbl(table_nw_anatolian_model_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Model Parameters (Northwest Anatolian Cattle)",
    booktabs = T, escape = FALSE, linesep = c('', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down")) %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, align = "c")
```

```{r make Northwest Anatolian site-level table, echo = FALSE}
kbl(table_nw_anatolian_site_parameters[, .(Parameter, `Posterior Mean`, `Posterior Median`, `Posterior SD`, `$5\\%$ Quantile`, `$95\\%$ Quantile`, `$\\hat{R}$`, `Effective Sample Size (Bulk)`, `Effective Sample Size (Tail)`)],
    col.names = c("Parameter", "Posterior Mean", "Posterior Median", "Posterior SD", "$5\\%$ Quantile", "$95\\%$ Quantile", "$\\hat{R}$", "Effective Sample Size (Bulk)", "Effective Sample Size (Tail)"),
    caption = "Posterior Fit Summaries for Site-Level Model Parameters (Northwest Anatolian Cattle)",
    booktabs = T, escape = FALSE, linesep = c('', '', '', '\\addlinespace')) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down")) %>%
  column_spec(1, border_right = T) %>%
  row_spec(0, align = "c")
```

\newpage

## Appendix 3 (Supplemental Figures 1-4)

### *Traceplots of Posterior Distributions of Overall Model Parameters*

```{r simulated single assemblage traceplot, include = FALSE, eval = TRUE}
single_assemblage_theta1_plot <- traceplot(single_assemblage_stanfit, pars = "grand_theta[1]") + labs(title = expression(paste(theta[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_theta2_plot <- traceplot(single_assemblage_stanfit, pars = "grand_theta[2]") + labs(title = expression(paste(theta[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_theta3_plot <- traceplot(single_assemblage_stanfit, pars = "grand_theta[3]") + labs(title = expression(paste(theta[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_mu1_plot <- traceplot(single_assemblage_stanfit, pars = "grand_mu_immature") + labs(title = expression(paste(mu[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_mu2_plot <- traceplot(single_assemblage_stanfit, pars = "grand_mu_female") + labs(title = expression(paste(mu[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_mu3_plot <- traceplot(single_assemblage_stanfit, pars = "grand_mu_male") + labs(title = expression(paste(mu[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_sigma1_plot <- traceplot(single_assemblage_stanfit, pars = "grand_sigma_immature") + labs(title = expression(paste(sigma[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_sigma2_plot <- traceplot(single_assemblage_stanfit, pars = "grand_sigma_female") + labs(title = expression(paste(sigma[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
single_assemblage_sigma3_plot <- traceplot(single_assemblage_stanfit, pars = "grand_sigma_male") + labs(title = expression(paste(sigma[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
#
single_assemblage_trace_plot <- ggarrange(single_assemblage_theta1_plot, single_assemblage_theta2_plot, single_assemblage_theta3_plot, single_assemblage_mu1_plot, single_assemblage_mu2_plot, single_assemblage_mu3_plot, single_assemblage_sigma1_plot, single_assemblage_sigma2_plot, single_assemblage_sigma3_plot, common.legend = T, legend = "bottom")
#
figure_s1 <- annotate_figure(single_assemblage_trace_plot, top = text_grob("Single Assemblage Simulation", face = "bold", size = 14))
#
Cairo(width = 8, height = 8, units = "in", file = "./Output/Figures/figure_s1.png", type = "png", dpi = 600)
figure_s1
dev.off()
```

```{r simulated multisite traceplot, include = FALSE, eval = TRUE}
multisite_theta1_plot <- traceplot(multisite_stanfit, pars = "grand_theta[1]") + labs(title = expression(paste(theta[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_theta2_plot <- traceplot(multisite_stanfit, pars = "grand_theta[2]") + labs(title = expression(paste(theta[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_theta3_plot <- traceplot(multisite_stanfit, pars = "grand_theta[3]") + labs(title = expression(paste(theta[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_mu1_plot <- traceplot(multisite_stanfit, pars = "grand_mu_immature") + labs(title = expression(paste(mu[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_mu2_plot <- traceplot(multisite_stanfit, pars = "grand_mu_female") + labs(title = expression(paste(mu[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_mu3_plot <- traceplot(multisite_stanfit, pars = "grand_mu_male") + labs(title = expression(paste(mu[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_sigma1_plot <- traceplot(multisite_stanfit, pars = "grand_sigma_immature") + labs(title = expression(paste(sigma[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_sigma2_plot <- traceplot(multisite_stanfit, pars = "grand_sigma_female") + labs(title = expression(paste(sigma[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
multisite_sigma3_plot <- traceplot(multisite_stanfit, pars = "grand_sigma_male") + labs(title = expression(paste(sigma[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
#
multisite_assemblage_trace_plot <- ggarrange(multisite_theta1_plot, multisite_theta2_plot, multisite_theta3_plot, multisite_mu1_plot, multisite_mu2_plot, multisite_mu3_plot, multisite_sigma1_plot, multisite_sigma2_plot, multisite_sigma3_plot, common.legend = T, legend = "bottom")
#
figure_s2 <- annotate_figure(multisite_assemblage_trace_plot, top = text_grob("Multisite Simulation", face = "bold", size = 14))
#
Cairo(width = 8, height = 8, units = "in", file = "./Output/Figures/figure_s2.png", type = "png", dpi = 600)
figure_s2
dev.off()
```

```{r Pinarbasi B sheep traceplot, include = FALSE, eval = TRUE}
pinarbasi_theta1_plot <- traceplot(pinarbasi_stanfit, pars = "grand_theta[1]") + labs(title = expression(paste(theta[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_theta2_plot <- traceplot(pinarbasi_stanfit, pars = "grand_theta[2]") + labs(title = expression(paste(theta[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_theta3_plot <- traceplot(pinarbasi_stanfit, pars = "grand_theta[3]") + labs(title = expression(paste(theta[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_mu1_plot <- traceplot(pinarbasi_stanfit, pars = "grand_mu_immature") + labs(title = expression(paste(mu[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_mu2_plot <- traceplot(pinarbasi_stanfit, pars = "grand_mu_female") + labs(title = expression(paste(mu[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_mu3_plot <- traceplot(pinarbasi_stanfit, pars = "grand_mu_male") + labs(title = expression(paste(mu[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_sigma1_plot <- traceplot(pinarbasi_stanfit, pars = "grand_sigma_immature") + labs(title = expression(paste(sigma[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_sigma2_plot <- traceplot(pinarbasi_stanfit, pars = "grand_sigma_female") + labs(title = expression(paste(sigma[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
pinarbasi_sigma3_plot <- traceplot(pinarbasi_stanfit, pars = "grand_sigma_male") + labs(title = expression(paste(sigma[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
#
pinarbasi_trace_plot <- ggarrange(pinarbasi_theta1_plot, pinarbasi_theta2_plot, pinarbasi_theta3_plot, pinarbasi_mu1_plot, pinarbasi_mu2_plot, pinarbasi_mu3_plot, pinarbasi_sigma1_plot, pinarbasi_sigma2_plot, pinarbasi_sigma3_plot, common.legend = T, legend = "bottom")
#
figure_s3 <- annotate_figure(pinarbasi_trace_plot, top = text_grob("Pinarbaşı B Sheep", face = "bold", size = 14))
#
Cairo(width = 8, height = 8, units = "in", file = "./Output/Figures/figure_s3.png", type = "png", dpi = 600)
figure_s3
dev.off()
```

```{r Northwest Anatolian cattle traceplot, include = FALSE, eval = TRUE}
nw_anatolian_theta1_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_theta[1]") + labs(title = expression(paste(theta[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_theta2_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_theta[2]") + labs(title = expression(paste(theta[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_theta3_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_theta[3]") + labs(title = expression(paste(theta[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_mu1_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_mu_immature") + labs(title = expression(paste(mu[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_mu2_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_mu_female") + labs(title = expression(paste(mu[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_mu3_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_mu_male") + labs(title = expression(paste(mu[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_sigma1_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_sigma_immature") + labs(title = expression(paste(sigma[1])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_sigma2_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_sigma_female") + labs(title = expression(paste(sigma[2])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
nw_anatolian_sigma3_plot <- traceplot(nw_anatolian_multisite_stanfit, pars = "grand_sigma_male") + labs(title = expression(paste(sigma[3])), y = element_blank()) + theme(plot.title = element_text(hjust = 0.5))
#
nw_anatolian_trace_plot <- ggarrange(nw_anatolian_theta1_plot, nw_anatolian_theta2_plot, nw_anatolian_theta3_plot, nw_anatolian_mu1_plot, nw_anatolian_mu2_plot, nw_anatolian_mu3_plot, nw_anatolian_sigma1_plot, nw_anatolian_sigma2_plot, nw_anatolian_sigma3_plot, common.legend = T, legend = "bottom")
#
figure_s4 <- annotate_figure(nw_anatolian_trace_plot, top = text_grob("Northwest Anatolian Cattle", face = "bold", size = 14))
#
Cairo(width = 8, height = 8, units = "in", file = "./Output/Figures/figure_s4.png", type = "png", dpi = 600)
figure_s4
dev.off()
```

```{r figure_single_assemblage_simulation_trace, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Traceplots of Model Parameters (Single Assemblage Simulation)"}
knitr::include_graphics("./Output/Figures/figure_s1.png")
```

```{r figure_multisite_simulation_trace, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Traceplots of Model Parameters (Multisite Simulation)"}
knitr::include_graphics("./Output/Figures/figure_s2.png")
```

```{r figure_pinarbasi_trace, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Traceplots of Model Parameters (Pinarbaşı B Sheep)"}
knitr::include_graphics("./Output/Figures/figure_s3.png")
```

```{r figure_nw_anatolian_trace, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Traceplots of Model Parameters (Northwest Anatolian Cattle)"}
knitr::include_graphics("./Output/Figures/figure_s4.png")
```

\newpage

## Appendix 4 (Supplemental Figures 5-7)

### *Prior-Posterior Comparisons for Model Hyper-Parameters*\

```{r making figure S5 (multisite prior-posterior comparison), include = FALSE, eval = TRUE}
#Figure S5: prior and posterior comparison of multisite simulation hyper-parameters
#Collect the prior and posterior estimates
multisite_p_immature_prior_samples <- boot::inv.logit(rnorm(4000, -0.5, 1.5) + log(0.5))
multisite_p_immature_posterior_samples <- multisite_post$p_immature
multisite_p_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_p_immature_prior_samples, multisite_p_immature_posterior_samples))
#
multisite_sex_ratio_prior_samples <- boot::inv.logit(rnorm(4000, 0, 1.5))
multisite_sex_ratio_posterior_samples <- multisite_post$theta_female
multisite_sex_ratio_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_sex_ratio_prior_samples, multisite_sex_ratio_posterior_samples))
#
multisite_mu_female_prior_samples <- rnorm(4000, 0, 0.2)
multisite_mu_female_posterior_samples <- multisite_post$grand_mu_female
multisite_mu_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_mu_female_prior_samples, multisite_mu_female_posterior_samples))
#
multisite_delta_immature_prior_samples <- exp(rnorm(4000, -3.5, 0.5))
multisite_delta_immature_posterior_samples <- multisite_post$grand_mu_female - multisite_post$grand_mu_immature
multisite_delta_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_delta_immature_prior_samples, multisite_delta_immature_posterior_samples))
#
multisite_delta_male_prior_samples <- exp(rnorm(4000, -2.7, 0.5))
multisite_delta_male_posterior_samples <- multisite_post$grand_mu_male - multisite_post$grand_mu_female
multisite_delta_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_delta_male_prior_samples, multisite_delta_male_posterior_samples))
#
multisite_sigma_immature_prior_samples <- exp(rnorm(4000, -3.05, 0.25))
multisite_sigma_immature_posterior_samples <- multisite_post$grand_sigma_immature
multisite_sigma_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_sigma_immature_prior_samples, multisite_sigma_immature_posterior_samples))
#
multisite_sigma_female_prior_samples <- exp(rnorm(4000, -3.1, 0.2))
multisite_sigma_female_posterior_samples <- multisite_post$grand_sigma_female
multisite_sigma_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_sigma_female_prior_samples, multisite_sigma_female_posterior_samples))
#
multisite_sigma_male_prior_samples <- exp(rnorm(4000, -3.1, 0.2))
multisite_sigma_male_posterior_samples <- multisite_post$grand_sigma_male
multisite_sigma_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(multisite_sigma_male_prior_samples, multisite_sigma_male_posterior_samples))

#make the plots
multisite_p_immature_plot <-
  ggplot(multisite_p_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Proportion Immature, ", pi[1])), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_sex_ratio_plot <-
  ggplot(multisite_sex_ratio_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_mu_female_plot <-
  ggplot(multisite_mu_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Average Female LSI, ", mu[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_delta_immature_plot <-
  ggplot(multisite_delta_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Size Penalty, ", delta[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_delta_male_plot <-
  ggplot(multisite_delta_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism, ", delta[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_sigma_immature_plot <-
  ggplot(multisite_sigma_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Variability, ", sigma[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_sigma_female_plot <-
  ggplot(multisite_sigma_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Female Variability, ", sigma[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
multisite_sigma_male_plot <-
  ggplot(multisite_sigma_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Male Variability, ", sigma[3])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
figure_multisite_prior_posterior <- ggarrange(
  multisite_p_immature_plot, multisite_sex_ratio_plot,
  multisite_mu_female_plot, multisite_delta_immature_plot,
  multisite_delta_male_plot, multisite_sigma_immature_plot,
  multisite_sigma_female_plot, multisite_sigma_male_plot,
  ncol = 2, nrow = 4,
  common.legend = T, legend = "bottom")
#
figure_s5 <- annotate_figure(figure_multisite_prior_posterior, top = text_grob("Multisite Simulation", face = "bold", size = 14))
#
Cairo(width = 8, height = 10, units = "in", file = "./Output/Figures/figure_s5.png", type = "png", dpi = 600)
figure_s5
dev.off()
```

```{r making figure S6 (Pinarbasi prior-posterior comparison), include = FALSE, eval = TRUE}
#Figure 5: prior and posterior comparison of Pinarbasi Sheep model hyper-parameters
#Collect the prior and posterior estimates
pinarbasi_p_immature_prior_samples <- boot::inv.logit(rnorm(4000, -0.5, 1.5) + log(0.5))
pinarbasi_p_immature_posterior_samples <- pinarbasi_post$p_immature
pinarbasi_p_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_p_immature_prior_samples, pinarbasi_p_immature_posterior_samples))
#
pinarbasi_sex_ratio_prior_samples <- boot::inv.logit(rnorm(4000, 0, 1.5))
pinarbasi_sex_ratio_posterior_samples <- pinarbasi_post$theta_female
pinarbasi_sex_ratio_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_sex_ratio_prior_samples, pinarbasi_sex_ratio_posterior_samples))
#
pinarbasi_mu_female_prior_samples <- rnorm(4000, 0, 0.1)
pinarbasi_mu_female_posterior_samples <- pinarbasi_post$grand_mu_female
pinarbasi_mu_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_mu_female_prior_samples, pinarbasi_mu_female_posterior_samples))
#
pinarbasi_delta_immature_prior_samples <- exp(rnorm(4000, -3.5, 0.4))
pinarbasi_delta_immature_posterior_samples <- pinarbasi_post$grand_mu_female - pinarbasi_post$grand_mu_immature
pinarbasi_delta_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_delta_immature_prior_samples, pinarbasi_delta_immature_posterior_samples))
#
pinarbasi_delta_male_prior_samples <- exp(rnorm(4000, -2.7, 0.1))
pinarbasi_delta_male_posterior_samples <- pinarbasi_post$grand_mu_male - pinarbasi_post$grand_mu_female
pinarbasi_delta_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_delta_male_prior_samples, pinarbasi_delta_male_posterior_samples))
#
pinarbasi_sigma_immature_prior_samples <- exp(rnorm(4000, -3.05, 0.1))
pinarbasi_sigma_immature_posterior_samples <- pinarbasi_post$grand_sigma_immature
pinarbasi_sigma_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_sigma_immature_prior_samples, pinarbasi_sigma_immature_posterior_samples))
#
pinarbasi_sigma_female_prior_samples <- exp(rnorm(4000, -3.1, 0.1))
pinarbasi_sigma_female_posterior_samples <- pinarbasi_post$grand_sigma_female
pinarbasi_sigma_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_sigma_female_prior_samples, pinarbasi_sigma_female_posterior_samples))
#
pinarbasi_sigma_male_prior_samples <- exp(rnorm(4000, -3.1, 0.1))
pinarbasi_sigma_male_posterior_samples <- pinarbasi_post$grand_sigma_male
pinarbasi_sigma_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(pinarbasi_sigma_male_prior_samples, pinarbasi_sigma_male_posterior_samples))

#make the plots
pinarbasi_p_immature_plot <-
  ggplot(pinarbasi_p_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Proportion Immature, ", pi[1])), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_sex_ratio_plot <-
  ggplot(pinarbasi_sex_ratio_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_mu_female_plot <-
  ggplot(pinarbasi_mu_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Average Female LSI, ", mu[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_delta_immature_plot <-
  ggplot(pinarbasi_delta_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Size Penalty, ", delta[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_delta_male_plot <-
  ggplot(pinarbasi_delta_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism, ", delta[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_sigma_immature_plot <-
  ggplot(pinarbasi_sigma_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Variability, ", sigma[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_sigma_female_plot <-
  ggplot(pinarbasi_sigma_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Female Variability, ", sigma[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
pinarbasi_sigma_male_plot <-
  ggplot(pinarbasi_sigma_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Male Variability, ", sigma[3])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
figure_pinarbasi_prior_posterior <- ggarrange(
  pinarbasi_p_immature_plot, pinarbasi_sex_ratio_plot,
  pinarbasi_mu_female_plot, pinarbasi_delta_immature_plot,
  pinarbasi_delta_male_plot, pinarbasi_sigma_immature_plot,
  pinarbasi_sigma_female_plot, pinarbasi_sigma_male_plot,
  ncol = 2, nrow = 4,
  common.legend = T, legend = "bottom")
#
figure_s6 <- annotate_figure(figure_pinarbasi_prior_posterior, top = text_grob("Pinarbaşı B Sheep", face = "bold", size = 14))
#
Cairo(width = 8, height = 10, units = "in", file = "./Output/Figures/figure_s6.png", type = "png", dpi = 600)
figure_s6
dev.off()
```

```{r making figure S7 (NW Anatolian prior-posterior comparison), include = FALSE, eval = TRUE}
#Figure S5: prior and posterior comparison of NW Anatolian cattle model hyper-parameters
#Collect the prior and posterior estimates
nw_anatolian_p_immature_prior_samples <- boot::inv.logit(rnorm(4000, -0.5, 1.5) + log(0.5))
nw_anatolian_p_immature_posterior_samples <- nw_anatolian_post$p_immature
nw_anatolian_p_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_p_immature_prior_samples, nw_anatolian_p_immature_posterior_samples))
#
nw_anatolian_sex_ratio_prior_samples <- boot::inv.logit(rnorm(4000, 0, 1.5))
nw_anatolian_sex_ratio_posterior_samples <- nw_anatolian_post$theta_female
nw_anatolian_sex_ratio_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_sex_ratio_prior_samples, nw_anatolian_sex_ratio_posterior_samples))
#
nw_anatolian_mu_female_prior_samples <- rnorm(4000, -0.1, 0.1)
nw_anatolian_mu_female_posterior_samples <- nw_anatolian_post$grand_mu_female
nw_anatolian_mu_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_mu_female_prior_samples, nw_anatolian_mu_female_posterior_samples))
#
nw_anatolian_delta_immature_prior_samples <- exp(rnorm(4000, -3.5, 0.5))
nw_anatolian_delta_immature_posterior_samples <- nw_anatolian_post$grand_mu_female - nw_anatolian_post$grand_mu_immature
nw_anatolian_delta_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_delta_immature_prior_samples, nw_anatolian_delta_immature_posterior_samples))
#
nw_anatolian_delta_male_prior_samples <- exp(rnorm(4000, -2, 0.5))
nw_anatolian_delta_male_posterior_samples <- nw_anatolian_post$grand_mu_male - nw_anatolian_post$grand_mu_female
nw_anatolian_delta_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_delta_male_prior_samples, nw_anatolian_delta_male_posterior_samples))
#
nw_anatolian_sigma_immature_prior_samples <- exp(rnorm(4000, -3.05, 0.25))
nw_anatolian_sigma_immature_posterior_samples <- nw_anatolian_post$grand_sigma_immature
nw_anatolian_sigma_immature_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_sigma_immature_prior_samples, nw_anatolian_sigma_immature_posterior_samples))
#
nw_anatolian_sigma_female_prior_samples <- exp(rnorm(4000, -3.1, 0.2))
nw_anatolian_sigma_female_posterior_samples <- nw_anatolian_post$grand_sigma_female
nw_anatolian_sigma_female_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_sigma_female_prior_samples, nw_anatolian_sigma_female_posterior_samples))
#
nw_anatolian_sigma_male_prior_samples <- exp(rnorm(4000, -3.1, 0.2))
nw_anatolian_sigma_male_posterior_samples <- nw_anatolian_post$grand_sigma_male
nw_anatolian_sigma_male_priorposterior_data <- data.table(quantity = rep(c("Prior", "Posterior"), each = 4000), value = c(nw_anatolian_sigma_male_prior_samples, nw_anatolian_sigma_male_posterior_samples))

#make the plots
nw_anatolian_p_immature_plot <-
  ggplot(nw_anatolian_p_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Proportion Immature, ", pi[1])), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_sex_ratio_plot <-
  ggplot(nw_anatolian_sex_ratio_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Adult Sex Ratio, ", frac(pi[2], pi[2] + pi[3]))), x = "Proportion", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_mu_female_plot <-
  ggplot(nw_anatolian_mu_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Average Female LSI, ", mu[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_delta_immature_plot <-
  ggplot(nw_anatolian_delta_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Size Penalty, ", delta[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_delta_male_plot <-
  ggplot(nw_anatolian_delta_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Index of Sexual Dimorphism, ", delta[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_sigma_immature_plot <-
  ggplot(nw_anatolian_sigma_immature_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Immature Variability, ", sigma[1])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_sigma_female_plot <-
  ggplot(nw_anatolian_sigma_female_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Female Variability, ", sigma[2])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
nw_anatolian_sigma_male_plot <-
  ggplot(nw_anatolian_sigma_male_priorposterior_data) + aes(x = value, y = quantity) +
  stat_slab(normalize = "groups", aes(fill = quantity, fill_ramp = stat(cut_cdf_qi(cdf, .width = c(1, 0.95, 0.80), labels = scales::percent_format())))) +
  stat_pointinterval(.width = c(0.8, 0.95), aes(color = quantity), position = position_dodge(width = 0.2, preserve = "single")) +
  scale_fill_ramp_discrete(name = "Interval", range = c(0.7, 0.2), na.translate = F) +
  scale_color_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_fill_manual(name = "", values = c("red", "black"), na.translate = F) +
  scale_y_discrete(limits = c("Prior", "Posterior")) +
  labs(subtitle = expression(paste("Male Variability, ", sigma[3])), x = "LSI Value", y = "") +
  theme_classic() + theme(plot.title = element_text(size = 14), legend.text = element_text(size = 10), legend.position = "bottom", legend.justification = c("center"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6), axis.text.x = element_text(size = 10), axis.title = element_text(size = 14), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#
figure_nw_anatolian_prior_posterior <- ggarrange(
  nw_anatolian_p_immature_plot, nw_anatolian_sex_ratio_plot,
  nw_anatolian_mu_female_plot, nw_anatolian_delta_immature_plot,
  nw_anatolian_delta_male_plot, nw_anatolian_sigma_immature_plot,
  nw_anatolian_sigma_female_plot, nw_anatolian_sigma_male_plot,
  ncol = 2, nrow = 4,
  common.legend = T, legend = "bottom")
#
figure_s7 <- annotate_figure(figure_nw_anatolian_prior_posterior, top = text_grob("Northwest Anatolian Cattle", face = "bold", size = 14))
#
Cairo(width = 8, height = 10, units = "in", file = "./Output/Figures/figure_s7.png", type = "png", dpi = 600)
figure_s7
dev.off()
```


```{r figure_multisite_prior_posterior, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Prior-Posterior Comparison of Multisite Simulation Model Hyper-Parameters"}
knitr::include_graphics("./Output/Figures/figure_s5.png")
```

```{r figure_pinarbasi_prior_posterior, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Prior-Posterior Comparison of Pinarbaşı B Sheep Model Hyper-Parameters"}
knitr::include_graphics("./Output/Figures/figure_s6.png")
```

```{r figure_nw_anatolian_prior_posterior, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", out.width = "\\textwidth", fig.cap = "Prior-Posterior Comparison of NW Anatolian Cattle Model Hyper-Parameters"}
knitr::include_graphics("./Output/Figures/figure_s7.png")
```